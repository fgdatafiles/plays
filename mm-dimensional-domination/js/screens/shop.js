var game=game||{};game.screens=game.screens||{};(function(){'use strict';function Shop(){WONBATS.Screen.call(this);}
Shop.prototype=Object.create(WONBATS.Screen.prototype);Shop.prototype.constructor=Shop;Shop.prototype.enter=function(name,previousSword){WONBATS.Screen.prototype.enter.call(this,name);this.view=new WONBATS.MovieClip(shop,"shop");this.asset.addChild(this.view);this.view.update(0);this.addButton("accept",this.view.getChildByName("aceptBtn"),this.onAccept.bind(this));this.addButton("down",this.view.getChildByName("downBtn"),this.onDown.bind(this),"btn_down_wood");this.addButton("up",this.view.getChildByName("upBtn"),this.onUp.bind(this),"btn_down_wood");this.addButton("credits",this.view.getChildByName("wonby"),this.onCredits.bind(this));globalsignal.add(this.onGlobalSignal.bind(this));this.previousSword=previousSword;this.scroll={};this.scroll.position=[0,0,0];this.scroll.moving=false;this.scrollRect=new PIXI.Graphics();this.scrollRect.beginFill(0xffff00,0);this.scrollRect.drawRect(5,5,400,440);this.scrollRect.endFill();this.scrollRect.cacheAsBitmap=true;this.scrollRect.interactive=false;this.scrollRect.buttonMode=true;this.scrollRect.x=0;this.scrollRect.y=0;this.scrollRect.mousedown=this.onScrollDown.bind(this);this.scrollRect.mouseup=this.onScrollUp.bind(this);this.scrollRect.mousemove=this.onScrollMove.bind(this);this.scrollRect.mouseout=this.onScrollUp.bind(this);this.scrollRect.touchstart=this.onScrollDown.bind(this);this.scrollRect.touchend=this.onScrollUp.bind(this);this.scrollRect.touchmove=this.onScrollMove.bind(this);this.scrollRect.touchout=this.onScrollUp.bind(this);this.asset.addChild(this.scrollRect);this.carpet=[this.view.getChildByName("carpet1"),this.view.getChildByName("carpet2"),this.view.getChildByName("carpet3"),this.view.getChildByName("carpet4"),this.view.getChildByName("carpet5"),this.view.getChildByName("carpet6")];this.nextPosition=0;this.actualPosition=0;this.swordContainers=[this.carpet[0].getChildByName("sword1"),this.carpet[0].getChildByName("sword2"),this.carpet[1].getChildByName("sword1"),this.carpet[1].getChildByName("sword2"),this.carpet[1].getChildByName("sword3"),this.carpet[2].getChildByName("sword1"),this.carpet[2].getChildByName("sword2"),this.carpet[2].getChildByName("sword3"),this.carpet[3].getChildByName("sword1"),this.carpet[3].getChildByName("sword2"),this.carpet[3].getChildByName("sword3"),this.carpet[4].getChildByName("sword1"),this.carpet[4].getChildByName("sword2"),this.carpet[4].getChildByName("sword3"),this.carpet[5].getChildByName("sword1"),this.carpet[5].getChildByName("sword2")];this.carpetsHeight=2100;this.maxScroll=-this.carpetsHeight;this.lockDistance=this.swordContainers[0].y-this.swordContainers[1].y;this.selectedSword=0;this.unlockedSwords=JSON.parse(localStorage.getItem("progress"))[0];this.mcs=[];this.previousSwordLocked=false;var swordsToRemove=[];for(var i=0;i<this.swordContainers.length;i++){this.swordContainers[i].gotoAndPlay("unfocus");if(swords.list[i]){if(previousSword&&(swords.list[previousSword].sword.components.Sword[0]===swords.list[i].sword.components.Sword[0])){this.previousSword=i;}
var container=this.swordContainers[i].getChildByName("sword");var swordAsset=new WONBATS.MovieClip(swords,"sword");swordAsset.gotoAndStop(swords.list[i].sword.components.Sword[0]);if(!this.isSwordUnlocked(i)){container.addChild(swordAsset);container.scale.x=1;container.scale.y=1;swordAsset.x+=100;swordAsset.y+=150;swordAsset.tint=0x000000;swordAsset.update(0);var texture=new PIXI.RenderTexture.create(400,400);game.renderer.render(container,texture);var sprite=new PIXI.Sprite(texture);container.addChild(sprite);sprite.alpha=0.5;sprite.x-=100;sprite.y-=150;swordAsset.x=0;swordAsset.y=0;container.removeChild(swordAsset);}else{container.addChild(swordAsset);this.mcs.push(swordAsset);}}else{this.swordContainers[i].parent.removeChild(this.swordContainers[i]);swordsToRemove.push(this.swordContainers[i]);}}
for(var i=0;i<swordsToRemove.length;i++){var index=this.swordContainers.indexOf(swordsToRemove[i]);this.swordContainers.splice(index,1);}
this.balloon=this.view.getChildByName("ralphio").getChildByName("balloon");this.balloon.gotoAndStop("disabled");console.log("previousSword: "+this.previousSword);if(!this.previousSword){this.previousSword=this.unlockedSwords-1;}
this.selectedSword=this.previousSword;this.setNextPosition();this.navigationKeys={"38":{pressed:false,button:this.buttons["up"]},"40":{pressed:false,button:this.buttons["down"]},"13":{pressed:false,button:this.buttons["accept"]}}
this.enableKeyboard(true);this.enableInput(false);this.view.gotoAndPlay("in");var music_foreground=game.soundManager.getSound("music_foreground");var music_background=game.soundManager.getSound("music_background");if(!music_foreground){game.soundManager.play("music_foreground");music_foreground=game.soundManager.getSound("music_foreground");music_foreground.volume=0;}else{game.soundManager.fadeVolume("music_foreground",1000,0);}
if(!music_background){game.soundManager.play("music_background");}
game.soundManager.fadeVolume("music_background",1000,0,true);this.toCredits=false;};Shop.prototype.onKeyDown=function(e){WONBATS.Screen.prototype.onKeyDown.call(this,e);if(this.navigationKeys[e.keyCode]&&!this.navigationKeys[e.keyCode].pressed){this.navigationKeys[e.keyCode].pressed=true;if(!this.isSwordUnlocked(this.selectedSword)&&e.keyCode===13){return;}
this.navigationKeys[e.keyCode].button.target.mousedown.call(this.navigationKeys[e.keyCode].button);this.navigationKeys[e.keyCode].button.target.mouseup.call(this.navigationKeys[e.keyCode].button);}};Shop.prototype.onKeyUp=function(e){WONBATS.Screen.prototype.onKeyUp.call(this,e);if(this.navigationKeys[e.keyCode]&&this.navigationKeys[e.keyCode].pressed){this.navigationKeys[e.keyCode].pressed=false;}};Shop.prototype.onUp=function(){this.selectedSword=Math.clamp(this.selectedSword-1,0,this.swordContainers.length-1);this.setNextPosition();};Shop.prototype.onDown=function(){this.selectedSword=Math.clamp(this.selectedSword+1,0,this.swordContainers.length-1);this.setNextPosition();};Shop.prototype.onAccept=function(clickSound){if(this.isSwordUnlocked(this.selectedSword)){this.enableInput(false);this.scrollRect.interactive=false;this.view.gotoAndPlay("out");if(clickSound){game.soundManager.playSfx("btn_click");}}};Shop.prototype.onScrollDown=function(e){this.scroll.moving=true;this.scroll.position[0]=this.carpet[0].y;this.scroll.position[1]=e.data.global.y;};Shop.prototype.onScrollUp=function(e){if(this.scroll.moving){this.scroll.moving=false;var selectedSword=Math.round(this.carpet[0].y/this.lockDistance);this.selectedSword=Math.clamp(selectedSword,0,this.swordContainers.length-1);if(e.data.global.y===this.scroll.position[1]){this.onAccept(true);}
this.scroll.position[0]=0;this.scroll.position[1]=0;this.scroll.position[2]=0;this.setNextPosition();this.actualPosition=this.carpet[0].y;}};Shop.prototype.onScrollMove=function(e){if(this.scroll.moving){this.scroll.position[2]=e.data.global.y;var diff=(this.scroll.position[2]-this.scroll.position[1]);this.carpet[0].y=this.scroll.position[0]+diff;this.carpet[0].y=Math.clamp(this.carpet[0].y,this.maxScroll,0);}};Shop.prototype.setNextPosition=function(){this.nextPosition=this.selectedSword*this.lockDistance;for(var i=0;i<this.swordContainers.length;i++){if(this.selectedSword===i){if(!this.swordContainers[i].focus){this.swordContainers[i].focus=true;this.swordContainers[i].gotoAndPlay("focus");}
if(this.isSwordUnlocked(this.selectedSword)){console.log("previousSwordLocked: "+this.previousSwordLocked);if(this.previousSwordLocked){this.buttons["accept"].setEnable(true);this.buttons["accept"].target.gotoAndPlay("enabled");this.previousSwordLocked=false;}}else{if(!this.previousSwordLocked){this.buttons["accept"].setEnable(false);this.buttons["accept"].target.gotoAndPlay("disabled");this.previousSwordLocked=true;}}}else{if(this.swordContainers[i].focus){this.swordContainers[i].focus=false;this.swordContainers[i].gotoAndPlay("unfocus");}}}};Shop.prototype.update=function(dt){this.view.update(dt);for(var m=0;m<this.mcs.length;m++){this.mcs[m].update(dt);}
if(!this.scroll.moving){if(Math.abs(this.actualPosition-this.nextPosition)>1){this.actualPosition+=((this.nextPosition-this.actualPosition)*10)*dt;}else if(this.actualPosition!==this.nextPosition){this.actualPosition=this.nextPosition;}
this.carpet[0].y=this.actualPosition;}
for(var i=0;i<this.carpet.length;i++){if(i===0){this.carpet[0].y=Math.clamp(this.carpet[0].y,-this.carpetsHeight,0);}else{this.carpet[i].y=this.carpet[i-1].y+450;}}};Shop.prototype.onGlobalSignal=function(message){if(message==="out"){if(this.toCredits){this.transitionSignal.emit(this.name,"credits",this.name);}else{this.transitionSignal.emit(this.name,"exit",JSON.parse(JSON.stringify(this.selectedSword)),waves.TUTORIAL_1);}}
if(message==="in"){this.enableInput(true);this.scrollRect.interactive=true;}};Shop.prototype.isSwordUnlocked=function(swordIndex){return(swordIndex<this.unlockedSwords);};Shop.prototype.onCredits=function(){this.enableInput(false);this.view.gotoAndPlay("out");this.toCredits=true;};Shop.prototype.exit=function(name){globalsignal.clear();this.mcs.length=0;this.mcs=null;this.swordContainers.length=0;this.swordContainers=null;this.view=null;this.scrollRect.cacheAsBitmap=false;this.scrollRect=null;this.scroll=null;this.navigationKeys=null;WONBATS.Screen.prototype.exit.call(this,name);};game.screens.Shop=Shop;}());