function FindMe(_managers){this.managers=_managers;this.list=null;this.listOrder=null;this.ready=false;this.isTweening=true;this.panel=null;this.choices=null;this.matchingChoice=null;this.region=null;this.hovered=null;this.hoverScale=null;this.glowStar=null;this.itemChosen=null;this.chosenChoice=null;this.fonts=null;this.orText=null;this.textSprite=null;this.findOnePanel=null;this.delayAppear=0;this.flashTimer=0}FindMe.prototype.create=function(_list,_scattered,_choices,_prevChoices){var _that=this;this.list=Utils.pickRandomsFromList(_list,_scattered);this.arrangedYet=false;this.hovered=null;this.hoverScale=null;this.glowStar=null;this.itemChosen=null;this.chosenChoice=null;this.delayAppear=0;this.flashTimer=0;this.fonts=this.managers.data.get("fonts");var chosen=Utils.pickRandomsFromList(_list,_choices-1,this.list);this.matchingChoice=Utils.pickRandomFromList(this.list);chosen.push(this.matchingChoice);Utils.shuffleList(chosen);this.shuffleListOrder(Game.smallestScale,Game.largestScale);this.showChoices(chosen);if(_choices!=_prevChoices){this.orText=this.managers.textures.get("findOne");if(!this.orText){var text=new CanvasText(Main.app.view);text.create(0,0,this.fonts["findOne"][Main.languageCode],80,this.fonts["font0"][Main.languageCode],"white","center");text.convertTextToTexture("findOne");this.orText=text}this.findOnePanel=new Sprite(.5,.5);this.findOnePanel.create(Main.leftTopUI,"gameOverPanel",this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.findOnePanel.scale.set(1.3,1.3);this.textSprite=new Sprite(.5,.5);this.textSprite.create(this.findOnePanel,"findOne",this.managers.textures,0,0);while(this.textSprite.width>this.findOnePanel.width*.8)this.textSprite.scale.set(this.textSprite.scale.x-.1,this.textSprite.scale.x-.1);this.findOnePanel.addChild(this.textSprite);this.flashChoices();this.findOnePanel.tween=new TWEEN.Tween(this.findOnePanel).delay(100).to({y:Main.height*5/8/Main.leftTopUI.scale.y},800).easing(TWEEN.Easing.Back.Out).start(Main.time).onComplete(function(){_that.findOnePanel.tween=new TWEEN.Tween(_that.findOnePanel).delay(2500).to({y:-190},500).easing(TWEEN.Easing.Quadratic.In).start(Main.time).onComplete(function(){_that.findOnePanel.destroy();_that.findOnePanel=null;_that.unflashChoices()})})}else{this.orText=null}this.ready=false;this.isTweening=true};FindMe.prototype.destroy=function(){this.ready=false;if(this.list){for(var i=0,il=this.list.length;i<il;i++){this.list[i].visible=false}}this.list=null;if(this.choices){for(var i=0,il=this.choices.length;i<il;i++){this.choices[i].destroy();this.choices[i]=null}}this.choices=null;this.matchingChoice=null;if(this.findOnePanel)this.findOnePanel.destroy();this.findOnePanel=null;if(this.textSprite)this.textSprite.destroy();this.textSprite=null;if(this.panel)this.panel.destroy();this.panel=null;if(this.glowStar)this.glowStar.destroy();this.glowStar=null;this.orText=null;this.itemChosen=null;this.chosenChoice=null;this.hovered=null;this.hoverScale=null;this.region=null;this.listOrder=null;this.managers=null};FindMe.prototype.hidePieces=function(){for(var i=0,il=this.list.length;i<il;i++){var sprite=this.list[i];sprite.alpha=0}};FindMe.prototype.update=function(_mode){if(this.delayAppear){this.flashChoices();if(Main.mouseUpEvent){if(this.findOnePanel.tween){var _that=this;this.findOnePanel.tween.stop();this.findOnePanel.tween=new TWEEN.Tween(this.findOnePanel).to({y:-190},500).easing(TWEEN.Easing.Quadratic.In).start(Main.time).onComplete(function(){_that.findOnePanel.destroy();_that.findOnePanel=null;_that.unflashChoices()});var l=this.list.length;for(var i=0;i<l;i++){var sprite=this.list[i];if(sprite.tween){sprite.tween.stop();(function(sprite){sprite.tween=new TWEEN.Tween(sprite).delay(250+i*30).start(Main.time).onComplete(function(){sprite.visible=true;sprite.tween=new TWEEN.Tween(sprite.scale).to({x:sprite.finalScale,y:sprite.finalScale},750).easing(TWEEN.Easing.Elastic.Out).start(Main.time)})})(sprite)}}}Main.mouseUpEvent=Main.mouseUp=Main.mouseDown=null;this.delayAppear=0}}if(this.ready){this.isTweening=this.findOnePanel?this.findOnePanel.tween.isPlaying():false;for(var i=0,il=this.list.length;i<il;i++){var sprite=this.list[i];sprite.alpha=1;this.isTweening|=sprite.tween&&sprite.tween.isPlaying();{if(sprite.rotation==0)sprite.rotation=Math.random()*Math.PI*2;if(_mode&Game.Modes.ROTATE_CW)sprite.rotationSpeed=1;if(_mode&Game.Modes.ROTATE_CCW)sprite.rotationSpeed=-1;if(_mode&Game.Modes.ROTATE_RND_DIR)if(!sprite.rotationSpeed)sprite.rotationSpeed=Math.random()<.5?-1:1;if(_mode&Game.Modes.ROTATE_RND_SPD)if(sprite.rotationSpeed==1||sprite.rotationSpeed==-1)sprite.rotationSpeed*=.5+Math.random();if(_mode&Game.Modes.MOVE_ELASTIC){if(sprite.vx===undefined){if(_mode&Game.Modes.MOVE_RND_SPD){sprite.vx=Math.random()*4-2;sprite.vy=Math.random()*4-2;sprite.x+=Math.random()*12-6;sprite.y+=Math.random()*12-6}else{var a=Math.random()*2*Math.PI;sprite.vx=1.5*Math.cos(a);sprite.vy=1.5*Math.sin(a);sprite.x-=Math.random()*12-6;sprite.y+=Math.random()*12-6}}sprite.x+=sprite.vx;sprite.y+=sprite.vy;var dx=sprite.startX-sprite.x;var dy=sprite.startY-sprite.y;var d=Math.sqrt(dx*dx+dy*dy);sprite.vx+=2*Main.elapsedTime/1e3*dx/d;sprite.vy+=2*Main.elapsedTime/1e3*dy/d}if(_mode&Game.Modes.MOVE_BOUNCE){if(sprite.vx===undefined){if(_mode&Game.Modes.MOVE_RND_SPD){sprite.vx=Math.random()*4-2;sprite.vy=Math.random()*4-2}else{sprite.vx=Math.random()*.5+1.5;sprite.vy=Math.random()*.5+1.5}}sprite.x+=sprite.vx;sprite.y+=sprite.vy;if(sprite.x<this.region.x)sprite.vx=Math.abs(sprite.vx);if(sprite.x>this.region.x+this.region.width)sprite.vx=-Math.abs(sprite.vx);if(sprite.y<this.region.y)sprite.vy=Math.abs(sprite.vy);if(sprite.y>this.region.y+this.region.height)sprite.vy=-Math.abs(sprite.vy)}if(_mode&Game.Modes.SCALE_PING_PONG){if(sprite.scaleSpeed==0){if(_mode&Game.Modes.SCALE_RND_SPD){sprite.scaleSpeed=Math.random()*1+1;if(Math.random()<.5)sprite.scaleSpeed*=-1}else{sprite.scaleSpeed=1}}sprite.scale.x=sprite.scale.y+=.2*Main.elapsedTime/1e3*sprite.scaleSpeed;if(_mode&Game.Modes.MOVE_BOUNCE){if(sprite.scale.x<.6)sprite.scaleSpeed=Math.abs(sprite.scaleSpeed)}else{if(sprite.scale.x<Game.smallestScale)sprite.scaleSpeed=Math.abs(sprite.scaleSpeed)}if(sprite.scale.x>=.8)sprite.scaleSpeed=-Math.abs(sprite.scaleSpeed)}if(sprite.rotationSpeed)sprite.rotation+=.5*Main.elapsedTime/1e3*sprite.rotationSpeed;if(sprite.rotation<=-Math.PI)sprite.rotation+=2*Math.PI;if(sprite.rotation>Math.PI)sprite.rotation-=2*Math.PI}}var lastHovered=this.hovered;this.hovered=null;if(!this.isTweening&&this.list&&this.list.length>0){if(Main.mouseUpEvent){var point=Main.mouseUpEvent.data.getLocalPosition(this.list[0].parent);var nearList=this.findNearestSprites(point);Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false;if(nearList[0].distance<160){for(var i=0,l=nearList.length;i<l;i++){if(nearList[i].distance<160){if(this.matchingChoice.key==nearList[i].sprite.key){EventSignals.signal("correct");this.itemChosen=nearList[i];return true}}}EventSignals.signal("wrong");this.itemChosen=nearList[0];return true}}else if(Main.hoverEvent){var point=Main.hoverEvent.data.getLocalPosition(this.list[0].parent);var nearList=this.findNearestSprites(point);if(nearList[0].distance<160){this.hovered=nearList[0]}}}if(!lastHovered){if(this.hovered){this.hoverScale={x:this.hovered.sprite.scale.x,y:this.hovered.sprite.scale.y};this.hovered.time=0;this.glowStar=new Sprite(.5,.5);this.glowStar.create(this.hovered.sprite.parent,"flare",this.managers.textures,0,0);this.glowStar.scale.set(this.hovered.sprite.scale.x*1.5,this.hovered.sprite.scale.x*1.5);this.hovered.sprite.parent.addChild(this.hovered.sprite)}}else{if(this.hovered){if(lastHovered!=this.hovered){lastHovered.sprite.scale.set(this.hoverScale.x,this.hoverScale.y);this.hoverScale={x:this.hovered.sprite.scale.x,y:this.hovered.sprite.scale.y};this.hovered.time=0;if(this.glowStar)this.glowStar.destroy();this.glowStar=new Sprite(.5,.5);this.glowStar.create(this.hovered.sprite.parent,"flare",this.managers.textures,0,0);this.glowStar.scale.set(this.hovered.sprite.scale.x*1.5,this.hovered.sprite.scale.x*1.5);this.hovered.sprite.parent.addChild(this.hovered.sprite)}else{this.hovered.time+=Main.elapsedTime;var sx=this.hoverScale.x+.07*Math.sin(15*this.hovered.time/1e3);var sy=this.hoverScale.y+.07*Math.sin(15*this.hovered.time/1e3);this.hovered.sprite.scale.set(sx,sy)}}else{lastHovered.sprite.scale.set(this.hoverScale.x,this.hoverScale.y);if(this.glowStar)this.glowStar.destroy();this.glowStar=null}}if(this.glowStar){if(this.hovered){this.glowStar.x=this.hovered.sprite.x;this.glowStar.y=this.hovered.sprite.y;this.glowStar.rotation+=.5*Main.elapsedTime/1e3*3;if(this.glowStar.rotation<=-Math.PI)this.glowStar.rotation+=2*Math.PI;if(this.glowStar.rotation>Math.PI)this.glowStar.rotation-=2*Math.PI}else{this.glowStar.destroy();this.glowStar=null}}}return false};FindMe.prototype.flashChoices=function(){if(this.delayAppear==0)this.delayAppear=Main.time+4e3;var t=Math.floor(this.flashTimer/500)%this.choices.length;this.flashTimer+=Main.elapsedTime;for(var i=0;i<this.choices.length;i++){if(i==t)this.choices[i].alpha=.25;else this.choices[i].alpha=1}};FindMe.prototype.unflashChoices=function(){this.delayAppear=0;for(var i=0;i<this.choices.length;i++)this.choices[i].alpha=1};FindMe.prototype.findNearestSprites=function(_point){var list=[];for(var i=0,il=this.list.length;i<il;i++){var sprite=this.list[i];var dx=sprite.x-_point.x;var dy=sprite.y-_point.y;var d=Math.sqrt(dx*dx+dy*dy);list.push({distance:d,sprite:sprite,index:i})}list.sort(function(a,b){return a.distance-b.distance});return list};FindMe.prototype.pointInSprite=function(_point){for(var i=0,il=this.list.length;i<il;i++){var points=this.list[i];if(pointInPgon(_point.x,_point.y,points))return this.list[i]}return null};FindMe.prototype.showChoices=function(_chosen){if(Main.isPortrait)this.panel=new PIXI.Sprite(this.managers.textures.get("gamePanelPortrait"));else this.panel=new PIXI.Sprite(this.managers.textures.get("gamePanelLandscape"));this.panel.key="gamePanelLandscape";Main.leftBottomUI.addChild(this.panel);this.choices=[];for(var i=0;i<_chosen.length;i++){var choice=new Sprite(.5,.5);choice.create(this.panel,"gamePanelBox"+i.toString(),this.managers.textures,0,0,false,false);choice.scale.set(1/this.panel.scale.x,1/this.panel.scale.y);this.choices.push(choice);var key=_chosen[i].key;var sprite=new Sprite(.5,.5);sprite.create(choice,key,this.managers.textures,0,0,false,false);sprite.scale.set(.1,.1);sprite.visible=false;choice.image=sprite;(function(sprite){sprite.tween=new TWEEN.Tween(sprite).delay(i*100).start(Main.time).onComplete(function(){sprite.visible=true;sprite.tween=new TWEEN.Tween(sprite.scale).to({x:.5,y:.5},500).easing(TWEEN.Easing.Elastic.Out).start(Main.time)})})(sprite)}this.setPanel(false)};FindMe.prototype.setPanel=function(_dontTween){var s=Sprite.getGlobalScale(this.panel);if(Main.isPortrait){if(this.panel.key!="gamePanelPortrait"){this.panel.texture=this.managers.textures.get("gamePanelPortrait");this.panel.key="gamePanelPortrait"}this.panel.anchor.set(0,1);this.panel.width=Main.width/s.x;this.panel.height=Main.height/s.y*.2;if(_dontTween){if(!this.panel.tween||!this.panel.tween.isPlaying())this.panel.y=16/s.y}else{this.panel.y=this.panel.height;this.panel.tween=new TWEEN.Tween(this.panel).to({y:16/s.y},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}if(this.choices){var lt=this.panel.width/(3-.1)/this.panel.scale.x;var lx=(this.panel.width/this.panel.scale.x-lt*(this.choices.length-1))/2;var ly=this.panel.height/2/this.panel.scale.y+9;for(var i=0,l=this.choices.length;i<l;i++){var sprite=this.choices[l-1-i];sprite.x=lx;sprite.y=-ly;sprite.visible=true;sprite.alpha=1;lx+=lt;if(sprite.textSprite){sprite.textSprite.x=155;sprite.textSprite.y=0}}}}else{if(this.panel.key!="gamePanelLandscape"){this.panel.texture=this.managers.textures.get("gamePanelLandscape");this.panel.key="gamePanelLandscape"}this.panel.anchor.set(0,1);this.panel.height=Main.height/s.y*.8;this.panel.scale.x=this.panel.scale.y;if(_dontTween){if(!this.panel.tween||!this.panel.tween.isPlaying())this.panel.x=0}else{this.panel.x=-this.panel.width;this.panel.tween=new TWEEN.Tween(this.panel).to({x:0},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}if(this.choices){var lt=this.panel.height/(3+.2)/this.panel.scale.y;var lx=this.panel.width/2/this.panel.scale.x-7;var ly=(this.panel.height/this.panel.scale.y-lt*(this.choices.length-1))/2;for(var i=0,l=this.choices.length;i<l;i++){var sprite=this.choices[i];sprite.x=lx;sprite.y=-ly;sprite.visible=true;sprite.alpha=1;ly+=lt;if(sprite.textSprite){sprite.textSprite.x=0;sprite.textSprite.y=160}}}}if(this.choices){var s=2;var f;var pw=this.panel.texture.width*.82;var ph=this.panel.texture.height*.82;var l=this.choices.length;do{f=false;if(Main.isPortrait){if(this.choices[0].texture.height*s/this.panel.scale.y>ph){s-=.02;f=true}if(this.choices.length>1){if(this.choices[1].x+this.choices[1].texture.width*(s+.02)/this.panel.scale.x>this.choices[0].x){s-=.02;f=true}}if(this.choices.length>2){if(this.choices[2].x-this.choices[2].texture.width*s/this.panel.scale.x/2<0){s-=.02;f=true}}}else{if(this.choices[0].texture.width*s/this.panel.scale.x>pw){s-=.02;f=true}if(this.choices.length>1){if(this.choices[1].y+this.choices[1].texture.height*(s+.02)/this.panel.scale.y>this.choices[0].y){s-=.02;f=true}}}}while(f);for(var i=0;i<this.choices.length;i++){this.choices[i].scale.set(s/this.panel.scale.x,s/this.panel.scale.y)}}};FindMe.prototype.layout=function(_region){this.region=_region;if(this.region&&this.list&&this.choices){if(this.region.height<100||this.region.width<100){this.ready=false;if(!Game.paused&&Game.self){Game.self.pauseToggle()}return}var l=this.list.length;var allScale=1;this.spreadEm(allScale);var flag=false;var count=0;do{flag=false;for(var i=0;i<l;i++){if(this.overlappingPush(this.list[i],i,.75)){flag=true;break}}count++;if(flag&&count>25){count=0;allScale*=.9;this.spreadEm(allScale)}}while(flag);this.inflateEm();this.adjustPieces()}this.setPanel(true);this.ready=true};FindMe.prototype.overlappingPush=function(_sprite,_skipIndex,_softEdges){if(!_softEdges)_softEdges=1;var l=this.list.length;var thisFits=true;var s1=_sprite;for(var j=0;j<l;j++){if(j==_skipIndex)continue;var s2=this.list[j];var dx=s2.x-s1.x;var dy=s2.y-s1.y;var d=Math.sqrt(dx*dx+dy*dy);var required=(s1.radius+s2.radius)*_softEdges;if(required>d){var push=(required-d)*.5;s1.x-=dx/d*push+Math.random()*2-1;s1.y-=dy/d*push+Math.random()*2-1;s2.x+=dx/d*push+Math.random()*2-1;s2.y+=dy/d*push+Math.random()*2-1;thisFits=false}if(s1.x<this.region.x+s1.radius){s1.x=this.region.x+s1.radius;thisFits=false}if(s1.x>this.region.x+this.region.width-s1.radius){s1.x=this.region.x+this.region.width-s1.radius;thisFits=false}if(s1.y<this.region.y+s1.radius){s1.y=this.region.y+s1.radius;thisFits=false}if(s1.y>this.region.y+this.region.height-s1.radius){s1.y=this.region.y+this.region.height-s1.radius;thisFits=false}if(s2.x<this.region.x+s2.radius)s2.x=this.region.x+s2.radius;if(s2.x>this.region.x+this.region.width-s2.radius)s2.x=this.region.x+this.region.width-s2.radius;if(s2.y<this.region.y+s2.radius)s2.y=this.region.y+s2.radius;if(s2.y>this.region.y+this.region.height-s2.radius)s2.y=this.region.y+this.region.height-s2.radius}return!thisFits};FindMe.prototype.spreadEm=function(_scaleEm){var l=this.list.length;var scale=Game.largestScale*_scaleEm;for(var i=0;i<l;i++){var sprite=this.list[i];var w=sprite.texture.width*scale;var h=sprite.texture.height*scale;var r=Math.sqrt(w/2*w/2+h/2*h/2);var farthest={distance:0};var x,y,j;for(var c=0;c<50;c++){x=Math.random()*(this.region.width-r*2)+this.region.x+r;y=Math.random()*(this.region.height-r*2)+this.region.y+r;j=Utils.findNearestPointInList({x:x,y:y},this.list,undefined,i);var far=Utils.distanceBetween({x:x,y:y},this.list[j]);if(far>=farthest.distance)farthest={distance:far,x:x,y:y}}sprite.finalScale=scale;sprite.radius=r;sprite.x=farthest.x;sprite.y=farthest.y;scale-=1/l*(Game.largestScale*_scaleEm-Game.smallestScale*_scaleEm)}};FindMe.prototype.inflateEm=function(){var l=this.list.length;for(var i=0;i<l;i++){var sprite=this.list[i];if(!this.overlappingPush(sprite,i,.85)){do{if(sprite.finalScale+.1>Game.largestScale)break;sprite.finalScale+=.1;var w=sprite.texture.width*sprite.finalScale;var h=sprite.texture.height*sprite.finalScale;sprite.radius=Math.sqrt(w/2*w/2+h/2*h/2);if(this.overlappingPush(sprite,i,.86))break}while(true)}}};FindMe.prototype.adjustPieces=function(){var _that=this;var l=this.list.length;for(var i=0;i<l;i++){var sprite=this.list[i];sprite.startX=sprite.x;sprite.startY=sprite.y;sprite.vx=sprite.vy=undefined;sprite.rotationSpeed=0;sprite.scaleSpeed=0;sprite.alpha=1;if(!this.arrangedYet){sprite.scale.x=sprite.scale.y=.2;sprite.visible=false;(function(_sprite){_sprite.tween=new TWEEN.Tween(_sprite).delay(250+i*30+Math.max(_that.delayAppear-Main.time,0)).start(Main.time).onComplete(function(){_sprite.visible=true;_sprite.tween=new TWEEN.Tween(_sprite.scale).to({x:_sprite.finalScale,y:_sprite.finalScale},750).easing(TWEEN.Easing.Elastic.Out).start(Main.time)})})(sprite)}}this.arrangedYet=true};FindMe.prototype.shuffleListOrder=function(_min,_max){this.listOrder=[];var l=this.list.length;for(var i=0;i<l;i++)this.listOrder.push(i);Utils.shuffleList(this.listOrder)};FindMe.prototype.choiceMadeStart=function(_correct){var _this=this;this.ready=false;if(this.glowStar)this.glowStar.destroy();this.glowStar=null;if(_correct){for(var i=0,l=this.list.length;i<l;i++){this.list[i].visible=false}this.chosenChoice=null;for(var i=0,l=this.choices.length;i<l;i++){for(var j=0,lj=this.list.length;j<lj;j++){if(this.list[j].key==this.choices[i].image.key){this.chosenChoice=this.choices[i].image;this.choices[i].image.visible=false}}}var which=null;for(var i=0,l=this.choices.length;i<l;i++){if(this.choices[i].image!=this.chosenChoice){this.choices[i].image.destroy();this.choices[i].image=null}else{which=this.choices[i]}}this.choices=[which];this.list=null;if(this.itemChosen){var sprite=new Sprite(.5,.5);sprite.create(Main.leftTopUI,this.itemChosen.sprite.key,this.managers.textures,0,0,false,false);sprite.anchor.set(this.itemChosen.sprite.anchor.x,this.itemChosen.sprite.anchor.y);var scale=this.itemChosen.sprite.getGlobalScale(true);sprite.scale.set(scale.x*this.itemChosen.sprite.scale.x,scale.y*this.itemChosen.sprite.scale.y);sprite.rotation=this.itemChosen.sprite.rotation;var point=new PIXI.Point(0,0);point=this.itemChosen.sprite.toGlobal(point);point=Main.leftTopUI.toLocal(point);sprite.x=point.x;sprite.y=point.y;this.itemChosen=sprite;sprite.tween=new TWEEN.Tween(sprite.scale).delay(100).to({x:1,y:1},800).easing(TWEEN.Easing.Elastic.Out).start(Main.time);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};new TWEEN.Tween(sprite).delay(50).to({t:1,rotation:0},750).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width*11/16/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(Main.height/2/Main.leftTopUI.scale.y-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}if(this.chosenChoice){var sprite=new Sprite(.5,.5);sprite.create(Main.leftTopUI,this.chosenChoice.key,this.managers.textures,0,0,false,false);sprite.anchor.set(this.chosenChoice.anchor.x,this.chosenChoice.anchor.y);var scale=this.chosenChoice.getGlobalScale(true);sprite.scale.set(scale.x*this.chosenChoice.scale.x,scale.y*this.chosenChoice.scale.y);var point=new PIXI.Point(0,0);point=this.chosenChoice.toGlobal(point);point=Main.leftTopUI.toLocal(point);sprite.x=point.x;sprite.y=point.y;this.chosenChoice=sprite;sprite.tween=new TWEEN.Tween(sprite.scale).delay(50).to({x:1,y:1},750).easing(TWEEN.Easing.Elastic.Out).start(Main.time);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};new TWEEN.Tween(sprite).delay(50).to({t:1,rotation:0},750).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width*5/16/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(Main.height/2/Main.leftTopUI.scale.y-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}var sprite=new PIXI.Sprite(this.managers.textures.get("tick"));sprite.x=Main.width/2/Main.leftTopUI.scale.x;sprite.y=Main.height/Main.leftTopUI.scale.y+250;sprite.anchor.set(.5,.5);sprite.scale.set(1);Main.leftTopUI.addChild(sprite);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};this.tick=sprite;this.tick.tween=new TWEEN.Tween(sprite).delay(500).to({t:1},500).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width/2/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(Main.height/2/Main.leftTopUI.scale.y-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Back.Out).start(Main.time)}else{var sprite=new PIXI.Sprite(this.managers.textures.get("cross"));sprite.x=this.itemChosen.sprite.x;sprite.y=Main.height/this.itemChosen.sprite.parent.scale.y;sprite.anchor.set(.5,.5);sprite.scale.set(1);this.itemChosen.sprite.parent.addChild(sprite);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};this.tick=sprite;var chosenSprite=this.itemChosen.sprite;this.tick.tween=new TWEEN.Tween(sprite).delay(100).to({t:1},600).onUpdate(function(){var s=this._object;if(s.position){s.x=(chosenSprite.x-s.start.x)*s.t+s.start.x;s.y=(chosenSprite.y-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Back.Out).start(Main.time);this.bonusSprites=[];var b=0;var timex=[-20,0,25,-50,40];var timey=[-40,55,-10,10,-30];for(var i=0;i<Math.abs(Game.timeWrong);i++){var sprite=new PIXI.Sprite(this.managers.textures.get("timeLoss"));sprite.anchor.set(.5,.5);sprite.scale.set(1);Main.leftTopUI.addChild(sprite);var p=sprite.toLocal(this.itemChosen.sprite,this.itemChosen.sprite.parent);sprite.x=p.x;sprite.y=p.y;sprite.visible=false;sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};(function(sprite,i){sprite.tween=new TWEEN.Tween(sprite).delay(500).to({t:1},600).onUpdate(function(){var s=this._object;if(s.position){s.x=timex[i]*5*s.t+s.start.x;s.y=timey[i]*5*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.Out).onStart(function(){sprite.visible=true}).onComplete(function(){sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).delay(150+50*i).to({t:1},500).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width*11/16/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(100-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){sprite.visible=false;Game.timeLeft+=-1e3;Game.timePenalty=true;if(Game.timeLeft<0)Game.timeLeft=0}).start(Main.time)}).start(Main.time)})(sprite,i);this.bonusSprites[b++]=sprite}}};FindMe.prototype.choiceMadeUpdate=function(_correct,_scoreText,_timeText){var _this=this;if(!this.tick||!this.tick.tween.isPlaying()){if(!_correct)return this.wrongChoiceUpdate(_scoreText,_timeText);if(this.itemChosen){var whiteBlank=Utils.addBlanker(this.managers.textures,"blanker_white");new TWEEN.Tween(whiteBlank).to({alpha:0},500).onComplete(function(){Utils.removeBlanker()}).start(Main.time);var sprite=this.tick;sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).delay(400).to({t:1},600).onUpdate(function(){var s=this._object;if(s.position)s.y=(Main.height/Main.leftTopUI.scale.y+250-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){_this.tick.destroy();_this.tick=null}).start(Main.time);this.bonusSprites=[];var b=0;function radialPos(_which,_max,_radiusMin,_radiusMax){var angle=_which/_max*Math.PI*2;var d=_radiusMax-_radiusMin;return{x:Math.sin(angle+.3)*d+_radiusMin,y:Math.cos(angle+.3)*d+_radiusMin}}var sc=Game.scoreCorrect(Game.self.level);for(var i=0;i<sc;i++){var sprite=new PIXI.Sprite(this.managers.textures.get("pointsBonus"));sprite.x=this.chosenChoice.x;sprite.y=this.chosenChoice.y;sprite.anchor.set(.5,.5);sprite.scale.set(1);Main.leftTopUI.addChild(sprite);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};(function(sprite,i){var p=radialPos(i,sc,120,250);sprite.tween=new TWEEN.Tween(sprite).to({t:1},400).onUpdate(function(){var s=this._object;if(s.position){s.x=p.x*s.t+s.start.x;s.y=p.y*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).delay(100+50*i).to({t:1},400).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width*5/16/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(100-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){sprite.visible=false;Game.score+=10}).start(Main.time)}).start(Main.time)})(sprite,i);this.bonusSprites[b++]=sprite}var timex=[-20,0,25,-50,40];var timey=[-40,55,-10,10,-30];for(var i=0;i<Game.timeCorrect;i++){var sprite=new PIXI.Sprite(this.managers.textures.get("timeGain"));sprite.x=this.itemChosen.x;sprite.y=this.itemChosen.y;sprite.anchor.set(.5,.5);sprite.scale.set(1);Main.leftTopUI.addChild(sprite);sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};(function(sprite,i){sprite.tween=new TWEEN.Tween(sprite).to({t:1},400).onUpdate(function(){var s=this._object;if(s.position){s.x=timex[i]*3*s.t+s.start.x;s.y=timey[i]*3*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).delay(150+43*i).to({t:1},400).onUpdate(function(){var s=this._object;if(s.position){s.x=(Main.width*11/16/Main.leftTopUI.scale.x-s.start.x)*s.t+s.start.x;s.y=(100-s.start.y)*s.t+s.start.y}}).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){sprite.visible=false;Game.timeLeft+=1e3;if(Game.timeLeft<0)Game.timeLeft=0}).start(Main.time)}).start(Main.time)})(sprite,i);this.bonusSprites[b++]=sprite}this.itemChosen.destroy();this.itemChosen=null;this.chosenChoice.destroy();this.chosenChoice=null;for(var i=0,l=_scoreText.length;i<l;i++){var sprite=_scoreText[i];sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};var ty=sprite.start.y+60;(function(sprite,i){sprite.tween=new TWEEN.Tween(sprite).delay(1100+i*10).to({t:1},250).onUpdate(function(){var s=this._object;if(s.position)s.y=(ty-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){sprite.t=0;sprite.dest={x:sprite.x,y:sprite.start.y};sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).to({t:1},500).onUpdate(function(){var s=this._object;if(s.position)s.y=(s.dest.y-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Elastic.Out).start(Main.time)}).start(Main.time)})(sprite,i)}for(var i=0,l=_timeText.length;i<l;i++){var sprite=_timeText[i];sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};var ty=sprite.start.y-60;(function(sprite,i){sprite.tween=new TWEEN.Tween(sprite).delay(1200+i*10).to({t:1},250).onUpdate(function(){var s=this._object;if(s.position)s.y=(ty-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){sprite.t=0;sprite.dest={x:sprite.x,y:sprite.start.y};sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).to({t:1},500).onUpdate(function(){var s=this._object;if(s.position)s.y=(s.dest.y-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Elastic.Out).start(Main.time)}).start(Main.time)})(sprite,i)}}var flag=true;for(var i=0,l=this.bonusSprites.length;i<l;i++){if(this.bonusSprites[i].visible){flag=false}}if(flag){this.bonusSprites=null}Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false;return flag}return false};FindMe.prototype.wrongChoiceUpdate=function(_scoreText,_timeText){var _this=this;if(!this.tick||!this.tick.tween.isPlaying()){if(this.itemChosen){var sprite=this.tick;sprite.t=0;sprite.start={x:sprite.x,y:sprite.y};sprite.tween=new TWEEN.Tween(sprite).delay(500).to({t:1},750).onUpdate(function(){var s=this._object;if(s.position)s.y=(Main.height/Main.leftTopUI.scale.y+250-s.start.y)*s.t+s.start.y}).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){_this.tick.destroy();_this.tick=null}).start(Main.time);this.itemChosen=null;var b=this.bonusSprites.length;for(var i=0,l=_timeText.length;i<l;i++){var sprite=_timeText[i];var sy=sprite.y;var ty=sy-60;this.bonusSprites[b++]=sprite;(function(sprite,i){sprite.tween=new TWEEN.Tween(sprite).delay(1200+i*10).to({y:ty},250).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){sprite.tween=new TWEEN.Tween(sprite).to({y:sy},600).easing(TWEEN.Easing.Elastic.Out).start(Main.time)}).start(Main.time)})(sprite,i)}}var flag=true;for(var i=0,l=this.bonusSprites.length;i<l;i++){if(this.bonusSprites[i].tween.isPlaying()){flag=false}}if(flag){Game.timePenalty=false;this.bonusSprites=null;this.ready=true}Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false;return flag}return false};Game.smallestScale=.4;Game.largestScale=1.5;Game.timeCorrect=3;Game.timeWrong=-5;Game.scoreDigits=5;Game.timeDigits=6;Game.digitScale=1.07;Game.digitSpacing=67*Game.digitScale;Game.smallDigitSpacing=32*Game.digitScale;Game.timePenalty=false;Game.regionTop=150;Game.spotLights=3;Game.spotLightAlpha=.5;Game.Modes={NONE:0,ROTATE_CW:1,ROTATE_CCW:2,ROTATE_RND_DIR:4,ROTATE_RND_SPD:8,SCALE_PING_PONG:16,SCALE_RND_SPD:32,SCALE_WIDE_RANGE:64,MOVE_ELASTIC:128,MOVE_BOUNCE:256,MOVE_RND_SPD:512};Game.frameCount=0;Game.paused=false;Game.requestQuit=false;Game.score=0;Game.timeLeft=0;Game.self=null;Game.scoreCorrect=function(_level){return Math.min(Math.floor(_level/2)+2,10)};Game.numberToScatter=function(_level){return Math.min(Math.floor(_level/3+10),20)};Game.numberToChoose=function(_level){if(_level<5)return 1;if(_level<15)return 2;return 3};Game.levelModes=[Game.Modes.MOVE_ELASTIC,Game.Modes.MOVE_ELASTIC,Game.Modes.MOVE_ELASTIC,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.SCALE_PING_PONG,Game.Modes.SCALE_PING_PONG,Game.Modes.SCALE_PING_PONG,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.MOVE_BOUNCE,Game.Modes.MOVE_BOUNCE,Game.Modes.MOVE_BOUNCE,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD,Game.Modes.ROTATE_CW,Game.Modes.ROTATE_CCW,Game.Modes.ROTATE_CW,Game.Modes.ROTATE_CCW,Game.Modes.ROTATE_CW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CCW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CCW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_RND_DIR,Game.Modes.ROTATE_RND_DIR,Game.Modes.ROTATE_RND_DIR,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.SCALE_PING_PONG,Game.Modes.MOVE_ELASTIC|Game.Modes.SCALE_PING_PONG,Game.Modes.MOVE_ELASTIC|Game.Modes.SCALE_PING_PONG,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD,Game.Modes.SCALE_PING_PONG|Game.Modes.ROTATE_CW,Game.Modes.SCALE_PING_PONG|Game.Modes.ROTATE_CCW,Game.Modes.SCALE_PING_PONG|Game.Modes.ROTATE_CW,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD|Game.Modes.ROTATE_CCW,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD|Game.Modes.ROTATE_CW,Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD|Game.Modes.ROTATE_CCW,Game.Modes.MOVE_BOUNCE|Game.Modes.ROTATE_CW,Game.Modes.MOVE_BOUNCE|Game.Modes.ROTATE_CCW,Game.Modes.MOVE_BOUNCE|Game.Modes.ROTATE_CW,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG,Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG,Game.Modes.ROTATE_CW|Game.Modes.SCALE_PING_PONG,Game.Modes.ROTATE_CCW|Game.Modes.SCALE_PING_PONG,Game.Modes.ROTATE_CW|Game.Modes.SCALE_PING_PONG,Game.Modes.ROTATE_CCW|Game.Modes.SCALE_PING_PONG,Game.Modes.ROTATE_CW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CCW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CW|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_CCW|Game.Modes.ROTATE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.MOVE_ELASTIC|Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_ELASTIC|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD,Game.Modes.ROTATE_RND_DIR|Game.Modes.ROTATE_RND_SPD|Game.Modes.MOVE_BOUNCE|Game.Modes.MOVE_RND_SPD|Game.Modes.SCALE_PING_PONG|Game.Modes.SCALE_RND_SPD];Game.STARTING=0;Game.PLAYING=1;Game.WON_LEVEL=2;Game.WRONG_ANSWER=3;Game.NEXT_LEVEL=4;Game.TIME_UP=5;Game.WAIT_DELAY=6;Game.QUIT=7;function Game(){Game.self=this;this.managers=null;this.level=0;this.numLevels=0;this.help=null;this.confirm=null;this.bigMessagePopup=null;this.lastState=-1;this.state=Game.STARTING;this.nextState=-1;this.delay=0;this.won=false;this.tutorialPointer=null;this.nextTutorial=0;this.pauseButton=null;this.muteButton=null;this.stripTop=null;this.resumeButton=null;this.closeButton=null;this.spriteList=null;this.findMe=null;this.playRegion=null;this.playContainer=null;this.timeText=null;this.scoreText=null;this.gameOver=null;Game.paused=false;Game.requestQuit=false;Game.timeLeft=0;Game.score=0;Game.pieceIsTweening=0}Game.prototype.create=function(_managers,_numImages){var _this=this;this.managers=_managers;this.numLevels=Game.levelModes.length;this.numImages=_numImages;Game.paused=false;Game.requestQuit=false;Game.score=0;Game.timeLeft=Main.timerStart;this.level=1-1;this.help=null;this.confirm=null;this.bigMessagePopup=null;this.state=Game.STARTING;this.nextState=-1;this.delay=0;this.won=false;this.gameOver=null;GameOver.playAgain=false;this.playRegion={x:0,y:Game.regionTop,width:Main.width,height:Main.height-Game.regionTop};this.playContainer=new PIXI.Container;Main.playLayer.addChild(this.playContainer);this.spriteList=[];for(var i=0;i<Preloader.spriteNames.length;i++){var sprite=new Sprite(.5,.5);sprite.create(this.playContainer,Preloader.spriteNames[i],this.managers.textures,0,0,false,false);sprite.visible=false;this.spriteList.push(sprite)}this.buttons=[];if(Main.showMuteButton){this.muteButton=new Button(Button.TYPE_BUTTON,.5,.5);this.muteButton.create(Main.leftTopUI,"mute_button_unmute",this.managers,220,-190,false,"mute_button_unmute","mute_button_unmute_hover","mute_button_unmute_hover","click_mute",null,"mute_button_muted","mute_button_muted_hover","mute_button_muted_hover","click_unmute",null);this.muteButton.scale.set(1.2);this.muteButton.sfx="ui_button";this.muteButton.toggled=!this.managers.audio.mute;this.muteButton.callbackMouseDown=function(){Main.mouseDownLocal=null};this.buttons.push(this.muteButton)}this.pauseButton=new Button(Button.TYPE_BUTTON,.5,.5);this.pauseButton.create(Main.leftTopUI,"pause_button",this.managers,90,-190,false,"pause_button","pause_button_hover","pause_button_hover","click_pause");this.pauseButton.scale.set(1.2);this.pauseButton.sfx="ui_button";this.pauseButton.callbackMouseDown=function(){Main.mouseDownLocal=null};this.buttons.push(this.pauseButton);EventSignals.listen("click_pause",this.pauseToggle,this);EventSignals.listen("correct",function(){_this.state=Game.WON_LEVEL;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false},this);EventSignals.listen("wrong",function(){_this.state=Game.WRONG_ANSWER;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false},this);if(this.muteButton){this.muteButton.tween=new TWEEN.Tween(this.muteButton).to({y:90},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}this.pauseButton.tween=new TWEEN.Tween(this.pauseButton).to({y:90},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);this.startPrepare=Main.nowTime;this.spinner=null;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false};Game.prototype.prepare=function(){if(this.spinner){this.spinner.destroy();this.spinner=null}this.resize();if(this.tutorialPointer){this.tutorialPointer.destroy();this.tutorialPointer=null}if(Main.showTutorial&&this.level<6){this.nextTutorial=Main.nowTime+3e3+(this.level>0?7e3:0)+(Game.numberToChoose(this.level)==2?4e3:0)}else{this.nextTutorial=0}return false};Game.prototype.cleanUpAfterLevel=function(){if(this.gameOver){this.gameOver.destroy();this.gameOver=null}if(this.spotLights){for(var i=0;i<Game.spotLights;i++){this.spotLights[i].destroy()}this.spotLights=null}if(this.timeText){for(var i=0;i<Game.timeDigits;i++){this.timeText[i].destroy()}this.timeText=null}if(this.scoreText){for(var i=0;i<Game.scoreDigits;i++){this.scoreText[i].destroy()}this.scoreText=null}if(this.findMe){this.findMe.destroy();this.findMe=null}if(this.stripTop){this.stripTop.destroy();this.stripTop=null}if(this.bg){this.bg.destroy();this.bg=null}if(this.spinner){this.spinner.destroy();this.spinner=null}};Game.prototype.cleanUpAfterGame=function(){if(this.spriteList){var i=this.spriteList.length;while(i--){this.spriteList[i].destroy();this.spriteList[i]=null}this.spriteList=null}if(this.bigMessagePopup){this.bigMessagePopup.destroy();this.bigMessagePopup=null}if(this.help){this.help.destroy();this.help=null}if(this.confirm){this.confirm.destroy();this.confirm=null}if(this.muteButton){this.muteButton.destroy();this.muteButton=null}if(this.pauseButton){this.pauseButton.destroy();this.pauseButton=null}this.buttons=null;if(this.tutorialPointer){this.tutorialPointer.destroy();this.tutorialPointer=null}};Game.prototype.destroy=function(){this.cleanUpAfterLevel();this.cleanUpAfterGame();this.managers=null};Game.prototype.update=function(){var _that=this;var event=null;var ret=true;Game.frameCount++;if(this.buttons){for(i=0;i<this.buttons.length;i++){var b=this.buttons[i];event=b.update();if(event!==null)break}}if(!event&&this.closeButton){event=this.closeButton.update()}if(!event&&this.resumeButton){event=this.resumeButton.update()}switch(event){case"click_mute":this.muteButton.toggled=false;this.managers.audio.setMute(true,false);this.managers.audio.muteTunes(true,false);break;case"click_unmute":this.muteButton.toggled=true;this.managers.audio.setMute(false,false);this.managers.audio.muteTunes(false,false);break;case"click_resume":this.pauseToggle();break;case"click_close":this.pauseToggle();Game.requestQuit=true;GameOver.playAgain=false;break}if(this.confirm){if(this.confirm.update()){return ret}this.confirm.destroy();this.confirm=null}if(this.help){if(this.help.update()){return ret}var _this=this;this.help.remove(function(){_this.help=null})}if(Game.requestQuit){Game.requestQuit=false;this.state=Game.QUIT}var again;do{again=false;var newState=this.lastState!=this.state;this.lastState=this.state;switch(this.state){case Game.STARTING:if(newState){if(Main.debug){console.log("Starting level "+this.level)}var bgNum=this.level%5+1;this.bg=new Sprite;this.bg.create(Main.bgImage,"game_bg_"+bgNum.toString(),this.managers.textures);this.bg.anchor.set(.5,1);this.bg.y=Main.height/2/this.bg.parent.scale.y;var contrast_bar=["bar2","bar3","bar1","bar0","bar4"];this.stripTop=new Sprite(.5,.5);this.stripTop.create(Main.leftTopUI,contrast_bar[bgNum-1],this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.createTimeText();this.createScoreText();this.pauseButton.moveToFront();if(this.muteButton)this.muteButton.moveToFront();this.spotLights=[];for(var i=0;i<Game.spotLights;i++){this.spotLights[i]=new PIXI.Sprite(this.managers.textures.get("searchLight"));this.spotLights[i].anchor.set(.5,.5);this.spotLights[i].alpha=Game.spotLightAlpha;this.spotLights[i].visible=false;Main.playLayer.addChild(this.spotLights[i])}this.stripTop.tween=new TWEEN.Tween(this.stripTop).to({y:90},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);var whiteBlank=Utils.addBlanker(this.managers.textures,"blanker_white");new TWEEN.Tween(whiteBlank).to({alpha:0},750).onComplete(function(){Utils.removeBlanker()}).start(Main.time)}if(!this.prepare()){this.findMe=new FindMe(this.managers);var prevChoose=Game.numberToChoose(Math.max(this.level-1,0));this.findMe.create(this.spriteList,Game.numberToScatter(this.level),Game.numberToChoose(this.level),prevChoose);this.state=Game.PLAYING;again=true}break;case Game.PLAYING:if(newState){if(this.level>0)this.managers.audio.play("level_up");else this.managers.audio.play("game_start");Main.hover=Main.mouseDownLocal=null;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false;this.layoutResizeCheck=true;this.puzzleStartTime=Main.time}if(Main.cheatKeys){if(Keys.isPressed[KeyCodes.key_q]){this.state=Game.TIME_UP;break}}if(Main.showTutorial&&!this.tutorialPointer&&this.nextTutorial){if(Main.nowTime>this.nextTutorial){this.createTutorialPointer(this.findMe.matchingChoice);this.nextTutorial=0}}if(!Game.paused){this.showScore();this.moveSpotlights();var l=this.level;while(l>=Game.levelModes.length)l-=20;if(this.findMe.update(Game.levelModes[l])){for(var i=0;i<Game.spotLights;i++){this.spotLights[i].tween=new TWEEN.Tween(this.spotLights[i]).to({alpha:0},500).start(Main.time)}break}if(this.findMe.ready&&!this.findMe.isTweening){var intTime=Math.floor(Game.timeLeft/1e3);if(!Main.disableGameTimer){Game.timeLeft-=Main.elapsedTime}if(Game.timeLeft<=0){this.state=Game.TIME_UP;break}if(Game.timeLeft<=5e3&&Math.floor(Game.timeLeft/1e3)!=intTime){this.managers.audio.play("timer_beep")}this.showTime()}else{Main.hover=Main.mouseDownLocal=null;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false}}else{if(this.findMe&&this.findMe.ready)this.findMe.hidePieces()}if(this.timeText){this.timeText.value=Math.floor(Game.timeLeft/1e3)}break;case Game.WRONG_ANSWER:if(newState){this.managers.audio.play("incorrect_match");this.findMe.choiceMadeStart(false)}if(this.findMe.choiceMadeUpdate(false,this.scoreText,this.timeText)){this.state=Game.PLAYING;this.lastState=this.state}this.showScore();this.showTime(Game.timePenalty);break;case Game.WON_LEVEL:if(newState){this.managers.audio.play("correct_match");this.managers.audio.play(["children_cheers_01","children_cheers_02","children_cheers_03"]);this.timeTaken=Main.time-this.puzzleStartTime;this.findMe.choiceMadeStart(true)}if(this.findMe.choiceMadeUpdate(true,this.scoreText,this.timeText)){this.delay=1e3;this.state=Game.WAIT_DELAY;this.nextState=Game.NEXT_LEVEL}this.showScore();this.showTime();break;case Game.TIME_UP:if(newState){this.cleanUpAfterLevel();this.cleanUpAfterGame();this.gameOver=new GameOver;this.gameOver.create(this.managers);this.managers.audio.play("game_over")}if(!this.gameOver.update()){this.gameOver.destroy();this.gameOver=null;this.state=Game.QUIT;again=true}break;case Game.NEXT_LEVEL:if(newState){this.level++;if(this.level>this.numLevels-1){this.won=true;again=true;this.state=Game.QUIT;break}this.cleanUpAfterLevel();if(this.timeTaken>Game.tooSlow){this.puzzleWide=Math.max(this.puzzleWide-1,3);this.puzzleHigh=Math.max(this.puzzleHigh-1,3)}else{if(this.level%3==0){this.puzzleWide=Math.min(this.puzzleWide+1,5);this.puzzleHigh=Math.min(this.puzzleHigh+1,5)}}this.state=Game.STARTING;again=true}break;case Game.WAIT_DELAY:this.delay=Math.max(this.delay-Main.elapsedTime,0);if(this.delay===0){this.state=this.nextState;again=true}else{}break;case Game.QUIT:ret=false;TWEEN.removeAll();Game.pieceIsTweening=0;Utils.addBlanker(this.managers.textures,"blanker_white");break}}while(again);if(this.layoutResizeCheck&&this.state!=Game.STARTING){this.wasResized();this.layoutResizeCheck=false}return ret};Game.prototype.moveSpotlights=function(){var w=Main.width/Main.playLayer.scale.x;var h=Main.height/Main.playLayer.scale.y;for(var i=0;i<Game.spotLights;i++){var sprite=this.spotLights[i];if(sprite.vx===undefined){sprite.x=Math.random()*w-w/2;sprite.y=Math.random()*h-h/2;var angle=Math.random()*Math.PI*2;sprite.vx=Math.sin(angle);sprite.vy=Math.cos(angle);sprite.visible=true;sprite.blendMode=PIXI.BLEND_MODES.ADD}sprite.x+=sprite.vx*Main.elapsedTime/1e3*200;sprite.y+=sprite.vy*Main.elapsedTime/1e3*200;if(sprite.x<-w/2||sprite.x>w/2)sprite.vx=-sprite.vx;if(sprite.y<-h/2||sprite.y>h/2)sprite.vy=-sprite.vy}};Game.prototype.createTimeText=function(){this.timeText=[];this.timeOffsetsX=[Game.digitSpacing*0,Game.digitSpacing*1,Game.digitSpacing*1+Game.smallDigitSpacing*1,Game.digitSpacing*2+Game.smallDigitSpacing*1,9+Game.digitSpacing*3+Game.smallDigitSpacing*1,9+Game.digitSpacing*3+Game.smallDigitSpacing*2];this.timeOffsetsY=[100-54*Game.digitScale,100-54*Game.digitScale+12,100-54*Game.digitScale,100-54*Game.digitScale,100-54*Game.digitScale+8,100-54*Game.digitScale+8];for(var i=0;i<Game.timeDigits;i++){var s=new PIXI.Sprite(this.managers.textures.get("greenNumber0"));s.anchor.set(0,0);s.scale.set(Game.digitScale,Game.digitScale);s.x=Main.width*11/16/Main.leftTopUI.scale.x+this.timeOffsetsX[i]-(Game.digitSpacing*3+Game.smallDigitSpacing*3)/2;s.y=-150;if(i>3)s.scale.set(.5*Game.digitScale,.5*Game.digitScale);Main.leftTopUI.addChild(s);this.timeText[i]=s;var ty=this.timeOffsetsY[i];s.tween=new TWEEN.Tween(s).delay(600+i*10).to({y:ty},800).easing(TWEEN.Easing.Bounce.Out).start(Main.time)}this.timeText.value=Game.timeLeft;this.showTime()};Game.prototype.createScoreText=function(){this.scoreText=[];for(var i=0;i<Game.scoreDigits;i++){var s=new PIXI.Sprite(this.managers.textures.get("yellowNumber0"));s.anchor.set(0,0);s.scale.set(Game.digitScale,Game.digitScale);s.x=Main.width*13/32/Main.leftTopUI.scale.x+i*Game.digitSpacing-Game.scoreDigits*Game.digitSpacing/2;s.y=-150;Main.leftTopUI.addChild(s);this.scoreText[i]=s;var ty=100-54*Game.digitScale;s.tween=new TWEEN.Tween(s).delay(600+i*10).to({y:ty},800).easing(TWEEN.Easing.Bounce.Out).start(Main.time)}this.scoreText.value=Game.timeLeft;this.showScore()};Game.prototype.showTime=function(_red){var s=this.timeText.value.toString();var numberConversions;if(_red)numberConversions=["redNumber0","redNumber1","redNumber2","redNumber3","redNumber4","redNumber5","redNumber6","redNumber7","redNumber8","redNumber9","redNumberColon"];else numberConversions=["greenNumber0","greenNumber1","greenNumber2","greenNumber3","greenNumber4","greenNumber5","greenNumber6","greenNumber7","greenNumber8","greenNumber9","greenNumberColon"];var timeConverted=Utils.convertDecimalTime(Game.timeLeft,true);var timeDigits=Utils.digitsInList(timeConverted,Game.timeDigits-1,"0");timeDigits.splice(1,0,-1);for(var i=0;i<Game.timeDigits;i++){var s=this.timeText[i];s.x=Main.width*23/32/Main.leftTopUI.scale.x+this.timeOffsetsX[i]-(Game.digitSpacing*3+Game.smallDigitSpacing*3)/2;var c=timeDigits[i];if(c==-1){s.texture=this.managers.textures.get(numberConversions[10])}else{var key=numberConversions[c];s.texture=this.managers.textures.get(key);if(key=="greenNumber1"||key=="redNumber1")s.x+=11*s.scale.x}s.parent.addChild(s)}};Game.prototype.showScore=function(){var s=this.scoreText.value.toString();var numberConversions=["yellowNumber0","yellowNumber1","yellowNumber2","yellowNumber3","yellowNumber4","yellowNumber5","yellowNumber6","yellowNumber7","yellowNumber8","yellowNumber9","yellowNumberColon"];var scoreDigits=Utils.digitsInList(Game.score,Game.scoreDigits,"0");for(var i=0;i<Game.scoreDigits;i++){var s=this.scoreText[i];s.x=Main.width*13/32/Main.leftTopUI.scale.x+i*Game.digitSpacing-Game.scoreDigits*Game.digitSpacing/2;var key=numberConversions[scoreDigits[i]];s.texture=this.managers.textures.get(key);if(key=="yellowNumber1")s.x+=11;s.parent.addChild(s)}};Game.prototype.pauseToggle=function(){Game.paused=!Game.paused;Main.mouseDown=null;if(Main.debug){if(Game.paused)console.log("Game.pauseToggle to true");else console.log("Game.pauseToggle to false")}this.managers.audio.pauseMute(Game.paused);if(this.gameOver){if(Game.paused){if(this.muteButton)this.muteButton.enabled=false}else{if(this.muteButton)this.muteButton.enabled=true}return}if(Game.paused){if(this.muteButton)this.muteButton.enabled=false;Utils.addBlanker(this.managers.textures);this.resumeButton=new Button(Button.TYPE_BUTTON,.5,.5);this.resumeButton.create(Main.fullUI,"resume_button",this.managers,0,-120,false,"resume_button","resume_button_hover","resume_button_hover","click_resume");this.closeButton=new Button(Button.TYPE_BUTTON,.5,.5);this.closeButton.create(Main.fullUI,"close_button",this.managers,0,120,false,"close_button","close_button_hover","close_button_hover","click_close")}else{if(this.muteButton)this.muteButton.enabled=true;Utils.removeBlanker();if(this.resumeButton){this.resumeButton.destroy();this.resumeButton=null}if(this.closeButton){this.closeButton.destroy();this.closeButton=null}}};Game.prototype.createTutorialPointer=function(_correctPiece){var _that=this;this.tutorialPointer=new Sprite(.5,.5);this.tutorialPointer.create(_correctPiece,"finger",this.managers.textures,0,0,false);this.tutorialPointer.rotation=80*Math.PI/180-_correctPiece.rotation;this.tutorialPointer.alpha=0;this.tutorialPointer.anchor.set(.5,1);this.tutorialPointer.scale.set(.8/_correctPiece.scale.x,.8/_correctPiece.scale.y);this.tutorialPointer.startX=Math.cos(-_correctPiece.rotation)*192;this.tutorialPointer.startY=Math.sin(-_correctPiece.rotation)*192;this.tutorialPointer.x=this.tutorialPointer.endX=Math.cos(-_correctPiece.rotation)*64;this.tutorialPointer.y=this.tutorialPointer.endY=Math.sin(-_correctPiece.rotation)*64;this.tutorialPointer.tween=new TWEEN.Tween(this.tutorialPointer).to({alpha:1},250).start().onComplete(_that.restartTutorialPointer.bind(_that))};Game.prototype.restartTutorialPointer=function(){var _that=this;if(!this.tutorialPointer)return;this.tutorialPointer.parent.moveToFront();this.tutorialPointer.tween=new TWEEN.Tween(this.tutorialPointer).to({x:this.tutorialPointer.startX,y:this.tutorialPointer.startY},250).easing(TWEEN.Easing.Quadratic.InOut).chain(this.tutorialPointer.tween=new TWEEN.Tween(this.tutorialPointer).to({x:this.tutorialPointer.endX,y:this.tutorialPointer.endY},250).easing(TWEEN.Easing.Quadratic.InOut).onComplete(function(){_that.restartTutorialPointer()})).start(Main.time)};Game.prototype.resize=function(){if(this.bg){this.bg.y=Main.height/2/this.bg.parent.scale.y}this.layoutResizeCheck=true};Game.prototype.wasResized=function(){var s=Sprite.getGlobalScale(this.playContainer);var w=Main.width/s.x;var h=Main.height/s.y;this.playContainer.x=-w/2;this.playContainer.y=-h/2;if(Main.isPortrait){this.playRegion={x:0,y:Game.regionTop,width:w,height:h*.8-Game.regionTop}}else{this.playRegion={x:w*.2,y:Game.regionTop,width:w*.8,height:h-Game.regionTop}}if(this.stripTop){this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.stripTop.x=Main.width/2/Main.leftTopUI.scale.x;this.showTime();this.showScore()}if(this.findMe){this.findMe.layout(this.playRegion)}if(this.gameOver){this.gameOver.resize()}};Game.isDragging=function(){if(Game.self)return Game.self.dragPiece;return false};function GameOver(){this.managers=null;this.timeStart=0;this.pauseButton=null;this.muteButton=null;this.replayButton=null;this.shinyGlowSprite=null;this.stripTop=null;this.stripBottom=null;this.stripScore=null;this.fallingPieces=null;this.sprites=null;this.buttons=null}GameOver.playAgain=false;GameOver.prototype.create=function(_managers){var _that=this;GameOver.playAgain=false;this.managers=_managers;this.timeStart=Main.time;this.fonts=this.managers.data.get("fonts");var bgNum=this.level%5+1;this.bg=new Sprite;this.bg.create(Main.bgImage,"game_title_bg",this.managers.textures);this.bg.anchor.set(.5);this.fallingPieces=[];for(var i=0;i<15;i++){var s=new Sprite;s.create(this.bg,Utils.pickRandomFromList(Preloader.spriteNames),this.managers.textures,Math.random()*this.bg.width-this.bg.width/2,this.bg.height/2-Math.random()*this.bg.height*3,false);s.rotation=Math.random()*Math.PI*2;s.vr=(Math.random()-.5)*.025;s.scale.set(.75);s.anchor.set(.5);this.fallingPieces[i]=s}this.stripTop=new Sprite(.5,.5);this.stripTop.create(Main.leftTopUI,"bar3",this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.stripBottom=new Sprite(.5,.5);this.stripBottom.create(Main.leftBottomUI,"bar3",this.managers.textures,Main.width/2/Main.leftBottomUI.scale.x,190);this.stripBottom.width=Main.width/Main.leftBottomUI.scale.x;this.stripTop.tween=new TWEEN.Tween(this.stripTop).to({y:100},500).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);this.stripBottom.tween=new TWEEN.Tween(this.stripBottom).to({y:-100},500).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);this.buttons=[];this.sprites=[];if(Main.showMuteButton){this.muteButton=new Button(Button.TYPE_BUTTON,.5,.5);this.muteButton.create(Main.leftTopUI,"mute_button_unmute",this.managers,90,-190,false,"mute_button_unmute","mute_button_unmute_hover","mute_button_unmute_hover","click_mute",null,"mute_button_muted","mute_button_muted_hover","mute_button_muted_hover","click_unmute",null);this.muteButton.sfx="ui_button";this.muteButton.toggled=!this.managers.audio.mute;this.muteButton.callbackMouseDown=function(){Main.mouseDownLocal=null};this.buttons.push(this.muteButton)}this.pauseButton=new Button(Button.TYPE_BUTTON,.5,.5);this.pauseButton.create(Main.leftBottomUI,"back_button",this.managers,90,190,false,"back_button","back_button_hover","back_button_hover","click_back");this.pauseButton.sfx="ui_button";this.pauseButton.callbackMouseDown=function(){Main.mouseDownLocal=null};this.buttons.push(this.pauseButton);if(this.muteButton){this.muteButton.tween=new TWEEN.Tween(this.muteButton).to({y:100},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}this.pauseButton.tween=new TWEEN.Tween(this.pauseButton).to({y:-100},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);this.gameOverPanel=new Sprite(.5,.5);this.gameOverPanel.create(Main.leftTopUI,"gameOverPanel",this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.gameOverPanel.scale.set(1.3,1.3);var text=new CanvasText(Main.app.view);text.create(0,0,this.fonts["gameOver"][Main.languageCode],90,this.fonts["font0"][Main.languageCode],"white","center");text.convertTextToTexture("gameOverText");this.textSprite=new Sprite(.5,.5);this.textSprite.create(this.gameOverPanel,"gameOverText",this.managers.textures,0,0);while(this.textSprite.width>this.gameOverPanel.width*.8)this.textSprite.scale.set(this.textSprite.scale.x-.1,this.textSprite.scale.x-.1);this.gameOverPanel.addChild(this.textSprite);this.sprites.push(this.textSprite);this.gameOverPanel.tween=new TWEEN.Tween(this.gameOverPanel).delay(100).to({y:100},800).easing(TWEEN.Easing.Back.Out).start(Main.time);this.shinyGlowSprite=new Sprite(.5,.5);this.shinyGlowSprite.create(Main.fullUI,"flare",this.managers.textures,0,Main.height*1/4/Main.fullUI.scale.y);this.shinyGlowSprite.visible=true;this.sprites.push(this.shinyGlowSprite);this.replayButton=new Button(Button.TYPE_BUTTON,.5,.5);this.replayButton.create(Main.fullUI,"replay_button",this.managers,0,Main.height*1/4/Main.fullUI.scale.y,false,"replay_button","replay_button_hover","replay_button_hover","click_replay");this.replayButton.sfx="ui_button";this.replayButton.callbackHover=function(_btn){_that.shinyGlowSprite.rotation+=.025;_that.shinyGlowSprite.scale.set((Math.sin(Main.nowTime*.003)+1)/2*.25+1.75)};this.replayButton.scale.set(1.5,1.5);this.buttons.push(this.replayButton);this.stripScore=new Sprite(.5,.5);this.stripScore.create(Main.leftTopUI,"bar0",this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.stripScore.width=Main.width/Main.leftTopUI.scale.x;this.stripScore.tween=new TWEEN.Tween(this.stripScore).delay(500).to({y:Main.height*3/8/Main.leftTopUI.scale.y},500).easing(TWEEN.Easing.Back.Out).start(Main.time);var text2=new CanvasText(Main.app.view);text2.create(0,0,this.fonts["finalScore"][Main.languageCode],90,this.fonts["font1"][Main.languageCode],"white","center");text2.convertTextToTexture("finalScoreText");this.fsTextSprite=new Sprite(.5,.5);this.fsTextSprite.create(this.stripScore,"finalScoreText",this.managers.textures,0,-150);this.stripScore.addChild(this.fsTextSprite);this.fsTextSprite.scale.x=1/this.fsTextSprite.parent.scale.x;this.sprites.push(this.fsTextSprite);this.createScoreText();var whiteBlank=Utils.addBlanker(this.managers.textures,"blanker_white");whiteBlank.tween=new TWEEN.Tween(whiteBlank).to({alpha:0},750).onComplete(function(){Utils.removeBlanker()}).start(Main.time)};GameOver.prototype.destroy=function(){if(this.bg){this.bg.destroy();this.bg=null}if(this.buttons){for(var i=0,l=this.buttons.length;i<l;i++)this.buttons[i].destroy();this.buttons=null}this.muteButton=null;this.pauseButton=null;this.replayButton=null;if(this.sprites){for(var i=0,l=this.sprites.length;i<l;i++)this.sprites[i].destroy();this.sprites=null}if(this.fallingPieces){for(i=0;i<this.fallingPieces.length;i++)this.fallingPieces[i].destroy();this.fallingPieces=null}if(this.gameOverPanel){this.gameOverPanel.destroy();this.gameOverPanel=null}if(this.scoreText){for(var i=0,l=this.scoreText.length;i<l;i++)this.scoreText[i].destroy();this.scoreText=null}if(this.stripBottom){this.stripBottom.destroy();this.stripBottom=null}if(this.stripScore){this.stripScore.destroy();this.stripScore=null}if(this.stripTop){this.stripTop.destroy();this.stripTop=null}this.managers=null};GameOver.prototype.update=function(){this.showScore();if(this.shinyGlowSprite){this.shinyGlowSprite.rotation+=.0125;this.shinyGlowSprite.scale.set(((Math.sin(Main.nowTime*.003)+1)/2*.5+1.5)*this.replayButton.scale.x)}if(this.sprites){for(i=0;i<this.sprites.length;i++)this.sprites[i].update()}if(this.buttons){for(i=0;i<this.buttons.length;i++){var b=this.buttons[i];event=b.update();if(event!==null)break}}if(this.fallingPieces){for(i=0;i<this.fallingPieces.length;i++){var s=this.fallingPieces[i];s.y+=3;s.rotation+=s.vr;if(s.rotation<-Math.PI)s.rotation+=Math.PI*2;if(s.rotation>=Math.PI)s.rotation-=Math.PI*2;if(s.y>this.bg.height*.6){s.x=Math.random()*this.bg.width-this.bg.width/2;s.y=-this.bg.height*.6-Math.random()*this.bg.height*.25;s.rotation=Math.random()*Math.PI*2;s.vr=(Math.random()-.5)*.05}}}






switch(event){case"click_mute":this.muteButton.toggled=false;this.managers.audio.setMute(true,false);this.managers.audio.muteTunes(true,false);break;case"click_unmute":this.muteButton.toggled=true;this.managers.audio.setMute(false,false);this.managers.audio.muteTunes(false,false);break;case"click_replay":GameOver.playAgain=true;return false;case"click_back":GameOver.playAgain=false;return false}return true};GameOver.prototype.resize=function(){this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.stripTop.x=Main.width/2/Main.leftTopUI.scale.x;this.stripBottom.width=Main.width/Main.leftTopUI.scale.x;this.stripBottom.x=Main.width/2/Main.leftTopUI.scale.x;this.stripScore.width=Main.width/Main.leftTopUI.scale.x;this.stripScore.x=Main.width/2/Main.leftTopUI.scale.x;this.stripScore.y=Main.height*3/8/Main.leftTopUI.scale.y;this.gameOverPanel.x=Main.width/2/Main.leftTopUI.scale.x;this.fsTextSprite.scale.x=1/this.fsTextSprite.parent.scale.x;this.replayButton.y=Main.height*1/4/Main.fullUI.scale.y;this.shinyGlowSprite.y=Main.height*1/4/Main.fullUI.scale.y};GameOver.prototype.createScoreText=function(){var numberConversions=["yellowNumber0","yellowNumber1","yellowNumber2","yellowNumber3","yellowNumber4","yellowNumber5","yellowNumber6","yellowNumber7","yellowNumber8","yellowNumber9","yellowNumberColon"];this.scoreText=[];var scoreDigits=Utils.digitsInList(Game.score,Game.scoreDigits,"0");for(var i=0;i<Game.scoreDigits;i++){var key=numberConversions[scoreDigits[i]];var s=new PIXI.Sprite(this.managers.textures.get(key));s.anchor.set(.5,.5);s.scale.set(2,2);s.x=Main.width/2/Main.leftTopUI.scale.x+i*Game.digitSpacing*1.75-Game.scoreDigits*Game.digitSpacing*1.75/2;s.y=-150;if(key=="yellowNumber1")s.x+=11;Main.leftTopUI.addChild(s);this.scoreText[i]=s;var ty=Main.height*3/8/Main.leftTopUI.scale.y;s.tween=new TWEEN.Tween(s).delay(600+i*10).to({y:ty},800).easing(TWEEN.Easing.Back.Out).start(Main.time)}this.scoreText.value=Game.timeLeft;this.showScore()};GameOver.prototype.showScore=function(){for(var i=0;i<Game.scoreDigits;i++){var s=this.scoreText[i];s.parent.addChild(s);s.x=Main.width/2/Main.leftTopUI.scale.x+i*Game.digitSpacing*1.75-(Game.scoreDigits-1)*Game.digitSpacing*1.75/2;if(s.key=="yellowNumber1")s.x+=11;s.startY=Main.height*3/8/Main.leftTopUI.scale.y;if(!s.tween.isPlaying())s.y=s.startY+Math.sin(i+Main.time/1e3*4)*Math.min((Main.time-this.timeStart)/200,24)}};function GameControl(){this.preloader=null;this.titles=null;this.game=null}GameControl.GameStates={NONE:-1,PRELOAD:0,TITLES:1,PLAY:2};GameControl.pageHidden=false;GameControl.tutorialActive=false;GameControl.prototype.create=function(){this.preloader=new Preloader("./");this.preloader.preload(this,Main.lowResolutionAssets);this.lastState=GameControl.GameStates.NONE;this.state=GameControl.GameStates.PRELOAD;EventSignals.create();this.titles=null;this.game=null;Utils.focusChangeCallback=this.onFocusChange;Utils.focusChangeContext=this;Utils.detectHidden();GameControl.pageHidden=Utils.isHidden();GameControl.tutorialActive=true};GameControl.prototype.update=function(){if(!Game.paused){TWEEN.update(Main.time)}var again;do{again=false;var newState=this.lastState!=this.state;this.lastState=this.state;if(Main.debugSpam&&newState){console.log("GameControl.state changed to",this.state)}switch(this.state){case GameControl.GameStates.PRELOAD:this.preloader.update();if(this.preloader.allLoaded()){this.state=GameControl.GameStates.TITLES;again=true}break;case GameControl.GameStates.TITLES:if(newState){Keys.create();if(Main.debug){Keys.ignoreKey(KeyCodes.shift);Keys.ignoreKey(KeyCodes.ctrl);Keys.ignoreKey(KeyCodes.key_i);Keys.ignoreKey(KeyCodes.f8)}EventHandlers.clearCallbacks();this.resetInput();this.titles=new Titles;this.titles.create(this.preloader)}this.preloader.audioManager.update();if(!this.titles.update()){this.titles.destroy();this.titles=null;this.state=GameControl.GameStates.PLAY}break;case GameControl.GameStates.PLAY:if(newState){this.game=new Game;this.game.create(this.preloader.getManagers(),Preloader.images);Main.playLayer.x=0;Main.playLayer.y=0;Utils.removeBlanker();this.resetInput()}this.preloader.audioManager.update();if(Main.mouseUpEvent&&Main.discardMouseUp>Main.nowTime-500){Main.mouseUpEvent=false;Main.discardMouseUp=0}if(!this.game.update()){this.game.destroy();this.game=null;if(GameOver.playAgain){this.lastState=GameControl.GameStates.TITLES;again=true}else{this.state=GameControl.GameStates.TITLES}}break}}while(again);if(Main.mouseDown){Main.getFocus()}Main.render()};GameControl.prototype.resetInput=function(){Keys.reset();Main.resetInput()};GameControl.prototype.onFocusChange=function(_hidden){if(!_hidden)Main.getFocus();if(!Main.pauseOnFocusLoss){this.preloader.audioManager.visibilityMute(_hidden);if(!PIXI.utils.isMobile.any){return}}if(_hidden){if(!Game.paused&&this.game){this.game.pauseToggle()}else{Game.paused=true;this.preloader.audioManager.pauseMute(true)}}else{if(!Game.paused||!this.game||this.game.gameOver){Game.paused=false;this.preloader.audioManager.pauseMute(false)}Main.discardMouseUp=Main.nowTime;Main.hover=Main.mouseDownLocal=null;Main.mouseUp=Main.click=Main.mouseUpEvent=Main.hoverEvent=false}if(Main.debug){console.log("GameControl.onFocusChange hidden =",_hidden,"at time =",Date.now())}};GameControl.prototype.resize=function(){if(this.titles)this.titles.resize();if(this.game)this.game.resize()};



function Main()
{
    Main.self = this;

    // debug information and settings
    Main.VERSION = "v2.52";    
    Main.debug = false;       
    Main.debugSpam = false;    
    Main.showFPS = false;       
    Main.cheatKeys = false;     
    Main.showTutorial = true;   
    Main.testLanguage = false;   


    Main.pauseOnFocusLoss = true;    


    Main.timerStart = (1 * 30 + 0) * 1000 + 0;         
    Main.gameWide = 1200;
    Main.gameHigh = 1200;
    Main.volumeControl = 0.5;                          
    Main.shortTapDurationMS = 400;
    Main.noSfxIE = false;                               
    Main.showMuteButton = Main.checkAudio();


    Main.click = null;
    Main.hover = null;
    Main.hoverEvent = null;
    Main.mouseDown = null;
    Main.mouseUp = null;
    Main.mouseUpEvent = null;
    Main.mouseMoveLocal = null;
    Main.mouseDownLocal = null;
    Main.mouseUpLocal = null;
    Main.swipe = 0;
    Main.swipeEnabled = false;
    Main.discardMouseUp = 0;


    Main.forceResize = false;
    Main.resized = false;
    Main.time = 0;
    Main.elapsedTime = 0;
    Main.muteUntil = -1;
    Main.nowTime = 0;
    Main.aspectRatio = 1.0;
    Main.isPortrait = false;
    Main.lowResolutionAssets = false;
    Main.pieceScale = 1.0;
    Main.languageCode = "en";    


    Main._lastTime = 0;


    this.gameControl = null;

  
    if ( !window.devicePixelRatio )
        window.devicePixelRatio = 1;
}



Main.timeStarted = Date.now();
Main.width = null;
Main.height = null;
Main.self = null;
Main.lockedLevels = null;
Main.levelScores = null;
Main.levelStars = null;
Main.levelLosses = null;


Main.disableGameTimer = false;



Main.prototype.createGame = function()
{
    Main.document = document;


    new EventHandlers();

    this.playGame();
}


Main.prototype.createPixi = function()
{

    var pixelRatio = (window) ? (window.devicePixelRatio) : 1;
    Main.app = new PIXI.Application({
        autoResize: true,
        resolution: pixelRatio,
        backgroundColor: 0x872f87,
        transparent: 'notMultiplied',
        forceCanvas: false
    }, Main.gameWide, Main.gameHigh);
    Main.app.renderer = Main.app.renderer;


    if (Main.app.renderer instanceof PIXI.CanvasRenderer)
    {
        console.log("PIXI using Canvas Renderer");
        if ( PIXI.utils.isMobile.any ) console.log( "Mobile device" );
    }
    else
    {
        console.log("PIXI using WebGl Renderer");
        if ( PIXI.utils.isMobile.any ) console.log( "Mobile device" );
    }

    document.body.appendChild(Main.app.view);


    Main.getFocus();



    var versionIE = Main.detectIE();
    Main.isIE = (versionIE ? (versionIE < 12) : false);
    if (Main.debug && Main.isIE) console.log("Main.isIE =", Main.isIE);

    Main.isAndroid = PIXI.utils.isMobile.android.phone || PIXI.utils.isMobile.android.seven_inch || PIXI.utils.isMobile.android.tablet;
    if (Main.debug) console.log("Main.android device =", Main.isAndroid);

    Main.isChromeMobile = PIXI.utils.isMobile.other.chrome;
    if (Main.debug) console.log("Main.isChromeMobile =", Main.isChromeMobile);


    Main.stage = Main.app.stage;
    Main.stage.x = Main.gameWide / 2;
    Main.stage.y = Main.gameHigh / 2;


    Main.bgImage = new PIXI.Sprite();
    Main.bgImage.anchor.set(0.5, 0.5);
    Main.stage.addChild(Main.bgImage);


    Main.playLayer = new PIXI.Sprite();
    Main.playLayer.anchor.set(0.5, 0.5);
    Main.stage.addChild(Main.playLayer);


    Main.rightBottomUI = new PIXI.Sprite();
    Main.rightBottomUI.anchor.set(1, 0);
    Main.stage.addChild(Main.rightBottomUI);


    Main.leftBottomUI = new PIXI.Sprite();
    Main.leftBottomUI.anchor.set(0, 1);
    Main.stage.addChild(Main.leftBottomUI);


    Main.leftTopUI = new PIXI.Sprite();
    Main.leftTopUI.anchor.set(0, 0);
    Main.stage.addChild(Main.leftTopUI);


    Main.rightTopUI = new PIXI.Sprite();
    Main.rightTopUI.anchor.set(1, 0);
    Main.stage.addChild(Main.rightTopUI);


    Main.largeUI = new PIXI.Sprite();
    Main.largeUI.anchor.set(0.5, 0.5);
    Main.stage.addChild(Main.largeUI);


    Main.fullUI = new PIXI.Sprite();
    Main.fullUI.anchor.set(0.5, 0.5);
    Main.stage.addChild(Main.fullUI);
    

    EventHandlers.resizeEvent();


    EventHandlers.pixiListeners(Main.app.renderer);


    Main.nowTime = Date.now();
    Main.time = 0;


    this.gameControl = new GameControl();
    this.gameControl.create();
}


Main.prototype.playGame = function ()
{
    if (Main.debug)
        console.log("starting game loop");


    var stats = null;
    if (Main.showFPS)
    {
        stats = new Stats();
        stats.showPanel(0);
        document.body.appendChild(stats.dom);
    }

    var _this = this;


    var ticker = PIXI.ticker.shared;
    ticker.autoStart = false;
    ticker.stop();
    ticker = PIXI.ticker;
    ticker.autoStart = false;


    var inLoop = false;
    var onLoop = function ()
    {
        if (window.fonts_ready)
        {
		
            if (!Main.app)
            {
                _this.createPixi();
            }

            if ( !inLoop )
            {
                inLoop = true;


                Main._lastTime = Main.nowTime;
                Main.nowTime = Date.now();

                Main.elapsedTime = Math.min(Main.nowTime - Main._lastTime, 50);

                if (!Game.paused)
                {

                    Main.time += Main.elapsedTime;
                }


                requestAnimationFrame(onLoop);


                if (stats) stats.begin();


                if ( Main.resized )
                {

                    if ( Main.nowTime - Main.resizeTime > 250 )
                    {
                        _this.resize();
                        Main.resized = false;
                    }
                }


                _this.gameControl.update();


                if (Main.forceResize)
                {
                    if (Main.debug)
                        console.log("Main.forceResize");
                    _this.resize();
                    Main.forceResize = false;
                }


                if (stats) stats.end();
                inLoop = false;
            }
            else
            {

                requestAnimationFrame(onLoop);
            }
        }
        else
        {

            requestAnimationFrame(onLoop);
        }
    };

    requestAnimationFrame(onLoop);
}


Main.prototype.resize = function()
{
    EventHandlers.resizeContent();
    if (this.gameControl) this.gameControl.resize();


    window.scrollTo(0, 0);
}


Main.createTextStyles = function (_dataManager)
{
    var ts = _dataManager.get("text_styles");
    Main.textStyleVersionTiny = Main.wrapTextStyle(ts.textStyleVersionTiny);
    Main.textStyleTimer = Main.wrapTextStyle(ts.textStyleTimer);
}


Main.wrapTextStyle = function (_style)
{
    var ts = new PIXI.TextStyle();
    Utils.setValuesFromObject(ts, _style);
    return ts;
}



Main.checkAudio = function()
{
    function isStock()
    {
        var matches = window.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/);
        return matches && parseFloat(matches[1]) < 537;
    }

    var ua = window.navigator.userAgent;                            
    var isSharpStock = ((/SHL24|SH-01F/i).test(ua)) && isStock();  
    var isXperiaAStock = ((/SO-04E/i).test(ua)) && isStock();     
    var isFujitsuStock = ((/F-01F/i).test(ua)) && isStock();     


    return (!isSharpStock && !isXperiaAStock && !isFujitsuStock && ((typeof window.AudioContext !== 'undefined') || (typeof window.webkitAudioContext !== 'undefined') || ua.indexOf('Android') == -1));
}


Main.detectIE = function()
{
    var ua = window.navigator.userAgent;


    var msie = ua.indexOf('MSIE ');
    if (msie > 0) {

        return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
    }

    var trident = ua.indexOf('Trident/');
    if (trident > 0) {

        var rv = ua.indexOf('rv:');
        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
    }

    var edge = ua.indexOf('Edge/');
    if (edge > 0) {
  
        return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
    }


    return false;
}



Main.render = function ()
{

    Main.app.renderer.render(Main.stage);


    EventHandlers.checkDimensions( false );
}


Main.resetInput = function ()
{
    EventHandlers.resetInput();
    Main.click = null;
    Main.hover = null;
    Main.mouseDown = null;
    Main.mouseUp = null;
    Main.swipe = 0;
}


Main.getFocus = function ()
{
    if (Main.app && Main.app.view)
    {
        if (Main.debugSpam)
            console.log("Main.getFocus - grab keyboard focus");


        Main.app.view.setAttribute("tabindex", "-1");
        Main.app.view.focus();
    }
    Keys.create();
}



function Preloader(_baseUrl){this.root=null;this.textureManager=null;this.dataManager=null;this.audioManager=null;this.lowResolution=false;this.totalFileCount=0;this.introAnimationFinished=false;this.loadingBarAnimationFinished=false;this.lastPcent=0;this.baseUrl=_baseUrl;this.titleName="en.png"}Preloader.prototype.preload=function(_root,_lowResolution){this.root=_root;this.lowResolution=_lowResolution;this.textureManager=new Textures;this.textureManager.create();this.dataManager=new DataManager;this.dataManager.create();this.audioManager=new AudioManager;this.audioManager.create(this.getManagers());if(!Main.testLanguage){var _this=this;this.dataManager.loadData("language",this.baseUrl+"json/lang.json",function(){var json=_this.dataManager.get("language");if(json&&json["lang"]){Main.languageCode=json["lang"];_this.titleName=Main.languageCode+".png"}})}this.textureManager.addImage("empty_square",this.baseUrl+"images/_reduced/assets/empty.png");this.textureManager.addImage("preloader_bg",this.baseUrl+"images/_reduced/assets/backgrounds/background1.jpg");this.textureManager.addImage("preloader_bouncer",this.baseUrl+"images/_reduced/assets/game_parts/bouncer.png");this.textureManager.addAtlas("preloader_sprites",this.baseUrl+"images/_reduced/assets/preloader/preloader.json");this.textureManager.startLoading(this.preloaderReady,this)};Preloader.prototype.preloaderReady=function(){var _this=this;Main.rightTopUI.texture=this.textureManager.get("empty_square");Main.leftBottomUI.texture=this.textureManager.get("empty_square");this.bg=new Sprite;this.bg.create(Main.bgImage,"preloader_bg",this.textureManager);this.bg.anchor.set(.5,1);this.bg.y=this.bg.height/2;this.bgLogo=new Sprite;this.bgLogo.create(this.bg,"logo",this.textureManager);this.bgLogo.anchor.set(.5);this.bgLogo.x=0;this.bgLogo.y=-484;if(Main.aspectRatio>2){this.bg.y-=100}this.bgCover=new Sprite;this.bgCover.create(this.bg,"background_cover",this.textureManager);this.bgCover.anchor.set(.5,1);this.bgCover.x=0;this.bgCover.y=0;this.bgBouncer=new Sprite;this.bgBouncer.create(this.bg,"preloader_bouncer",this.textureManager);this.bgBouncer.anchor.set(.5);this.bgBouncer.x=0;this.bgBouncer.y=-this.bg.height-this.bgBouncer.height/2;var _that=this;new TWEEN.Tween(this.bgBouncer).to({y:this.bgLogo.y-this.bgBouncer.height/2},800).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){new TWEEN.Tween(_that.bgBouncer).to({y:_that.bgBouncer.y+34},200).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);new TWEEN.Tween(_that.bgLogo).to({y:_that.bgLogo.y+34},200).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){new TWEEN.Tween(_that.bgBouncer).to({y:_that.bgBouncer.y-34},200).easing(TWEEN.Easing.Quadratic.In).onComplete(function(){new TWEEN.Tween(_that.bgBouncer).to({y:-_that.bg.height-_that.bgBouncer.height/2},800).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){_that.bgBouncer.visible=false;_that.introAnimationFinished=true}).start(Main.time)}).start(Main.time);new TWEEN.Tween(_that.bgLogo).to({y:_that.bgLogo.y-34},200).easing(TWEEN.Easing.Quadratic.In).start(Main.time)}).start(Main.time)}).start(Main.time);this.loadBg=new Sprite;this.loadBg.create(this.bg,"loader_under",this.textureManager,0,200,false);this.loadBg.anchor.set(.5);this.loadBg.y=this.bgLogo.y+this.bgLogo.height*.8;this.loadBar=new Sprite;this.loadBar.create(this.bg,"loader_over",this.textureManager,-330,200,false);this.loadBar.anchor.set(0,.5);this.loadBar.x=-this.loadBar.width/2;this.loadBar.fullWidth=this.loadBar._texture.width;this.loadBar._texture.width=10;this.loadBar.y=this.loadBg.y;if(Main.aspectRatio<.43){this.loadBg.scale.set(this.loadBg.scale.x*.8);this.loadBar.scale.set(this.loadBar.scale.x*.8);this.loadBar.x=-this.loadBar.width/2}var imageAssetPath=this.baseUrl+"images/_reduced/assets/";this.textureManager.addImage("game_title_bg",imageAssetPath+"backgrounds/background3.jpg");this.textureManager.addImage("game_title_logo",imageAssetPath+"game_parts/show_logo.png");if(Main.testLanguage&&typeof URLSearchParams!=="undefined"){var urlParams=new URLSearchParams(window.location.search);if(urlParams.has("lang")){Main.languageCode=urlParams.get("lang");this.titleName=Main.languageCode+".png"}}this.textureManager.addImage("game_title",imageAssetPath+"titles/"+this.titleName);Preloader.spriteNames=["0000","0001","0002","0003","0004","0005","0006","0007","0008","0009","0010","0011","0012","0013","0014","0015","0016","0017","0018","0019","0020","0021","0022","0023","0024","0025"];this.textureManager.addAtlas("item_sprites1",imageAssetPath+"game_parts/char_assets.json");this.textureManager.addAtlas("ui_sprites",imageAssetPath+"UI assets/ui_assets.json");this.textureManager.addImage("blanker",imageAssetPath+"blanker.png");this.textureManager.addImage("blanker_white",imageAssetPath+"white.png");this.textureManager.addImage("game_bg_1",imageAssetPath+"backgrounds/background0.jpg");this.textureManager.addImage("game_bg_2",imageAssetPath+"backgrounds/background1.jpg");this.textureManager.addImage("game_bg_3",imageAssetPath+"backgrounds/background2.jpg");this.textureManager.addImage("game_bg_4",imageAssetPath+"backgrounds/background3.jpg");this.textureManager.addImage("game_bg_5",imageAssetPath+"backgrounds/background4.jpg");this.textureManager.startLoading();this.loadAudioAssets();this.dataManager.loadData("text_styles",this.baseUrl+"json/text_styles.json",function(){Main.createTextStyles(_this.dataManager)});this.dataManager.loadData("fonts",this.baseUrl+"json/text.json");this.totalFileCount=this.textureManager.pending+this.dataManager.pending+this.audioManager.pending};Preloader.prototype.loadAudioAssets=function(){this.audioManager.loadAudio("game_tune",this.baseUrl+"audio/music/music",["m4a","ogg","mp3"]);this.audioManager.loadSoundSprite("sound_sprite",this.baseUrl+"audio/audiosprite/audiosprite",["m4a","mp3","ogg","ac3"],{sprite:{children_cheers_01:[0,3320.453514739229],children_cheers_02:[5e3,3529.4331065759634],children_cheers_03:[1e4,4133.1519274376415],correct_match:[16e3,2782.312925170068],game_over:[2e4,1428.3446712018133],game_start:[23e3,2191.746031746032],incorrect_match:[27e3,2295.238095238094],level_up:[31e3,1216.1451247165544],timer_beep:[34e3,45.30612244897725],ui_button:[36e3,1111.6099773242638]}})};Preloader.prototype.cleanUp=function(){this.root=null;if(this.loadBg){this.loadBg.destroy();this.loadBg=null}if(this.loadBar){this.loadBar.destroy();this.loadBar=null}if(this.bg){this.bg.destroy();this.bg=null}if(this.bgLogo){this.bgLogo.destroy();this.bgLogo=null}if(this.bgCover){this.bgCover.destroy();this.bgCover=null}if(this.bgBouncer){this.bgBouncer.destroy();this.bgBouncer=null}};Preloader.prototype.update=function(){if(this.loadBar&&this.totalFileCount>0){var pcent=1-(this.textureManager.pending+this.dataManager.pending+this.audioManager.pending)/this.totalFileCount;if(pcent>this.lastPcent+.1)pcent=this.lastPcent+.1;this.lastPcent=pcent;var texture=PIXI.Texture.fromImage("loader_over");var texture2=new PIXI.Texture(texture,new PIXI.Rectangle(texture.frame.x,texture.frame.y,texture.frame.width*Math.min(pcent,1),texture.frame.height));this.loadBar.texture=texture2;if(pcent>=1)this.loadingBarAnimationFinished=true}};Preloader.prototype.allLoaded=function(){var done=this.textureManager.pending===0&&this.dataManager.pending===0&&this.audioManager.pending===0&&this.introAnimationFinished&&this.loadingBarAnimationFinished;if(done){this.cleanUp();return true}return false};Preloader.prototype.getManagers=function(){return{preloader:this,textures:this.textureManager,data:this.dataManager,audio:this.audioManager}};function Titles(){this.bg=null;this.sprites=null;this.buttons=null;this.fader=null;this.managers=null;this.fallingPieces=null;this.startButton=null;this.startButtonHighlight=null;this.stripTop=null;this.stripBottom=null;this.exitWhenReady=false}Titles.ready=false;Titles.prototype.applyOrientationParams=function(){this.shinyGlowSprite.y=this.startButtonY;this.startButton.y=this.startButtonY;this.startButtonHighlight.y=this.startButtonY;this.gameTitleLogo.y=this.gameTitleY-this.titleGap;this.gameTitleSprite.y=this.gameTitleY;this.gameTitleSprite.scale.set(this.showTitleScale);this.showLogoScale*=.9;this.gameTitleLogo.scale.set(this.showLogoScale);this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.stripTop.x=Main.width/2/Main.leftTopUI.scale.x;this.stripBottom.width=Main.width/Main.leftBottomUI.scale.x;this.stripBottom.x=Main.width/2/Main.leftBottomUI.scale.x};Titles.prototype.setOrientationParams=function(){this.gameTitleY=-100;this.characterScale=1;this.startButtonScale=1;if(Main.aspectRatio>=1&&Main.aspectRatio<1.15){this.gameTitleY=-150;this.startButtonY=340;this.showLogoScale=1;this.showTitleScale=1.2;this.titleGap=300}else if(Main.isPortrait){this.gameTitleY=-250;this.startButtonY=550;if(Main.aspectRatio<.5){this.showLogoScale=.85;this.showTitleScale=.6;this.titleGap=200;this.startButtonScale=1.5;this.characterScale=1.5}else if(Main.aspectRatio<.65){this.showLogoScale=.9;this.showTitleScale=.7;this.titleGap=220;this.startButtonScale=1.4;this.characterScale=1.5}else if(Main.aspectRatio<.83){this.showLogoScale=1;this.showTitleScale=.88;this.titleGap=260;this.startButtonY=400;this.startButtonScale=1.3;this.characterScale=1.3}else{this.showLogoScale=1;this.showTitleScale=1.1;this.titleGap=280;this.startButtonY=400;this.startButtonScale=1.1;this.characterScale=1.2}}else{this.startButtonScale=1;if(Main.aspectRatio>=2.59){this.showLogoScale=.65;this.showTitleScale=.75;this.gameTitleY=0;this.startButtonScale=1.25;this.startButtonY=420;this.titleGap=180;this.characterScale=1.6}else if(Main.aspectRatio>=2.31){this.showLogoScale=.7;this.showTitleScale=.85;this.gameTitleY=-20;this.startButtonScale=1.25;this.startButtonY=400;this.titleGap=190;this.characterScale=1.6}else if(Main.aspectRatio>=2){this.showLogoScale=.7;this.showTitleScale=.85;this.gameTitleY=-30;this.startButtonScale=1.2;this.startButtonY=390;this.titleGap=200;this.characterScale=1.6}else if(Main.aspectRatio>=1.8){this.showLogoScale=.75;this.showTitleScale=.95;this.gameTitleY=-50;this.startButtonY=370;this.startButtonScale=1.1;this.titleGap=220;this.characterScale=1.4}else if(Main.aspectRatio>1.6){this.showLogoScale=.8;this.showTitleScale=1;this.gameTitleY=-70;this.startButtonY=330;this.titleGap=240;this.characterScale=1.3}else if(Main.aspectRatio>1.4){this.showLogoScale=.9;this.showTitleScale=1.1;this.gameTitleY=-70;this.startButtonY=330;this.titleGap=270;this.characterScale=1.3}else if(Main.aspectRatio>1.25){this.showLogoScale=1;this.showTitleScale=1.2;this.gameTitleY=-100;this.startButtonY=330;this.titleGap=290;this.characterScale=1.2}else{this.showLogoScale=1;this.showTitleScale=1.2;this.gameTitleY=-130;this.titleGap=300;this.startButtonY=350;this.characterScale=1.2}}this.titleGap*=.8};Titles.prototype.create=function(_preloader){Titles.ready=false;this.exitWhenReady=false;this.rememberOrientation=Main.isPortrait;this.preloader=_preloader;this.managers=this.preloader.getManagers();this.bg=new Sprite;this.bg.create(Main.bgImage,"game_title_bg",this.managers.textures);this.bg.anchor.set(.5);this.bg.scale.set(Main.gameWide/this.bg.width);this.bgScale=Sprite.getGlobalScale(this.bg);this.setOrientationParams();this.stripTop=new Sprite(.5,.5);this.stripTop.create(Main.leftTopUI,"bar3",this.managers.textures,Main.width/2/Main.leftTopUI.scale.x,-190);this.stripTop.width=Main.width/Main.leftTopUI.scale.x;this.stripBottom=new Sprite(.5,.5);this.stripBottom.create(Main.leftBottomUI,"bar3",this.managers.textures,Main.width/2/Main.leftBottomUI.scale.x,190);this.stripBottom.width=Main.width/Main.leftBottomUI.scale.x;var btnStartY=Main.height/2/this.bgScale.y;this.sprites=[];this.buttons=[];this.shinyGlowSprite=new Sprite(.5,.5);this.shinyGlowSprite.create(Main.fullUI,"flare",this.managers.textures,0,btnStartY);this.shinyGlowSprite.visible=true;this.sprites.push(this.shinyGlowSprite);this.startButton=new Button(Button.TYPE_BUTTON,.5,.5);this.startButton.create(Main.fullUI,"play_button",this.managers,0,btnStartY,false,"play_button","play_button_hover","play_button_hover","click_start");this.startButton.sfx="ui_button";var _that=this;this.startButton.callbackHover=function(_btn){_that.shinyGlowSprite.rotation+=.025;_that.shinyGlowSprite.scale.set((Math.sin(Main.nowTime*.003)+1)/2*.25+1.75)};this.buttons.push(this.startButton);this.startButtonHighlight=new Sprite(.5,.5);this.startButtonHighlight.create(Main.fullUI,"play_button_hover",this.managers.textures,0,btnStartY);this.sprites.push(this.startButtonHighlight);this.gameTitleSprite=new Sprite(.5,.5);this.gameTitleSprite.create(Main.largeUI,"game_title",this.managers.textures,0,-(Main.height/2)/this.bgScale.y);this.sprites.push(this.gameTitleSprite);this.gameTitleLogo=new Sprite(.5,.5);this.gameTitleLogo.create(Main.largeUI,"game_title_logo",this.managers.textures,0,-(Main.height/2)/this.bgScale.y-this.titleGap);this.sprites.push(this.gameTitleLogo);if(Main.showMuteButton){this.muteButton=new Button(Button.TYPE_BUTTON,.5,.5);this.muteButton.create(Main.leftTopUI,"mute_button_unmute",this.managers,90,-190,false,"mute_button_unmute","mute_button_unmute_hover","mute_button_unmute_hover","click_mute",null,"mute_button_muted","mute_button_muted_hover","mute_button_muted_hover","click_unmute",null);this.muteButton.scale.set(1.2);this.muteButton.sfx="ui_button";this.muteButton.toggled=!this.managers.audio.mute;this.buttons.push(this.muteButton)}else{this.muteButton=null}this.logoSprite=new Sprite(.5,.5);this.logoSprite.create(Main.leftBottomUI,"logo",this.managers.textures,110,190);this.sprites.push(this.logoSprite);new TWEEN.Tween(this.shinyGlowSprite).to({y:this.startButtonY},900).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);new TWEEN.Tween(this.startButton).to({y:this.startButtonY},900).easing(TWEEN.Easing.Quadratic.Out).onComplete(function(){Titles.ready=true}).start(Main.time);new TWEEN.Tween(this.startButtonHighlight).to({y:this.startButtonY},900).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);new TWEEN.Tween(this.stripTop).to({y:90},500).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);new TWEEN.Tween(this.stripBottom).to({y:-90},500).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);if(this.muteButton){new TWEEN.Tween(this.muteButton).to({y:90},700).easing(TWEEN.Easing.Quadratic.Out).start(Main.time)}new TWEEN.Tween(this.logoSprite).to({y:-90},700).easing(TWEEN.Easing.Quadratic.Out).start(Main.time);var _that=this;this.gameTitleLogo.tween=new TWEEN.Tween(this.gameTitleLogo).to({y:0-this.titleGap},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time).onComplete(function(){_that.gameTitleLogo.tween=new TWEEN.Tween(_that.gameTitleLogo).to({y:_that.gameTitleY-_that.titleGap},800).easing(TWEEN.Easing.Quadratic.InOut).start(Main.time)});this.gameTitleSprite.tween=new TWEEN.Tween(this.gameTitleSprite).to({y:0},800).easing(TWEEN.Easing.Quadratic.Out).start(Main.time).onComplete(function(){_that.gameTitleSprite.tween=new TWEEN.Tween(_that.gameTitleSprite).to({y:_that.gameTitleY},600).easing(TWEEN.Easing.Quadratic.InOut).start(Main.time)});this.fallingPieces=[];for(var i=0;i<15;i++){var s=new Sprite;s.create(this.bg,Utils.pickRandomFromList(Preloader.spriteNames),this.managers.textures,Math.random()*this.bg.width-this.bg.width/2,this.bg.height/2-Math.random()*this.bg.height*3,false);s.rotation=Math.random()*Math.PI*2;s.vr=(Math.random()-.5)*.025;s.scale.set(.75);s.anchor.set(.5);this.fallingPieces[i]=s}this.gameTitleSprite.moveToFront();this.gameTitleLogo.moveToFront();Main.forceResize=true;var whiteBlank=Utils.addBlanker(this.managers.textures,"blanker_white");new TWEEN.Tween(whiteBlank).to({alpha:0},600).onComplete(function(){Utils.removeBlanker()}).start(Main.time);EventHandlers.registerCallback("mousedown",this.startTune,{context:this});this.fader=new FadeState;this.fader.setFade(.1);this.resize()};Titles.prototype.startTune=function(){EventHandlers.clearCallback("mousedown",this.startTune);if(this.managers&&this.managers.audio){if(!this.managers.audio.sfxLoaded()){console.log("retry loadAudioAssets from input gesture");this.preloader.loadAudioAssets()}this.managers.audio.startTune("game_tune")}};Titles.prototype.destroy=function(){var i;Main.forceResize=true;if(this.stripTop){this.stripTop.destroy();this.stripTop=null}if(this.stripBottom){this.stripBottom.destroy();this.stripBottom=null}if(this.version){this.version.destroy();this.version=null}if(this.fallingPieces){for(i=0;i<this.fallingPieces.length;i++)this.fallingPieces[i].destroy();this.fallingPieces=null}if(this.sprites){for(i=0;i<this.sprites.length;i++)this.sprites[i].destroy();this.sprites=null}if(this.buttons){for(i=0;i<this.buttons.length;i++)this.buttons[i].destroy();this.buttons=null}if(this.fader){this.fader.destroy();this.fader=null}if(this.bg){this.bg.destroy();this.bg=null}this.managers=null};Titles.prototype.update=function(){var i;var event="";this.gameTitleSprite.scale.set(this.showTitleScale);this.gameTitleLogo.scale.set(this.showLogoScale);this.fader.fading();if(this.startButtonHighlight){this.startButtonHighlight.alpha=(Math.sin(Main.nowTime*.004)+1)*.5}if(this.shinyGlowSprite){this.shinyGlowSprite.rotation+=.0125;this.shinyGlowSprite.scale.set((Math.sin(Main.nowTime*.003)+1)/2*.25+1.25)}if(this.startButton){var sx=(Math.sin(Main.nowTime*.01)+1)*.5*.07+.93*this.startButtonScale;var sy=(Math.sin(Main.nowTime*.01+Math.PI)+1)*.5*.07+.93*this.startButtonScale;this.startButton.scale.set(sx,sy);if(this.startButtonHighlight)this.startButtonHighlight.scale.set(sx,sy)}this.bg.alpha=this.fader.fadeValue;this.bg.update();if(this.fallingPieces){for(i=0;i<this.fallingPieces.length;i++){var s=this.fallingPieces[i];s.y+=3;s.rotation+=s.vr;if(s.rotation<-Math.PI)s.rotation+=Math.PI*2;if(s.rotation>=Math.PI)s.rotation-=Math.PI*2;if(s.y>this.bg.height*.6){s.x=Math.random()*this.bg.width-this.bg.width/2;s.y=-this.bg.height*.6-Math.random()*this.bg.height*.25;s.rotation=Math.random()*Math.PI*2;s.vr=(Math.random()-.5)*.05}}}if(this.sprites){for(i=0;i<this.sprites.length;i++)this.sprites[i].update()}if(this.buttons){for(i=0;i<this.buttons.length;i++){var b=this.buttons[i];event=b.update();if(event!==null)break}}if(this.version){this.version.update()}if(Keys.isPressed[KeyCodes.space_bar]||this.exitWhenReady){event="click_start"}



switch(event){case"click_start":Main.hover=null;Main.click=null;Keys.reset(32);this.exitWhenReady=true;if(this.fader.reached(1)&&Titles.ready){this.exitWhenReady=false;TWEEN.removeAll();Utils.removeBlanker();this.startButton.enabled=false;Utils.addBlanker(this.managers.textures,"blanker_white");return false}break;case"click_mute":this.muteButton.toggled=false;this.managers.audio.setMute(true,false);this.managers.audio.muteTunes(true,false);break;case"click_unmute":this.muteButton.toggled=true;this.managers.audio.setMute(false,false);this.managers.audio.muteTunes(false,false);break}return true};Titles.prototype.resize=function(){this.rememberOrientation=Main.isPortrait;this.setOrientationParams();this.applyOrientationParams()};function EventHandlers(){EventHandlers.swipeDistance=160;EventHandlers.swipeMaxtime=800;EventHandlers.clickTime=200;EventHandlers.touchEvent=false;EventHandlers._mouseDownWhen=0;EventHandlers._mouseSwipeStart=null;EventHandlers.callbackList=null;EventHandlers._showDebugWindowData=0;EventHandlers._debugText=null;EventHandlers._handledDownTime=-1;window.addEventListener("resize",EventHandlers.resizeEvent,false);window.addEventListener("orientationchange",EventHandlers.orientationEvent,false)}EventHandlers.resetInput=function(){EventHandlers._mouseDownWhen=0;EventHandlers._mouseSwipeStart=null};EventHandlers.pixiListeners=function(_pixi){_pixi.plugins.interaction.on("mousedown",EventHandlers.mouseDownHandler);_pixi.plugins.interaction.on("mouseup",EventHandlers.mouseUpHandler);_pixi.plugins.interaction.on("mousemove",EventHandlers.mouseMoveHandler);_pixi.plugins.interaction.on("mouseout",EventHandlers.mouseOutHandler);_pixi.plugins.interaction.on("touchstart",EventHandlers.touchDownHandler);_pixi.plugins.interaction.on("touchmove",EventHandlers.touchMoveHandler);_pixi.plugins.interaction.on("touchend",EventHandlers.touchUpHandler);if(Main.isIE){_pixi.plugins.interaction.on("pointerdown",EventHandlers.touchDownHandler);_pixi.plugins.interaction.on("pointermove",EventHandlers.touchMoveHandler);_pixi.plugins.interaction.on("pointerup",EventHandlers.touchUpHandler);_pixi.plugins.interaction.on("pointercancel",EventHandlers.touchUpHandler)}};EventHandlers.mouseToStage=function(_x,_y){return{x:_x,y:_y}};EventHandlers.inputClickHandler=function(_evt){Main.mouseUpEvent=_evt;Main.click=EventHandlers.mouseToStage(_evt.data.global.x,_evt.data.global.y);Main.mouseMoveLocal=_evt.data.getLocalPosition(Main.playLayer);Main.mouseUpLocal=_evt.data.getLocalPosition(Main.playLayer)};EventHandlers.inputSwipeHandler=function(_evt){if(Math.abs(_evt.deltaX)>Math.abs(_evt.deltaY)){if(Math.abs(_evt.deltaX)>=20){Main.swipe=_evt.deltaX}else{Main.swipe=0}}};EventHandlers.mouseOutHandler=function(){Main.mouseOut=true;Main.mouseDown=null};EventHandlers.mouseMoveHandler=function(_evt){EventHandlers.touchEvent=false;return EventHandlers.touchMoveHandler(_evt)};EventHandlers.touchMoveHandler=function(_evt){if(Main.mouseOut)Main.mouseOut=false;Main.hoverEvent=_evt;Main.hover=EventHandlers.mouseToStage(_evt.data.global.x,_evt.data.global.y);Main.mouseMoveLocal=_evt.data.getLocalPosition(Main.playLayer);if(EventHandlers._mouseSwipeStart&&Main.swipeEnabled){if(Utils.distanceBetween(EventHandlers._mouseSwipeStart,Main.hover)>=EventHandlers.swipeDistance){if(Main.nowTime-EventHandlers._mouseDownWhen<EventHandlers.swipeMaxtime){EventHandlers.inputSwipeHandler({deltaX:Main.hover.x-EventHandlers._mouseSwipeStart.x,deltaY:Main.hover.y-EventHandlers._mouseSwipeStart.y});EventHandlers._mouseDownWhen=0;Main.mouseDown=null}}}};EventHandlers.touchDownHandler=function(_evt){EventHandlers.touchEvent=true;EventHandlers.mouseDownHandler(_evt);Main.mouseMoveLocal=Main.mouseDownLocal};EventHandlers.mouseDownHandler=function(_evt){if(Main.nowTime==EventHandlers._handledDownTime)return;EventHandlers._handledDownTime=Main.nowTime;if(EventHandlers._showDebugWindowData){if(EventHandlers._showDebugWindowData<Main.nowTime){EventHandlers._debugText.destroy();EventHandlers._debugText=null;EventHandlers._showDebugWindowData=0}}EventHandlers._mouseDownWhen=Main.nowTime;Main.mouseDown=EventHandlers.mouseToStage(_evt.data.global.x,_evt.data.global.y);Main.mouseDownLocal=_evt.data.getLocalPosition(Main.playLayer);if(!EventHandlers._mouseSwipeStart&&Main.swipeEnabled){EventHandlers._mouseSwipeStart=EventHandlers.mouseToStage(_evt.data.global.x,_evt.data.global.y)}EventHandlers.triggerCallback("mousedown",Main.mouseDown.x,Main.mouseDown.y)};EventHandlers.touchUpHandler=function(_evt){EventHandlers.touchEvent=true;if(Main.mouseDown){EventHandlers.mouseUpHandler(_evt);Main.mouseMoveLocal=Main.mouseUpLocal}};EventHandlers.mouseUpHandler=function(_evt){if(Main.mouseDown){Main.mouseUpEvent=_evt;var dragDistance=0;if(Main.mouseUp&&Main.mouseDown){dragDistance=Utils.distanceBetween(Main.mouseUp,Main.mouseDown)}if(Main.mouseDown){if(!Main.swipeEnabled||dragDistance<EventHandlers.swipeDistance&&(!EventHandlers._mouseDownWhen||Main.nowTime-EventHandlers._mouseDownWhen<EventHandlers.clickTime)){EventHandlers.inputClickHandler(_evt)}else{Main.mouseUp=EventHandlers.mouseToStage(_evt.data.global.x,_evt.data.global.y);Main.mouseUpLocal=_evt.data.getLocalPosition(Main.playLayer);if(Main.mouseUp&&Main.mouseDown){if(dragDistance>=EventHandlers.swipeDistance)EventHandlers.inputSwipeHandler({deltaX:Main.mouseUp.x-Main.mouseDown.x,deltaY:Main.mouseUp.y-Main.mouseDown.y})}}}EventHandlers._mouseDownWhen=0;Main.mouseDown=null;Main.mouseDownLocal=null;EventHandlers._mouseSwipeStart=null}};EventHandlers.resizeEvent=function(){if(Main.debugSpam)console.log("resize event");EventHandlers.checkDimensions(true)};EventHandlers.orientationEvent=function(){if(Main.debugSpam)console.log("orientation event");EventHandlers.checkDimensions(true)};EventHandlers.checkDimensions=function(_eventTriggered){if(Main.resized)return;if(_eventTriggered){Main.resized=true;Main.resizeTime=Main.nowTime;console.log("screen dimensions have changed from "+Main.width+"x"+Main.height)}else{if(Main.width!=window.innerWidth||Main.height!=window.innerHeight){Main.resized=true;Main.resizeTime=Main.nowTime;console.log("screen dimensions have changed from "+Main.width+"x"+Main.height)}}};EventHandlers.resizeContent=function(){Main.width=window.innerWidth;Main.height=window.innerHeight;Main.aspectRatio=Main.width/Main.height;if(Main.debug)console.log("resizeContent to "+Main.width+"x"+Main.height+". aspectRatio is "+Main.aspectRatio);Main.isPortrait=Main.height>=Main.width;Main.lowResolutionAssets=Math.max(Main.width,Main.height)<640||Math.min(Main.width,Main.height)<480;Main.aspectRatio=Main.width/Main.height;Main.isPortrait=Main.height>=Main.width;Main.lowResolutionAssets=Math.max(Main.width,Main.height)<640||Math.min(Main.width,Main.height)<480;Main.app.renderer.resize(Main.width,Main.height);Main.stage.x=Math.round(Main.width/2);Main.stage.y=Math.round(Main.height/2);var sx=Main.width/Main.gameWide;var sy=Main.height/Main.gameHigh;var bgScale=Math.max(sx,sy);Main.bgImage.scale.set(bgScale);Main.playLayer.scale.set(bgScale);Main.largeUI.scale.set(bgScale);var uiScale=Math.min(sx,sy);Main.leftBottomUI.scale.set(uiScale);Main.leftBottomUI.x=-Main.width/2;Main.leftBottomUI.y=Main.height/2;Main.rightBottomUI.scale.set(uiScale);Main.rightBottomUI.x=Main.width/2;Main.rightBottomUI.y=Main.height/2;Main.leftTopUI.scale.set(uiScale);Main.leftTopUI.x=-Main.width/2;Main.leftTopUI.y=-Main.height/2;Main.rightTopUI.scale.set(uiScale);Main.rightTopUI.x=Main.width/2;Main.rightTopUI.y=-Main.height/2;Main.fullUI.scale.set(uiScale);if(Main.debugSpam){console.log("aspectRatio:",Main.aspectRatio,Main.isPortrait?"portrait":"landscape");console.log("doc window.inner:   ",window.innerWidth,"x",window.innerHeight);console.log("Resolution: ",Main.lowResolutionAssets?"low":"high");console.log("View ratio: ",sx,":",sy);console.log("stage offset: ",Main.stage.x,",",Main.stage.y,"\n")}};EventHandlers.registerCallback=function(_event,_callback,_arg){if(Main.debugSpam)console.log("registerCallback for",_event);if(!EventHandlers.callbackList)EventHandlers.callbackList=[];EventHandlers.callbackList.push({event:_event,callback:_callback,arg:_arg})};EventHandlers.triggerCallback=function(_event,_x,_y){if(!EventHandlers.callbackList)return;for(var i=EventHandlers.callbackList.length-1;i>=0;--i){var e=EventHandlers.callbackList[i];if(e.event==_event){if(Main.debugSpam)console.log("triggerCallback for",_event);e.callback.call(e.arg.context,_x,_y,e.arg.args)}}};EventHandlers.clearCallback=function(_event,_callback){if(!EventHandlers.callbackList)return;for(var i=EventHandlers.callbackList.length-1;i>=0;--i){var e=EventHandlers.callbackList[i];if(e.event==_event&&e.callback==_callback){EventHandlers.callbackList.splice(i,1);if(Main.debugSpam)console.log("clearCallback for",_event);break}}if(EventHandlers.callbackList.length===0)EventHandlers.callbackList=null};EventHandlers.clearCallbacks=function(){EventHandlers.callbackList=null};EventHandlers.debugWindowData=function(){if(!EventHandlers._showDebugWindowData){var sx=Main.width/Main.gameWide;var sy=Main.height/Main.gameHigh;var s="aspectRatio: "+Main.aspectRatio+" "+(Main.isPortrait>=1?"portrait":"landscape")+"\n";s+="devicePixelRatio: "+window.devicePixelRatio+"\n";s+="window.inner: "+window.innerWidth+" x "+window.innerHeight+"\n";s+="resolution: "+(Main.lowResolutionAssets?"low":"high")+"\n";s+="view ratio: "+sx+" : "+sy;var t=new Text(s,Main.textStyleMediumTiny);t.create(Main.topUI,-.5+.05,.25,true);t.anchor.y=1;EventHandlers._debugText=t;EventHandlers._showDebugWindowData=Main.nowTime+5e3}};var Keys={};Keys.isIgnored=null;Keys.isPressed=null;Keys.edgeDown=null;Keys.edgeUp=null;Keys.debug=false;Keys.create=function(_debug){Keys.debug=_debug||false;Keys.reset();if(document.body&&document.body.addEventListener)document.body.addEventListener("keydown",Keys.keyDown,true);else if(document.addEventListener)document.addEventListener("keydown",Keys.keyDown,true);else if(window.addEventListener)window.addEventListener("keydown",Keys.keyDown,true);else if(document.attachEvent)document.attachEvent("onkeydown",Keys.keyDown);if(document.body&&document.body.addEventListener)document.body.addEventListener("keyup",Keys.keyUp,true);else if(document.addEventListener)document.addEventListener("keyup",Keys.keyUp,true);else if(window.addEventListener)window.addEventListener("keyup",Keys.keyUp,true);else if(document.attachEvent)document.attachEvent("onkeyup",Keys.keyUp)};Keys.destroy=function(){Keys.isPressed=null;Keys.edgeDown=null;Keys.edgeUp=null};Keys.update=function(){return true};Keys.reset=function(_key){if(_key===undefined){Keys.isPressed=[];Keys.edgeDown=[];Keys.edgeUp=[]}else{Keys.isPressed[_key]=false;Keys.edgeDown[_key]=false;Keys.edgeUp[_key]=false}};Keys.ignoreKey=function(_key){Keys.ignoreKey[_key]=true};Keys.getCode=function(_evt){if(_evt.keyCode!==undefined)return _evt.keyCode;if(_evt.charCode!==undefined)return _evt.charCode;if(_evt.which!==undefined)return _evt.which;if(_evt.key!==undefined)return _evt.key;if(Main.debug)console.log("ERROR: Keys.getCode unable to recognise what the key value is called in this object: ",_evt);return undefined};Keys.keyDown=function(_evt){var code=Keys.getCode(_evt);if(Keys.ignoreKey[code])return;_evt.preventDefault();if(!Keys.isPressed[code]){Keys.edgeDown[code]=true}Keys.isPressed[code]=true};Keys.keyUp=function(_evt){var code=Keys.getCode(_evt);if(Keys.ignoreKey[code])return;_evt.preventDefault();if(Keys.isPressed[code]){Keys.edgeUp[code]=true}Keys.isPressed[code]=false};var KeyCodes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,caps_lock:20,escape:27,space_bar:32,page_up:33,page_down:34,end:35,home:36,left_arrow:37,up_arrow:38,right_arrow:39,down_arrow:40,insert_key:45,delete_key:46,key_0:48,key_1:49,key_2:50,key_3:51,key_4:52,key_5:53,key_6:54,key_7:55,key_8:56,key_9:57,key_a:65,key_b:66,key_c:67,key_d:68,key_e:69,key_f:70,key_g:71,key_h:72,key_i:73,key_j:74,key_k:75,key_l:76,key_m:77,key_n:78,key_o:79,key_p:80,key_q:81,key_r:82,key_s:83,key_t:84,key_u:85,key_v:86,key_w:87,key_x:88,key_y:89,key_z:90,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,numpad_4:100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,decimal_point:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num_lock:144,scroll_lock:145,semi_colon:186,equal_sign:187,comma:188,dash:189,period:190,forward_slash:191,grave_accent:192,open_bracket:219,back_slash:220,close_braket:221,single_quote:222};var Utils={};Math.sgn0=function(a){if(a>0)return 1;if(a<0)return-1;return 0};Utils.shuffleList=function(_list){var currentIndex=_list.length,temporaryValue,randomIndex;while(currentIndex>0){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex--;temporaryValue=_list[currentIndex];_list[currentIndex]=_list[randomIndex];_list[randomIndex]=temporaryValue}return _list};Utils.offsetPoints=function(_dx,_dy,_list){var list=[];if(_list[0].x===undefined){for(var i=0,l=_list.length;i<l;i+=2){list[i]=_list[i]+_dx;list[i+1]=_list[i+1]+_dy}}else{for(var i=0,l=_list.length;i<l;i++){list[i*2]=_list[i].x+_dx;list[i*2+1]=_list[i].y+_dy}}return list};Utils.pickRandomFromList=function(_list,_rndFnc){if(!_rndFnc)_rndFnc=Math.random;if(!_list||_list.length===0)return null;var r=Math.floor(_rndFnc()*_list.length);return _list[r]};Utils.pickRandomsFromList=function(_list,_howMany,_excluding){var l=_list.length;if(_howMany>l){console.warn("Utils.pickRandomsFromList: trying to pick "+_howMany+" from list with only "+l+" elements!");return null}var pickedItems=[];var pickedIndices=[];for(var i=0;i<_howMany;i++){var r;do{r=Math.floor(Math.random()*l)}while(pickedIndices.indexOf(r)!=-1||_excluding&&_excluding.indexOf(_list[r])!=-1);pickedItems.push(_list[r]);pickedIndices.push(r)}return pickedItems};Utils.countInList=function(_list,_item){var c=0;for(var i=0,l=_list.length;i<l;i++)if(_list[i]==_item)c++;return c};Utils.formatBigNumber=function(_value){var s=_value.toString();if(s.length<=3)return s;for(var i=s.length-3;i>0;i-=3)s=s.slice(0,i)+","+s.slice(i);return s};Utils.sign0=function(_value){if(_value>0)return 1;if(_value<0)return-1;return 0};Utils.near=function(_location,_range){return{x:_location.x+Math.random()*2*_range-_range,y:_location.y+Math.random()*2*_range-_range}};Utils.removeFromIndexedList=function(_list,_getAtIndex,_param,_value,_all){if(_list){for(var i=0,l=_list.length;i<l;i++){var listValue=_getAtIndex(_list,i);if(_param&&listValue[_param]==_value||!_param&&listValue==_value){_list.splice(i,1);if(!_all)return _list}}}return _list};Utils.removeFromArray=function(_list,_item){var i=_list.indexOf(_item);if(i==-1)return _list;return _list.splice(i,1)};Utils.whereInGrid2D=function(_object,_grid){for(var gx=0;gx<_grid.length;gx++)for(var gy=0;gy<_grid[gx].length;gy++)if(_grid[gx][gy]==_object)return{x:gx,y:gy};return null};Utils.findPointInList=function(_pnt,_list,_param){if(_list){var pl;for(var i=0,l=_list.length;i<l;i++){if(_param===undefined)pl=_list[i];else pl=_list[i][param];if(pl&&pl.x==_pnt.x&&pl.y==_pnt.y)return i}}return-1};Utils.findNearestPointInList=function(_pnt,_list,_param,_excludeIndex){var min2=Number.POSITIVE_INFINITY;var best=-1;if(_list){var pl;for(var i=0,l=_list.length;i<l;i++){if(i==_excludeIndex)continue;pl=_param===undefined?_list[i]:_list[i][param];if(pl){var dx=pl.x-_pnt.x;var dy=pl.y-_pnt.y;var d2=dx*dx+dy*dy;if(d2<min2){min2=d2;best=i}}}}return best};Utils.weightedPickRandomFromList=function(_list,_weights,_rndFnc){if(!_rndFnc)_rndFnc=Math.random;var total=0,i,l;for(i=0,l=_weights.length;i<l;i++)total+=_weights[i];var r=_rndFnc()*total;var accumulate=0;for(i=0;i<l;i++){accumulate+=_weights[i];if(accumulate>=r)return _list[i]}return _list[l-1]};Utils.normaliseAngle=function(_angle,_fullCircle){if(!_fullCircle)_fullCircle=Math.PI*2;var halfCircle=_fullCircle/2;while(_angle<-halfCircle)_angle+=_fullCircle;while(_angle>=halfCircle)_angle-=_fullCircle;return _angle};Utils.normaliseAnglePositive=function(_angle,_fullCircle){if(!_fullCircle)_fullCircle=Math.PI*2;while(_angle<0)_angle+=_fullCircle;while(_angle>=_fullCircle)_angle-=_fullCircle;return _angle};Utils.distance=function(_x1,_y1,_x2,_y2){var dx=_x2-_x1;var dy=_y2-_y1;return Math.sqrt(dx*dx+dy*dy)};Utils.distanceBetween=function(_p1,_p2){var dx=_p2.x-_p1.x;var dy=_p2.y-_p1.y;return Math.sqrt(dx*dx+dy*dy)};Utils.distanceBetweenScaled=function(_p1,_p2,_sx,_sy){var dx=(_p2.x-_p1.x)*_sx;var dy=(_p2.y-_p1.y)*_sy;return Math.sqrt(dx*dx+dy*dy)};Utils.rotateTo=function(_current,_desired,_speed,_fullCircle){if(!_fullCircle)_fullCircle=Math.PI*2;var halfCircle=_fullCircle/2;var r;var rotFar=Utils.normaliseAnglePositive(_current-_desired+_fullCircle,_fullCircle);if(rotFar>halfCircle){r=_current+Math.min(_fullCircle-rotFar,_speed)}else if(rotFar!==0){r=_current-Math.min(rotFar,_speed)}else{r=_desired}return Utils.normaliseAngle(r,_fullCircle)};Utils.replaceAt=function(string,index,character){return string.substr(0,index)+character+string.substr(index+character.length)};Utils.setValuesFromObject=function(_self,_object){if(_object){for(var key in _object){if(_object.hasOwnProperty(key)){_self[key]=_object[key]}}}};Utils.indexOfParameter=function(_list,_parameter,_value){if(!_list)return-1;for(var i=0,l=_list.length;i<l;i++){if(_list[i][_parameter]==_value)return i}return-1};Utils.indexOfStringNoCase=function(_list,_string){if(!_list)return-1;for(var i=0,l=_list.length;i<l;i++){if(_list[i].toLowerCase()==_string.toLowerCase())return i}return-1};Utils.timeToString=function(ms){if(ms===undefined||ms===null||isNaN(ms))ms=0;var s=ms/1e3;var m=s/60;var mstr=Math.floor(m).toString();var sstr=(Math.floor(s)%60).toString();if(sstr.length<2)sstr="0"+sstr;return mstr+":"+sstr};Utils.clamp=function(_value,_min,_max){return Math.min(Math.max(_value,_min),_max)};Utils.convertDecimalTime=function(_time,_hundreths){var t=0;var mult=1;if(_hundreths){t=Math.floor(_time/10%100);mult=100}var s=Math.floor(_time/1e3);var m=Math.floor(s/60);var h=Math.floor(m/60);t+=Math.floor(mult*(s%60));t+=Math.floor(mult*100*(m%60));t+=Math.floor(mult*1e4*h);return t};Utils.digitsInList=function(_value,_length,_pad,_tail){var list=[];var s=_value.toString();var i=0;while(list.length<_length){if(list.length<s.length){list.push(+s.charAt(i++))}else{if(_tail)list.push(_pad);else list.unshift(_pad)}}return list};Utils.padToLength=function(_string,_length,_pad,_tail){while(_string.length<_length)if(_tail)_string+=_pad;else _string=_pad+_string;return _string};Utils.makeFunctionForSprite=function(_sprite){return function(_state){Utils.setValuesFromObject(_sprite,_state)}};Utils.focusChangeCallback=null;Utils.focusChangeContext=null;Utils._visListener=false;Utils._hidden=false;Utils._focusIn=function(){Utils._hidden=false;if(Main.debug)console.log("Utils._focusIn hidden =",Utils._hidden);if(Utils.focusChangeContext&&Utils.focusChangeCallback)Utils.focusChangeCallback.call(Utils.focusChangeContext,Utils._hidden)};Utils._focusOut=function(){Utils._hidden=true;if(Main.debug)console.log("Utils._focusOut hidden =",Utils._hidden);if(Utils.focusChangeContext&&Utils.focusChangeCallback)Utils.focusChangeCallback.call(Utils.focusChangeContext,Utils._hidden)};Utils.detectHidden=function(){if(!Utils._visListener){var prefix=getBrowserPrefix();var hidden=hiddenProperty(prefix);var visEvent=visibilityEvent(prefix);document.addEventListener(visEvent,function(){if(!document[hidden]){Utils._focusIn()}else{Utils._focusOut()}});window.addEventListener("focus",Utils._focusIn,false);window.addEventListener("blur",Utils._focusOut,false);Utils._visListener=true}};Utils.isHidden=function(){return document["hidden"]};function getBrowserPrefix(){if("hidden"in document){return null}var browserPrefixes=["moz","ms","o","webkit"];for(var i=0;i<browserPrefixes.length;i++){var prefix=browserPrefixes[i]+"Hidden";if(prefix in document){return browserPrefixes[i]}}return null}function hiddenProperty(prefix){if(prefix){return prefix+"Hidden"}else{return"hidden"}}function visibilityState(prefix){if(prefix){return prefix+"VisibilityState"}else{return"visibilityState"}}function visibilityEvent(prefix){if(prefix){return prefix+"visibilitychange"}else{return"visibilitychange"}}Utils.blanker=null;Utils.addBlanker=function(_textures,_key){if(Utils.blanker!==null){Utils.blanker.instances++;return Utils.blanker}if(_key===undefined)_key="blanker";Utils.blanker=new Sprite;Utils.blanker.create(Main.fullUI,_key,_textures,0,0);Utils.blanker.anchor.set(.5);Utils.blanker.scale.set(40);Utils.blanker.alpha=1;Utils.blanker.instances=1;Utils.blanker.moveToFront();return Utils.blanker};Utils.removeBlanker=function(){if(Utils.blanker){Utils.blanker.instances--;if(Utils.blanker.instances<=0){Utils.blanker.destroy();Utils.blanker=null}}};Math.rnd=function(s){return function(){s=Math.sin(s)*1e4;var r=s-Math.floor(s);return r}};Math.mySeed=function(s){if(s===0)s=1;Math.myRandom=Math.rnd(s)};var SpriteData=[];SpriteData.UNDEFINED={type:-1,name:"undefined",animations:{interval:0,default:["undefined"]}};SpriteData.PRELOADER_ANIM={name:"preloader_anim",animations:{noRepeat:true,interval:100,default:["loader_animation0001.png","loader_animation0002.png","loader_animation0003.png","loader_animation0004.png","loader_animation0005.png","loader_animation0006.png","loader_animation0007.png","loader_animation0008.png","loader_animation0009.png","loader_animation0010.png"]}};(function(){for(var type in SpriteData){if(SpriteData[type].type!==undefined)SpriteData[SpriteData[type].type]=SpriteData[type];if(SpriteData[type].name!==undefined)SpriteData[SpriteData[type].name]=SpriteData[type]}})();(function(){var root=this;var SmartPhone=function(obj){if(obj instanceof SmartPhone)return obj;if(!(this instanceof SmartPhone))return new SmartPhone(obj);this._wrapped=obj};SmartPhone.userAgent=null;SmartPhone.getUserAgent=function(){return this.userAgent};SmartPhone.setUserAgent=function(userAgent){this.userAgent=userAgent};SmartPhone.isAndroid=function(){return this.getUserAgent().match(/Android/i)};SmartPhone.isBlackBerry=function(){return this.getUserAgent().match(/BlackBerry/i)};SmartPhone.isBlackBerryPlayBook=function(){return this.getUserAgent().match(/PlayBook/i)};SmartPhone.isBlackBerry10=function(){return this.getUserAgent().match(/BB10/i)};SmartPhone.isIOS=function(){return this.isIPhone()||this.isIPad()||this.isIPod()};SmartPhone.isIPhone=function(){return this.getUserAgent().match(/iPhone/i)};SmartPhone.isIPad=function(){return this.getUserAgent().match(/iPad/i)};SmartPhone.isIPod=function(){return this.getUserAgent().match(/iPod/i)};SmartPhone.isOpera=function(){return this.getUserAgent().match(/Opera Mini/i)};SmartPhone.isWindows=function(){return this.isWindowsDesktop()||this.isWindowsMobile()};SmartPhone.isWindowsMobile=function(){return this.getUserAgent().match(/IEMobile/i)};SmartPhone.isWindowsDesktop=function(){return this.getUserAgent().match(/WPDesktop/i)};SmartPhone.isFireFox=function(){return this.getUserAgent().match(/Firefox/i)};SmartPhone.isNexus=function(){return this.getUserAgent().match(/Nexus/i)};SmartPhone.isKindleFire=function(){return this.getUserAgent().match(/Kindle Fire/i)};SmartPhone.isPalm=function(){return this.getUserAgent().match(/PalmSource|Palm/i)};SmartPhone.isAny=function(){var foundAny=false;var getAllMethods=Object.getOwnPropertyNames(SmartPhone).filter(function(property){return typeof SmartPhone[property]=="function"});for(var index in getAllMethods){if(getAllMethods[index]==="setUserAgent"||getAllMethods[index]==="getUserAgent"||getAllMethods[index]==="isAny"||getAllMethods[index]==="isWindows"||getAllMethods[index]==="isIOS"){continue}if(SmartPhone[getAllMethods[index]]()){foundAny=true;break}}return foundAny};if(typeof window==="function"||typeof window==="object"){SmartPhone.setUserAgent(navigator.userAgent)}if(typeof exports!=="undefined"){var middleware=function(isMiddleware){isMiddleware=isMiddleware===void 0?true:isMiddleware;if(isMiddleware){return function(req,res,next){var userAgent=req.headers["user-agent"]||"";SmartPhone.setUserAgent(userAgent);req.SmartPhone=SmartPhone;if("function"===typeof res.locals){res.locals({SmartPhone:SmartPhone})}else{res.locals.SmartPhone=SmartPhone}next()}}else{return SmartPhone}};if(typeof module!=="undefined"&&module.exports){exports=module.exports=middleware}exports=middleware}else{root.SmartPhone=SmartPhone}}).call(this);function Sprite(_anchorX,_anchorY){PIXI.Sprite.call(this);this.x=0;this.y=0;this.anchor.set(_anchorX?_anchorX:0,_anchorY?_anchorY:0);this.myFilters=null;this.pickerMaskData=null;this.fader=null;this.button=null;this.updateCallback=null;this.tween=null;this.globalScale=null}Sprite.prototype=Object.create(PIXI.Sprite.prototype);Sprite.prototype.constructor=Sprite;Sprite.prototype.create=function(_parent,_type,_textureManager,_x,_y,_pcnt,_behind){this.textures=_textureManager;this.animation="default";this.frameIndex=0;this.atEnd=false;this.animInterval=0;this.animNextTick=0;this.taskDone=false;this.setType(_type);this.myFilters=null;this.destroyTexture=false;this.updateCallback=null;if(this.key){this.texture=this.textures.get(this.key);if(!this.texture&&Main.debug)console.log("WARNING: unrecognised texture applied to Sprite "+this.key)}if(!_behind)_parent.addChild(this);else _parent.addChildAt(this,0);if(_pcnt){this.pcntx=_x||0;this.pcnty=_y||0}else{this.x=_x||0;this.y=_y||0}this.bounds=this.getBounds(false);this.getGlobalScale()};Sprite.prototype.destroy=function(){if(this.tween){this.tween.stop();this.tween=null}if(this.fader){this.fader.destroy();this.fader=null}this.myFilters=null;this.pickerMaskData=null;this.globalScale=null;if(this.texture&&this.destroyTexture){this.texture.destroy({texture:true,baseTexture:true})}this.texture=null;this.textures=null;PIXI.Sprite.prototype.destroy.call(this);this.parent=null};Sprite.prototype.update=function(_ctx){if(this._texture&&!this._texture.orig){console.log("_texture has no orig! "+this.key)}if(Main.resized){this.getGlobalScale(true);if(!isNaN(this.percentx))this.pcntx=this.percentx;if(!isNaN(this.percenty))this.pcnty=this.percenty}if(this.fader){this.alpha=this.fader.fadeValue;this.fader.fading(_ctx)}if(this.animInterval!==0&&this.animNextTick!==0){if(Main.nowTime>=this.animNextTick){this.animNextTick=Main.nowTime+this.animInterval;this.frameIndex++;if(this.frameIndex>=SpriteData[this.type].animations[this.animation].length){this.atEnd=true;if(!this.noRepeat)this.frameIndex=0;else this.frameIndex=SpriteData[this.type].animations[this.animation].length-1}this.setFrame(SpriteData[this.type].animations[this.animation][this.frameIndex])}}if(this.updateCallback){this.updateCallback(this)}return true};Sprite.prototype.addFilter=function(_filter){if(!this.myFilters){this.myFilters=[]}if(this.myFilters.indexOf(_filter)===-1){this.myFilters.push(_filter);this.filters=this.myFilters}};Sprite.prototype.removeFilter=function(_filter){if(!this.myFilters){this.filters=null;return}var i=this.myFilters.indexOf(_filter);if(i!==-1){this.myFilters.splice(i,1);this.filters=this.myFilters}};Sprite.prototype.setPickerData=function(_data){this.pickerMaskData=_data};Sprite.prototype.setAnimation=function(_animation,_dontReset,_force){if(_force||this.animation!=_animation){this.animation=_animation;this.atEnd=false;if(!_dontReset)this.frameIndex=0;var a=SpriteData[this.type].animations;if(a){this.setFrame(a[this.animation][this.frameIndex]);this.noRepeat=a.noRepeat;this.animInterval=a.interval;if(a.randomise)this.animNextTick=Main.nowTime+Math.floor(this.animInterval*Math.random());else this.animNextTick=Main.nowTime+this.animInterval;return true}}return false};Sprite.prototype.setFrame=function(_key,_force){if(_force||this.key!=_key){this.key=_key;if(this.key){this.texture=this.textures.get(_key);return true}}return false};Sprite.prototype.setType=function(_type){if(_type!=this.type){this.type=_type;this.animation="default";this.animInterval=0;this.animNextTick=0;this.frameIndex=0;this.atEnd=false}if(!SpriteData[this.type])this.setFrame(this.type);else{if(!this.setAnimation(this.animation,true,true)){if(SpriteData[this.type].key)this.setFrame(SpriteData[this.type].key);else console.error("ERROR: Sprite.create there is no key or animations for _type: '"+_type+"'!")}}};Sprite.prototype.moveToFront=function(){var p=this.parent;p.removeChild(this);p.addChildAt(this,p.children.length)};Sprite.moveToFront=function(_sprite){var p=_sprite.parent;p.removeChild(_sprite);p.addChildAt(_sprite,p.children.length)};Sprite.prototype.getGlobalScale=function(_recalc){if(_recalc||this.globalScale===null){var sx=1;var sy=1;var parent=this.parent;while(parent){sx*=parent.scale.x;sy*=parent.scale.y;parent=parent.parent}this.globalScale={x:sx,y:sy}}return this.globalScale};Sprite.getGlobalScale=function(_sprite){var sx=1;var sy=1;var parent=_sprite.parent;while(parent){sx*=parent.scale.x;sy*=parent.scale.y;parent=parent.parent}return{x:sx,y:sy}};Sprite.getGlobalPosition=function(_sprite){return _sprite.toGlobal(_sprite)};Sprite.getGlobalPositionXY=function(_sprite,_x,_y){var p=new PIXI.Point(_x,_y);return _sprite.toGlobal(p)};Sprite.setGlobalPosition=function(_sprite,_x,_y){var scale=Sprite.getGlobalScale(_sprite);_sprite.x=_x*scale.x;_sprite.y=_y*scale.y};Sprite.prototype.pixelPicker=function(_x,_y){this.bounds=this.getBounds(false);if(_x<this.bounds.left||_x>=this.bounds.right)return 0;if(_y<this.bounds.top||_y>=this.bounds.bottom)return 0;this.getGlobalScale();var ix=Math.floor((_x-this.bounds.left)/this.globalScale.x)*4+3;var iy=Math.floor((_y-this.bounds.top)/this.globalScale.y);var p=this.pickerMaskData[ix+iy*this.texture.frame.width*4];if(p)return true;return false};Sprite.prototype.createCanvasFromTexture=function(){var canvas=document.createElement("canvas");canvas.width=this.texture.frame.width;canvas.height=this.texture.frame.height;var context=canvas.getContext("2d");context.drawImage(this.texture.baseTexture.source,this.texture.frame.x,this.texture.frame.y,this.texture.frame.width,this.texture.frame.height,0,0,this.texture.frame.width,this.texture.frame.height);return canvas};Sprite.prototype.setCallback=function(_fnc,_ctx,_arg){this.fadeCallback=_fnc;this.fadeCtx=_ctx;this.fadeArg=_arg};Sprite.prototype.addFader=function(_dir,_start,_callback,_context,_args,_trigger){this.fader=new FadeState;this.fader.setFade(_dir,_start,_callback,_context,_args,_trigger)};Sprite.prototype.getPixels=function(_fullSize){var mv=this.visible;this.visible=true;var ms;if(_fullSize){ms=this.scale;this.scale.set(1,1)}var diag=Math.ceil(Math.sqrt(this.width*this.width+this.height*this.height));var rt=PIXI.RenderTexture.create(diag,diag);var anchor={x:this.anchor.x,y:this.anchor.y};var position={x:this.x,y:this.y};this.anchor.set(.5,.5);this.x=this.y=Math.floor(diag/2);Main.app.renderer.render(this,rt);this.anchor.x=anchor.x;this.anchor.y=anchor.y;this.x=position.x;this.y=position.y;this.visible=mv;if(_fullSize){this.scale.set(ms)}return{pixels:Main.app.renderer.extract.pixels(rt),width:diag,height:diag}};Sprite.getPixelExtents=function(_sprite){var pixels=_sprite.getPixels(true);var minx=Number.POSITIVE_INFINITY,maxx=Number.NEGATIVE_INFINITY,miny=Number.POSITIVE_INFINITY,maxy=Number.NEGATIVE_INFINITY;for(var x=0;x<pixels.width;x++){for(var y=0;y<pixels.height;y++){var i=x*4+y*pixels.width*4;var p=pixels.pixels[i]+(pixels.pixels[i+1]<<8)+(pixels.pixels[i+2]<<16)+(pixels.pixels[i+3]<<24);if(p!=0){if(x<minx)minx=x;if(x>maxx)maxx=x;if(y<miny)miny=y;if(y>maxy)maxy=y}}}maxx++;maxy++;return{x:minx,y:miny,w:maxx-minx,h:maxy-miny}};Object.defineProperties(Sprite.prototype,{scaleFactor:{get:function(){return this.scale.x},set:function(_first){if(typeof _first=="number"){this.scale.x=_first;this.scale.y=_first}else{if(_first.hasOwnProperty("x")){this.scale.x=_first.x}if(_first.hasOwnProperty("y")){this.scale.y=_first.y}}}},pcntx:{set:function(_pcnt){this.percentx=_pcnt;if(this.parent){if(this.parent.texture.noFrame){this.x=_pcnt/this.parent.scale.x*Main.width}else this.x=_pcnt/this.parent.scale.x*this.parent.width}}},pcnty:{set:function(_pcnt){this.percenty=_pcnt;if(this.parent){if(this.parent.texture.noFrame){this.y=_pcnt/this.parent.scale.y*Main.height}else this.y=_pcnt/this.parent.scale.y*this.parent.height}}},setx:{set:function(_x){this.x=_x;if(this.parent)this.percentx=_x/this.parent.width}},sety:{set:function(_y){this.y=_y;if(this.parent)this.percenty=_y/this.parent.height}}});function Text(_text,_style){PIXI.Text.call(this,_text,_style);this.x=0;this.y=0}Text.prototype=Object.create(PIXI.Text.prototype);Text.prototype.constructor=Text;Text.prototype.create=function(_parent,_x,_y,_pcnt){_parent.addChild(this);if(_pcnt){this.pcntx=_x||0;this.pcnty=_y||0}else{this.x=_x||0;this.y=_y||0}};Text.prototype.destroy=function(){PIXI.Text.prototype.destroy.call(this)};Text.prototype.update=function(){if(Main.resized){if(!isNaN(this.percentx))this.pcntx=this.percentx;if(!isNaN(this.percenty))this.pcnty=this.percenty}return true};Object.defineProperties(Text.prototype,{scaleFactor:{get:function(){return this.scale},set:function(_first){if(typeof _first=="number"){this.scale.x=_first;this.scale.y=_first}else{if(_first.hasOwnProperty("x")){this.scale.x=_first.x}if(_first.hasOwnProperty("y")){this.scale.y=_first.y}}}},pcntx:{set:function(_pcnt){this.percentx=_pcnt;if(this.parent){if(this.parent.texture.noFrame){this.x=_pcnt/this.parent.scale.x*Main.width}else{this.x=_pcnt/this.parent.scale.x*this.parent.width}}}},pcnty:{set:function(_pcnt){this.percenty=_pcnt;if(this.parent){if(this.parent.texture.noFrame){this.y=_pcnt/this.parent.scale.y*Main.height}else{this.y=_pcnt/this.parent.scale.y*this.parent.height}}}},setx:{set:function(_x){this.x=_x;if(this.parent){if(this.parent.texture.noFrame){this.percentx=_x/Main.width}else{this.percentx=_x/this.parent.width}}}},sety:{set:function(_y){this.y=_y;if(this.parent){if(this.parent.texture.noFrame){this.percenty=_y/Main.height}else{this.percenty=_y/this.parent.height}}}}});function Button(_type,_anchorX,_anchorY){Sprite.call(this,_anchorX,_anchorY);this.textures=null;this.buttonType=_type||Button.TYPE_BUTTON;this.downDetected=true;this._toggled="on";this.text=null;this.sfx=null;this.sfxHover=null;this.enabled=false;this.callbackMouseDown=null;this.updateCallback=null;this.callbackHover=null;this.callbackHoverOut=null}Button.TYPE_BUTTON=1;Button.TYPE_CHECKBOX=2;Button.TYPE_TOGGLE=3;Button.TYPE_NOLATCH=4;Button.prototype=Object.create(Sprite.prototype);Button.prototype.constructor=Button;Button.prototype.create=function(_parent,_type,_managers,_x,_y,_pcnt,_upKey,_overKey,_downKey,_downEvent,_overEvent,_upKey2,_overKey2,_downKey2,_downEvent2,_overEvent2){this.managers=_managers;Sprite.prototype.create.call(this,_parent,_type,this.managers.textures,_x,_y,_pcnt);this.upKey={on:_upKey,off:_upKey2};this.overKey={on:_overKey,off:_overKey2};this.downKey={on:_downKey,off:_downKey2};this.downEvent={on:_downEvent,off:_downEvent2};this.overEvent={on:_overEvent,off:_overEvent2};this.downDetected=true;this._toggled="on";this.text=null;this.sfx=null;this.sfxHover=null;this.enabled=true;EventHandlers.registerCallback("mousedown",this.playSfx,{context:this})};Button.prototype.destroy=function(){EventHandlers.clearCallback("mousedown",this.playSfx);this.managers=null;Sprite.prototype.destroy.call(this);if(this.text){this.text.destroy();this.text=null}if(this.tween){this.tween.stop();this.tween=null}this.upKey=this.overKey=this.downKey=this.downEvent=this.overEvent=null;this._toggled=null;this.sfx=this.sfxHover=null;this.callbackMouseDown=null;this.callbackHover=null;this.callbackHoverOut=null};Button.prototype.update=function(){var event=null;var o=false;var c=false;this.calculateBounds();var r=this.getBounds();if(Game.isDragging()){return null}if(this.updateCallback){this.updateCallback(this)}if(this.callbackMouseDown&&Main.mouseDown&&r.contains(Main.mouseDown.x,Main.mouseDown.y)){this.callbackMouseDown.call(null)}if(this.buttonType==Button.TYPE_BUTTON||this.buttonType==Button.TYPE_NOLATCH){c=this.downDetected&&Main.mouseDown!==null&&r.contains(Main.mouseDown.x,Main.mouseDown.y)||Main.click!==null&&r.contains(Main.click.x,Main.click.y)}else{c=Main.click!==null&&r.contains(Main.click.x,Main.click.y)}if(c){Main.mouseDown=Main.click=null;this.setFrame(this.downKey[this._toggled]);if(this.enabled){event=this.downEvent[this._toggled];if(event)EventSignals.signal(event)}o=true}if(!o&&Main.hover){if(r.contains(Main.hover.x,Main.hover.y)){if(this.callbackHover)this.callbackHover.call(this);if(this.setFrame(this.overKey[this._toggled])){if(this.sfxHover)this.managers.audio.play(this.sfxHover)}if(this.overEvent){if(this.enabled){event=this.overEvent[this._toggled];if(event)EventSignals.signal(event)}}o=true}}if(!o&&this.buttonType!=Button.TYPE_TOGGLE){if(this.callbackHoverOut)this.callbackHoverOut.call(this);this.setFrame(this.upKey[this._toggled])}Sprite.prototype.update.call(this);if(this.text){this.text.update()}return event};Button.prototype.playSfx=function(_x,_y){if(this&&this.managers&&this.sfx&&this.enabled){this.calculateBounds();var r=this.getBounds();if(r.contains(_x,_y))this.managers.audio.play(this.sfx)}};Object.defineProperties(Button.prototype,{toggled:{set:function(_state){this._toggled=_state?"on":"off";this.setFrame(this.upKey[this._toggled])},get:function(){return this._toggled=="on"}}});CanvasText=function(_context){this.context=_context;this.lines=null;this.strokeWidth=0;this.gradient=null;this.bendText=null;this.fillShadow=null;this.strokeShadow=null;this.metrics=null};CanvasText._conversionCanvas=null;CanvasText.prototype.create=function(_x,_y,_message,_size,_fontName,_fillColor,_align){this.x=_x;this.y=_y;this.message=_message;this.size=_size;this.fontName=_fontName;this.fillColor=_fillColor;this.align=_align;this.lineHeight=_size;this.strokeFirst=false;this.lines=_message.split("\n");this.metrics=CanvasText.getTextMetrics(this.message,this.size,this.fontName);this.metrics.em=Math.ceil(CanvasText.getTextMetrics("M",this.size,this.fontName).width*1.25);if(Main.debug){console.log("CanvasText: '"+this.message+"' is "+this.metrics.width+"x"+this.metrics.em)}};CanvasText.prototype.destroy=function(){this.context=null;this.gradient=null;this.bendText=null;this.fillShadow=null;this.strokeShadow=null;this.metrics=null;CanvasText.getTextMetrics._canvas=null;CanvasText.getTextMetrics._ctx=null};CanvasText.prototype.addStroke=function(_strokeWidth,_strokeColor){this.strokeWidth=_strokeWidth;this.strokeColor=_strokeColor;this.metrics.width+=_strokeWidth;this.metrics.em+=_strokeWidth};CanvasText.prototype.addGradient=function(_type,_start,_end,_colorStops){switch(_type){case"linear":this.gradient=this.context.createLinearGradient(_start.x,_start.y,_end.x,_end.y);break;case"radial":this.gradient=this.context.createRadialGradient(_start.x,_start.y,_start.r,_end.x,_end.y,_end.r);break}if(this.gradient){for(var i=0;i<_colorStops.length;i++){var stop=_colorStops[i];this.gradient.addColorStop(stop.position,stop.color)}this.fillColor=this.gradient}};CanvasText.prototype.addBend=function(_radius,_angle){this.bendText={angle:_angle,radius:_radius};this.metrics.width=Math.ceil(this.metrics.width*1.2);this.metrics.em*=2};CanvasText.prototype.addFillShadow=function(_offsetX,_offsetY,_color,_blur){this.fillShadow={x:_offsetX,y:_offsetY,color:_color,blur:_blur}};CanvasText.prototype.addStrokeShadow=function(_offsetX,_offsetY,_color,_blur){this.strokeShadow={x:_offsetX,y:_offsetY,color:_color,blur:_blur}};CanvasText.prototype.draw=function(_ctx){if(!_ctx)_ctx=this.context;_ctx.font=this.size.toString()+"px "+this.fontName;_ctx.fillStyle=this.fillColor;_ctx.textAlign=this.align;if(this.strokeWidth>0){_ctx.strokeStyle=this.strokeColor;_ctx.lineWidth=this.strokeWidth}if(this.bendText){this.drawTextAlongArc(_ctx);return}var y=this.y;for(var i=0;i<this.lines.length;i++){var line=this.lines[i];if(this.strokeFirst){this.drawStroke(this.x,y,_ctx,line);this.drawFill(this.x,y,_ctx,line)}else{this.drawFill(this.x,y,_ctx,line);this.drawStroke(this.x,y,_ctx,line)}y+=this.lineHeight}};CanvasText.prototype.drawStroke=function(_x,_y,_ctx,_line){if(this.strokeWidth>0){if(this.strokeShadow){_ctx.shadowOffsetX=this.strokeShadow.x;_ctx.shadowOffsetY=this.strokeShadow.y;_ctx.shadowColor=this.strokeShadow.color;_ctx.shadowBlur=this.strokeShadow.blur}else{_ctx.shadowColor="rgba(0,0,0,0)"}_ctx.fillText(_line,_x,_y)}};CanvasText.prototype.drawFill=function(_x,_y,_ctx,_line){if(this.fillShadow){_ctx.shadowOffsetX=this.fillShadow.x;_ctx.shadowOffsetY=this.fillShadow.y;_ctx.shadowColor=this.fillShadow.color;_ctx.shadowBlur=this.fillShadow.blur}else{_ctx.shadowColor="rgba(0,0,0,0)"}_ctx.fillText(_line,_x,_y)};CanvasText.prototype.drawTextAlongArc=function(_ctx){if(!_ctx)_ctx=this.context;var angle=this.bendText.angle;var radius=this.bendText.radius;if(this.lines.length==0){return}if(this.lines.length>1){console.warn("drawTextAlongArc does not support multiple lines of text!");return}var line=this.lines[0];var l=line.length;_ctx.save();_ctx.translate(this.x,this.y+radius);_ctx.rotate(-angle/2);_ctx.rotate(-(angle/l)/2);for(var n=0;n<l;n++){_ctx.rotate(angle/l);_ctx.translate(0,-radius);var letter=line[n];if(this.strokeFirst){this.drawStroke(0,0,_ctx,letter);this.drawFill(0,0,_ctx,letter)}else{this.drawFill(0,0,_ctx,letter);this.drawStroke(0,0,_ctx,letter)}_ctx.translate(0,radius)}_ctx.restore()};CanvasText.prototype.convertTextToTexture=function(name){if(!CanvasText._conversionCanvas){CanvasText._conversionCanvas=[]}var canvas=CanvasText._conversionCanvas[name];if(!canvas){canvas=CanvasText._conversionCanvas[name]=Main.document.createElement("canvas")}var ctx=canvas.getContext("2d");ctx.globalAlpha=1;canvas.width=this.metrics.width*1.2;canvas.height=this.metrics.em*1.5;canvas.style.width=Math.floor(canvas.width).toString()+"px";canvas.style.height=Math.floor(canvas.height).toString()+"px";canvas.style.cssText="width: "+canvas.style.width+"; height: "+canvas.style.height+";";ctx.clearRect(0,0,canvas.width,canvas.height);if(Main.languageCode=="ar")this.x=canvas.width*19/32;else this.x=canvas.width/2;if(this.bendText)this.y=canvas.height*.6;else this.y=canvas.height*.8;this.draw(ctx);PIXI.Texture.addToCache(PIXI.Texture.fromCanvas(canvas),name)};CanvasText.getTextMetrics=function(_message,_fontSize,_fontName){if(!CanvasText.getTextMetrics._canvas){CanvasText.getTextMetrics._canvas=Main.document.createElement("canvas");CanvasText.getTextMetrics._ctx=CanvasText.getTextMetrics._canvas.getContext("2d")}CanvasText.getTextMetrics._ctx.font=_fontSize+"px "+_fontName;var metrics=CanvasText.getTextMetrics._ctx.measureText(_message);return{width:Math.ceil(metrics.width),em:0}};function FadeState(){this.fadeValue=0;this.fadedir=0;this.trigger=undefined;this.direction=undefined;this.callback=null;this.context=null;this.args=null}FadeState.prototype.destroy=function(){this.callback=null;this.context=null;this.args=null};FadeState.prototype.setFade=function(_dir,_value,_callback,_context,_args,_trigger){if(_dir!==null&&_dir!==undefined)this.fadedir=_dir;if(_value!==null&&_value!==undefined)this.fadeValue=_value;this.callback=_callback;this.context=_context;this.args=_args;if(_trigger!==null){this.trigger=_trigger;if(this.trigger!==undefined){if(this.fadeValue>=this.trigger)this.direction=-1;else this.direction=1}}};FadeState.prototype.reached=function(_target){return this.fadeValue==_target};FadeState.prototype.fading=function(){var ret=true;if(this.fadedir!==0){this.fadeValue+=this.fadedir;if(isNaN(this.trigger)||this.direction===undefined){if(this.fadeValue<=0){this.fadeValue=0;this.fadedir=0;if(Main.debug)console.log("FadeState: finished fading out");ret=false}else if(this.fadeValue>=1){this.fadeValue=1;this.fadedir=0;if(Main.debug)console.log("FadeState: finished fading in");ret=false}}}if(!isNaN(this.trigger)&&this.direction!==undefined){if(this.direction===-1){if(this.fadeValue<=this.trigger){if(this.callback.call(this.context,this.args)){this.callback=null;return false}}}else{if(this.fadeValue>=this.trigger){if(this.callback.call(this.context,this.args)){this.callback=null;return false}}}}return ret};function Point(_x,_y){this.x=_x||0;this.y=_y||0}Point.prototype.distance=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Point.distance=function(_p1,_p2){var dx=_p1.x-_p2.x;var dy=_p1.y-_p2.y;return Math.sqrt(dx*dx+dy*dy)};Point.angle=function(_p1,_p2){var dx=_p1.x-_p2.x;var dy=_p1.y-_p2.y;return Math.atan2(dy,dx)};var EventSignals={signalList:[],create:function(){signalList=[]},destroy:function(){signalList=null},listen:function(_key,_callback,_context){if(!signalList[_key])signalList[_key]=[];var i=EventSignals.find(_key,_callback);if(i!=-1)signalList[_key][i]={callback:_callback,context:_context};else signalList[_key].push({callback:_callback,context:_context})},remove:function(_key,_callback){if(_callback===undefined){if(signalList[_key])signalList[_key]=null;return}var i=EventSignals.find(_key,_callback);if(i!=-1){signalList[_key].splice(i,1);if(signalList[_key].length==0)signalList[_key]=null}},find:function(_key,_callback){if(signalList[_key])for(var i=0,l=signalList[_key].length;i<l;i++)if(signalList[_key][i].callback==_callback)return i;return-1},signal:function(_key){if(signalList[_key])for(var i=0,l=signalList[_key].length;i<l;i++)signalList[_key][i].callback.call(signalList[_key][i].context)},clear:function(_key){if(signalList[_key])signalList[_key]=null}};function Textures(){this.pending=0;this.loader=null}Textures.prototype.create=function(){this.pending=0;this.loader=PIXI.loader};Textures.prototype.destroy=function(){this.pending=0;this.loader=null};Textures.prototype.addImage=function(_key,_resourceURL){this.loader.add(_key,_resourceURL);if(Main.debugSpam)console.log("Textures.addImage ",_key,_resourceURL);this.pending++};Textures.prototype.addAtlas=function(_key,_atlasURL){this.loader.add(_key,_atlasURL);if(Main.debugSpam)console.log("Textures.addAtlas ",_key,_atlasURL);this.pending++};Textures.prototype.startLoading=function(_callback,_context){var _this=this;if(Main.debug)console.log("Textures.startLoading");if(this.pending>0){this.loader.once("complete",function(){_this.pending=0;if(Main.debug)console.log("Textures all loaded.");if(_callback&&_context)_callback.call(_context)}).load()}else{if(Main.debug)console.log("WARNING: Textures.startLoading - no images to load!")}};Textures.prototype.loadImage=function(_key,_resourceURL,_callback,_context){if(Main.debugSpam)console.log("Textures.loadImage",_key,_resourceURL);this.loader.add(_key,_resourceURL);this.loader.once("complete",function(){if(Main.debugSpam)console.log("Texture loaded");_callback.call(_context)}).load()};Textures.prototype.new=function(_key,_wide,_high){if(Main.debugSpam)console.log("new texture created ",_key,_wide,_high);if(this.exists(_key)){console.warn("duplicate key, a texture already exists "+_key+"!");return null}var canvas=Textures.createCanvas(_key,_wide,_high);var img=PIXI.Texture.fromCanvas(canvas);PIXI.loader.resources[_key]={texture:img};return img};Textures.prototype.get=function(_key,_dontConvert){if(PIXI.utils.TextureCache[_key])return PIXI.utils.TextureCache[_key];if(!PIXI.loader.resources[_key])return PIXI.Texture.fromFrame(_key);if(PIXI.loader.resources[_key].texture)return PIXI.loader.resources[_key].texture;if(_dontConvert)return null;if(Main.debugSpam)console.log("texture created from canvas",_key);var img=PIXI.Texture.fromCanvas(PIXI.loader.resources[_key]);PIXI.loader.resources[_key].texture=img;return img};Textures.prototype.set=function(_key,_img){var resource=PIXI.loader.resources[_key];if(resource&&resource!=_img){if(Main.debugSpam)console.log("Textures.set removing image from cache",_key);this.remove(_key)}if(Main.debugSpam)console.log("Textures.set adding image to cache",_key,_img.width,"x",_img.height);PIXI.loader.resources[_key]=_img};Textures.prototype.exists=function(_key){if(!PIXI.loader.resources[_key])return false;return true};Textures.prototype.remove=function(_key){var resource=PIXI.loader.resources[_key];if(!resource){if(Main.debug)alert("ERROR: Textures.remove can't remove a null resource",_key);return}if(!resource.texture){if(Main.debug){if(!Textures.isCanvas(resource))console.log("Textures.remove can't remove a null texture",_key);else console.log("Textures.remove removing a Canvas",_key)}PIXI.loader.resources[_key]=null;delete PIXI.loader.resources[_key];return}if(!Textures.isCanvas(resource.texture))resource.texture.destroy({texture:true,baseTexture:true});resource.texture=null;if(!Textures.isCanvas(resource)){if(Main.debugSpam)console.log("Textures.remove removing a Texture",_key);if(resource.destroy)resource.destroy({texture:true,baseTexture:true})}else{if(Main.debugSpam)console.log("Textures.remove removing a Texture with a Canvas",_key)}PIXI.loader.resources[_key]=null;delete PIXI.loader.resources[_key]};Textures.isCanvas=function(_object){if(!_object){if(Main.debug)alert("ERROR: null or undefined object being tested for HTMLCanvasElement!");return false}return _object instanceof HTMLCanvasElement||_object.constructor.name=="HTMLCanvasElement"||(_object.prototype?_object.prototype.constructor:_object.constructor).toString()=="HTMLCanvasElement"};function nextPo2(value){v=value-1;v|=v>>1;v|=v>>2;v|=v>>4;v|=v>>8;v|=v>>16;v++;return v}Textures.createCanvas=function(id,width,height){var canvas=document.createElement("canvas");if(typeof id==="string"&&id!=="")canvas.id=id;canvas.width=nextPo2(width);canvas.height=nextPo2(height);canvas.style.display="block";return canvas};Textures.getPixels=function(_sprite){var rt=PIXI.RenderTexture.create(_sprite._texture._frame.width,_sprite._texture._frame.height);Main.app.renderer.render(_sprite,rt);return Main.app.renderer.extract.pixels(rt)};Textures.getPixels=function(_texture){return Main.app.renderer.extract.pixels(_texture)};Textures.getPixel=function(_pixels,_x,_y,_width){var i=(_x+_width*_y)*4;var r=_pixels[i++];var g=_pixels[i++];var b=_pixels[i++];var a=_pixels[i];return{r:r,g:g,b:b,a:a}};function DataManager(){this.list=null;this.pending=0}DataManager.prototype.create=function(){this.list=[]};DataManager.prototype.destroy=function(){this.list=null};DataManager.prototype.loadData=function(_key,_path,_onComplete){var data;if(this.list[_key]){data=this.list[_key];return data}if(Main.debug)console.log("DataManager.loadData ",_key,_path);data={};data.isReady=false;this.list[_key]=data;var _this=this;var xobj=new XMLHttpRequest;xobj.overrideMimeType("application/json");xobj.open("GET",_path,true);xobj.onreadystatechange=function(){if(xobj.readyState==4&&xobj.status=="200"){data.isReady=true;data.data=JSON.parse(xobj.responseText);if(_onComplete)_onComplete();_this.pending--}};xobj.send(null);this.pending++;data.src=_path;return data};DataManager.prototype.get=function(_key){if(this.list&&this.list[_key]&&this.list[_key].isReady!==false){return this.list[_key].data||this.list[_key]}if(Main.debug)console.log("DataManager.get(): data not in cache",_key);return null};DataManager.prototype.set=function(_key,_data){if(this.list[_key]){if(Main.debug)console.log("WARNING: attempt to overwrite existing cache item",_key);return}for(var k in this.list){if(this.list[k]==_data){if(Main.debug)console.log("WARNING: adding additional key to existing cache item",k,"==",_key);this.list[_key]=this.list[k];return}}this.list[_key]=_data;if(Main.debug)console.log("DataManager.set(): data added to cache",_key)};function AudioManager(){this.list=null;this.mute=false;this.gameTune=null;this.tunesMuted=false;this.rememberMute=undefined;this.rememberTunesMuted=undefined;this.delayed=null;this.pending=0;this.managers=null;this.playedThisFrame=null;this.sfxQueued=null}AudioManager.sfxVolume=.75;AudioManager.musicVolume=.5;AudioManager.prototype.create=function(_managers){this.managers=_managers;this.list=[];this.delayed=[];this.pending=0;this.playedThisFrame=[];this.sfxQueued=[];this.playedOne=false;this.mute=!Main.showMuteButton;this.tunesMuted=!Main.showMuteButton};AudioManager.prototype.destroy=function(){this.managers=null;if(this.list){for(var i in this.list){if(this.list.hasOwnProperty(i)){var sound=this.list[i];sound.unload();this.list[i]=null}}this.list=null}this.delayed=null;this.gameTune=null;this.delayed=null;this.playedThisFrame=null;this.sfxQueued=null};AudioManager.prototype.update=function(){var now=Main.time;for(var i=this.delayed.length-1;i>=0;--i){var p=this.delayed[i];if(p.cancelCallback&&p.cancelCallback.call(p.context,now>p.time)){this.delayed.splice(i,1);continue}if(now>p.time){if(p.playCallback)p.playCallback.call(this);if(!this.mute){var sfx=this.list[p.key];sfx.play()}this.delayed.splice(i,1)}}if(!this.playedOne){while(this.sfxQueued.length>0){var q=this.sfxQueued.shift();if(q.time>=Main.time-100){this._playOne(q.key,false);break}}}this.playedThisFrame=[];this.playedOne=false};AudioManager.prototype.loadSoundSprite=function(_key,_path,_subScripts,json){var urls=[];for(var i=0,l=_subScripts.length;i<l;i++){urls.push(_path+"."+_subScripts[i])}this.pending++;if(Main.debug)console.log("AudioManager.loadSoundSprite "+_key+" "+_path);var _this=this;json.src=urls;json.onload=function(){_this.pending--};this.list[_key]=new Howl(json)};AudioManager.prototype.loadAudio=function(_key,_path,_subScripts){var urls=[];for(var i=0,l=_subScripts.length;i<l;i++){urls.push(_path+"."+_subScripts[i])}this.pending++;if(Main.debugSpam)console.log("AudioManager.loadAudio "+_key+" "+_path);var _this=this;this.list[_key]=new Howl({src:urls,onload:function(){_this.pending--}})};AudioManager.prototype.play=function(_key){if(Main.debugSpam)console.log("Audio play = "+_key);if(this.mute)return null;if(Array.isArray(_key)){var key=Utils.pickRandomFromList(_key);return this._playOne(key,false)}return this._playOne(_key,false)};AudioManager.prototype._playOne=function(_key,_isTune){if(Main.muteUntil<=Main.time){if(Main.noSfxIE&&Main.isIE&&!_isTune)return null;if(Main.isIE&&this.playedOne&&!_isTune){if(this.sfxQueued.length>6)this.sfxQueued.shift();this.sfxQueued.push({key:_key,time:Main.time});return null}if(this.playedThisFrame.indexOf(_key)!=-1)return null;this.playedThisFrame.push(_key);this.playedOne=true;if(this.list&&this.list[_key]){var sfx=this.list[_key];if(sfx._state!="loaded"){if(Main.debug)console.log("AudioManager.playOne "+_key+" SFX not loaded!");return null}sfx.volume(AudioManager.sfxVolume);var res=sfx.play();if(Main.debugSpam){console.log("AudioManager.playOne "+_key+" = "+res);if(!res){console.log("SFX not playable!")}}return sfx}else{var sndSprite=this.list["sound_sprite"];if(sndSprite){sndSprite.volume(AudioManager.sfxVolume);sndSprite.play(_key);return sndSprite}}}return null};AudioManager.prototype.playDelayed=function(_key,_delay,_playCallback,_cancelCallback,_context){if(Array.isArray(_key)){_key=Utils.pickRandomFromList(_key)}if(_key&&this.list&&this.list[_key]){this.delayed.push({key:_key,time:Main.time+_delay*1e3,playCallback:_playCallback,cancelCallback:_cancelCallback,context:_context})}};AudioManager.prototype.visibilityMute=function(_hidden){if(Main.debug)console.log("AudioManager.visibilityMute",_hidden);if(_hidden){if(this.rememberMute===undefined){this.rememberMute=this.mute;this.rememberTunesMuted=this.tunesMuted;this.setMute(true,true);this.muteTunes(true,true)}}else{if(this.rememberMute!==undefined){this.setMute(this.rememberMute,true);this.muteTunes(this.rememberTunesMuted,true);this.rememberMute=undefined;this.rememberTunesMuted=undefined}}};AudioManager.prototype.setMute=function(_muted,_noSave){if(Main.debug)console.log("AudioManager.setMute",_muted);if(Main.showMuteButton)this.mute=_muted;for(var i in this.list){if(this.list.hasOwnProperty(i)){var sfx=this.list[i];if(sfx!==this.gameTune)sfx.mute(_muted)}}};AudioManager.prototype.muteTunes=function(_muted,_noSave){if(Main.debug)console.log("AudioManager.muteTunes",_muted);if(Main.showMuteButton)this.tunesMuted=_muted;if(this.gameTune){this.gameTune.mute(this.tunesMuted)}};AudioManager.prototype.pauseMute=function(_paused){if(this.gameTune){if(_paused){this.gameTune.mute(true)}else{this.gameTune.mute(this.tunesMuted)}}};AudioManager.prototype.startTune=function(_key,_noLoop){if(Main.debug)console.log("AudioManager.startTune "+_key);if(!this.gameTune){this.list[_key].loop(_noLoop?false:true);this.gameTune=this._playOne(_key,true);if(this.gameTune){this.gameTune.volume(AudioManager.musicVolume*Main.volumeControl)}this.muteTunes(this.tunesMuted,true)}};AudioManager.prototype.stopTune=function(){if(this.gameTune){this.gameTune.stop();this.gameTune=null}};AudioManager.prototype.setMusicVolume=function(_vol){AudioManager.musicVolume=_vol;if(this.gameTune)this.gameTune.volume(AudioManager.musicVolume*Main.volumeControl)};AudioManager.prototype.sfxLoaded=function(){for(var _key in this.list){var sfx=this.list[_key];if(sfx._state!="loaded")return false}return true};