var game=game||{};game.screens=game.screens||{};(function(){'use strict';function Level(){WONBATS.Screen.call(this);this.mcs=[];var c=components;var self=this;this.engine=new WONBATS.CESEngine(512,[c.Transform,c.RigidBody,c.AABBCollider,c.Gravity,c.Impulse,c.Render,c.Info,c.Player,c.Bouncer,c.Life,c.Damage,c.Attack,c.Hurt,c.State,c.Lifespan,c.Die,c.Launcher,c.Runner,c.Flyer,c.Enemy,c.Aim,c.Wait,c.Jump,c.Lander,c.Sword,c.Projectile,c.Item,c.Shadow,c.NoFlip,c.NoDrop]);var cmsys=new CommonSystem(this.engine);var clsys=new CollisionSystem(this.engine);var rdsys=new RenderSystems(this.engine);this.aisys=new AISystem(this.engine,this.createEntity.bind(this),this.removeEntity.bind(this),this.onEntitiesOverlap.bind(this),this.onEntityKilled.bind(this),this.onEntityHurt.bind(this),this.onItemPickup.bind(this),this.onRemoveTutorial.bind(this));this.engine.addUpdate(this.aisys.updateState.bind(this.aisys),[c.State,c.Render]);this.engine.addUpdate(this.aisys.spawnEnemy.bind(this.aisys),[c.State,c.Enemy,c.Render,c.Transform]);this.engine.addUpdate(this.aisys.updatePlayerState.bind(this.aisys),[c.State,c.Player,c.Launcher,c.Info,c.AABBCollider,c.Render]);this.engine.addUpdate(this.aisys.updateAttackState.bind(this.aisys),[c.State,c.Player,c.Attack,c.Launcher,c.Render,c.AABBCollider,c.RigidBody,c.Impulse]);this.engine.addUpdate(this.aisys.updateLanderState.bind(this.aisys),[c.State,c.Lander,c.AABBCollider,c.Render]);this.engine.addUpdate(this.aisys.updateHurtState.bind(this.aisys),[c.State,c.Hurt,c.Render,c.AABBCollider,c.RigidBody]);this.engine.addUpdate(this.aisys.updateBouncerState.bind(this.aisys),[c.State,c.Bouncer,c.Render,c.AABBCollider,c.RigidBody,c.Transform]);this.engine.addUpdate(this.aisys.updateRunnerState.bind(this.aisys),[c.State,c.Runner,c.Render,c.AABBCollider,c.RigidBody,c.Transform]);this.engine.addUpdate(this.aisys.updateFlyerState.bind(this.aisys),[c.State,c.Flyer,c.Render,c.AABBCollider,c.RigidBody,c.Transform]);this.engine.addUpdate(this.aisys.updateWaitState.bind(this.aisys),[c.State,c.Wait]);this.engine.addUpdate(this.aisys.updateProjectile.bind(this.aisys),[c.Projectile,c.RigidBody,c.Transform]);this.engine.addUpdate(cmsys.applyGravity.bind(cmsys),[c.Gravity,c.RigidBody]);this.engine.addUpdate(cmsys.applyImpulse.bind(cmsys),[c.Impulse,c.RigidBody]);this.engine.addUpdate(cmsys.applyPhysics.bind(cmsys),[c.RigidBody,c.Transform]);this.engine.addUpdate(clsys.detectCollision.bind(clsys),[c.AABBCollider,c.RigidBody,c.Transform]);this.engine.addUpdate(clsys.resolveCollision.bind(clsys),[c.AABBCollider,c.RigidBody,c.Transform]);this.engine.addUpdate(this.aisys.resolveInterception.bind(this.aisys),[c.State,c.Render,c.AABBCollider,c.RigidBody,c.Life,c.Transform]);this.engine.addUpdate(rdsys.updateInmunityBlink.bind(rdsys),[c.Render,c.Life]);this.engine.addUpdate(rdsys.updateRenderFlip.bind(rdsys),[c.Render,c.NoFlip]);this.engine.addUpdate(rdsys.updateRenderTransform.bind(rdsys),[c.Render,c.Transform]);this.engine.addUpdate(rdsys.updateShadowTransform.bind(rdsys),[c.Render,c.Shadow,c.Transform]);this.engine.addUpdate(rdsys.updateSword.bind(rdsys),[c.Sword,c.Render]);this.engine.addUpdate(rdsys.updateItem.bind(rdsys),[c.Item,c.Render]);this.engine.addUpdate(this.aisys.aimProjectile.bind(this.aisys),[c.State,c.Aim,c.Launcher,c.Render,c.Transform]);this.engine.addUpdate(rdsys.rotateProjectile.bind(rdsys),[c.Projectile,c.RigidBody,c.Render]);this.engine.addUpdate(this.aisys.jumpWhenNear.bind(this.aisys),[c.State,c.Jump,c.AABBCollider,c.RigidBody,c.Transform,c.Render]);this.engine.addUpdate(this.aisys.spawnHitBox.bind(this.aisys),[c.Attack,c.Render,c.Damage,c.RigidBody,c.Transform]);this.engine.addUpdate(this.aisys.spawnProjectiles.bind(this.aisys),[c.Launcher,c.Impulse,c.Render,c.Damage,c.Transform]);this.engine.addUpdate(this.aisys.removeProjectileOnTouch.bind(this.aisys),[c.Projectile,c.AABBCollider,c.Render]);this.engine.addUpdate(this.aisys.consumeLifespan.bind(this.aisys),[c.Lifespan]);this.engine.addUpdate(this.aisys.removeAfterDie.bind(this.aisys),[c.Die,c.Render,c.RigidBody,c.Transform,c.Gravity]);if(game.config.DEBUG){this.engine.addUpdate(function(dt,state,render){var tf=render.asset.getChildByName("stateName");var extra="";var c=self.engine.getComponentFromEntity(components.Player,state.entity);if(c){extra=Math.max(0,Math.round(c.cooldown*100)/100);}
tf.text=state.current+": "+extra;tf.scale.x=render.asset.scale.x;},[c.State,c.Render]);}
this.nextSpawn={delay:0,enemy:null,position:WONBATS.Vec2.create(0,0),wave:null,index:0};this.runLevel=true;this.enemiesKilled=0;this.enemiesCreated=0;this.unlockKills=0;this.cameraShake=WONBATS.Vec2.create(0,0);this.cameraShakeTime=0;this.cameraTargetId=null;this.transitionRunning=false;}
Level.prototype=Object.create(WONBATS.Screen.prototype);Level.prototype.constructor=Level;Level.prototype.enter=function(name,selectedSword,wave,score){this.gameEnded=JSON.parse(localStorage.getItem("ended"));WONBATS.Screen.prototype.enter.call(this,name);this.selectedSword=selectedSword;this.cameraContainer=new PIXI.Container();this.cameraContainer.scale.x=1;this.cameraContainer.scale.y=1;this.asset.addChild(this.cameraContainer);this.engine.start();this.currentBackgroundId=wave.backgroundId;this.backgroundData=game.config.BACKGROUNDS[this.currentBackgroundId];this.bg=new WONBATS.MovieClip(this.backgroundData.namespace,this.backgroundData.asset);this.bg.x=0;this.bg.y=0;this.cameraContainer.addChild(this.bg);this.bg.update(0);this.mcs.push(this.bg);this.gameplayContainer=this.bg.getChildByLayerName("gameplay");var swordConfig=swords.list[this.selectedSword];swordConfig.sword.components.Life[0]=game.config.PLAYER_LIVES;this.playerId=this.createEntity(swordConfig.sword,550,457);this.aisys.playerId=this.playerId;this.cameraTargetId=this.playerId;var shadow=this.engine.addComponentToEntity(components.Shadow,this.playerId);shadow.asset.gotoAndStop(6);shadow.asset.scale.x=shadow.asset.scale.y=shadow.scale*Math.min(Math.max(0.1,457/508),1);shadow.asset.update(0);this.createEntity(entities.FLOOR,550,540);this.createEntity(entities.FLOOR,550,-540);this.createEntity(entities.WALL,0,0);this.createEntity(entities.WALL,1100,0);this.createEntity(entities.ENEMY_FLOOR,550,540);this.createEntity(entities.ENEMY_WALL,-50,-1500);this.createEntity(entities.ENEMY_WALL,1150,-1500);var info=this.engine.getComponentFromEntity(components.Info,this.playerId);this.slingInput=new WONBATS.SlingInput(game.config.GAME_WIDTH,game.config.GAME_HEIGHT,info);this.asset.addChild(this.slingInput);var player=this.engine.getComponentFromEntity(components.Player,this.playerId);player.input=this.slingInput;this.createSling();this.runWave(wave);this.hitStunTime=0;this.ui=new WONBATS.MovieClip(ui,"ingameui");this.asset.addChild(this.ui);this.mcs.push(this.ui);this.ui.update(0);this.addButton("pauseButton",this.ui.getChildByName("btnPause"),this.onPause.bind(this));this.hearts=this.ui.getChildByName("hearts");this.hearts.gotoAndPlay("_"+swordConfig.sword.components.Life[0]);this.vambre=new WONBATS.MovieClip(vambre,"vambre");this.mcs.push(this.vambre);this.vambre.y=450;this.vambre.update(0);this.vambre.gotoAndStop("blank");this.vambreActivated=false;this.ui.addChild(this.vambre);this.paused=false;globalsignal.add(this.onGlobalSignal.bind(this));this.enemiesKilled=score||0;this.enemiesCreated=score||0;this.updateKills();this.createEmitters();if(score>0){this.createEnterTransition();}else{this.createTutorial();}
this.cameraCenter=[550,315];this.moveCamera(1000,550,315);game.config.SLING=JSON.parse(localStorage.getItem("sling"));};Level.prototype.createTutorial=function(){this.tutorialPopup=new WONBATS.MovieClip(tutorial,"tutorial");this.asset.addChild(this.tutorialPopup);this.tutorialPopup.update(0);this.tutorialPopup.getChildByName("tuto").gotoAndStop(window.mobileAndTabletcheck()?"touch":"mouse");this.removingTutorial=false;};Level.prototype.onRemoveTutorial=function(){if(this.tutorialPopup&&!this.removingTutorial){this.tutorialPopup.gotoAndPlay("out");this.removingTutorial=true;}};Level.prototype.createEnterTransition=function(){this.enterTransition=new WONBATS.MovieClip(transition,"transition");this.asset.addChild(this.enterTransition);this.enterTransition.update(0);this.enterTransition.gotoAndPlay("in");var swordAsset=this.engine.getComponentFromEntity(components.Sword,this.playerId).asset;this.enterTransition.getChildByName("sword").addChild(swordAsset);swordAsset.update(0);this.transitionRunning=true;};Level.prototype.createExitTransition=function(){this.ui.gotoAndPlay("out");this.exitTransition=new WONBATS.MovieClip(transition,"transition");this.asset.addChild(this.exitTransition);this.exitTransition.update(0);this.exitTransition.gotoAndPlay("out");this.slingInput.destroy();this.sling.visible=false;this.engine.getComponentFromEntity(components.Player,this.playerId).input=null;this.engine.removeComponentFromEntity(components.Life,this.playerId);this.transitionRunning=true;};Level.prototype.createEmitters=function(){var chainsawParticles=[PIXI.Texture.fromFrame("chainsawparticle_x"),];this.chainsawParticlesEmitter=new PIXI.particles.Emitter(this.gameplayContainer,chainsawParticles,game.config.particles.chainsawparticles);if(this.currentBackgroundId===0){var envParticles=[PIXI.Texture.fromFrame("lavaparticle1_x"),PIXI.Texture.fromFrame("lavaparticle2_x"),PIXI.Texture.fromFrame("lavaparticle3_x")];this.envParticlesEmitter=new PIXI.particles.Emitter(this.gameplayContainer,envParticles,game.config.particles.volcano);}else if(this.currentBackgroundId===1){var envParticles=[PIXI.Texture.fromFrame("spark1_x")];this.envParticlesEmitter=new PIXI.particles.Emitter(this.gameplayContainer,envParticles,game.config.particles.fireflight);}
var hitsparkParticles=[PIXI.Texture.fromFrame("spark2_x"),PIXI.Texture.fromFrame("spark3_x")];this.hitsparkEmitter=new PIXI.particles.Emitter(this.gameplayContainer,hitsparkParticles,game.config.particles.hitspark);var groundParticles=[PIXI.Texture.fromFrame("floorparticle_x"),];this.groundEmitter=new PIXI.particles.Emitter(this.gameplayContainer,groundParticles,game.config.particles.ground);};Level.prototype.onGlobalSignal=function(data,args){if(data==="tutorialEnd"){this.asset.removeChild(this.tutorialPopup);this.tutorialPopup=null;}else if(data==="transitionHideHero"){var render=this.engine.getComponentFromEntity(components.Render,this.playerId);render.asset.visible=false;var swordAsset=this.engine.getComponentFromEntity(components.Sword,this.playerId).asset;this.exitTransition.getChildByName("sword").addChild(swordAsset);swordAsset.update(0);}else if(data==="transitionInEnded"){this.asset.removeChild(this.enterTransition);this.enterTransition.dispose();this.enterTransition=null;this.transitionRunning=false;}else if(data==="transitionOutEnded"){for(var i=0;i<this.bg.layers.length;i++){this.bg.layers[i].attribs.visible=false;}
this.asset.removeChild(this.exitTransition);this.exitTransition.dispose();this.exitTransition=null;this.transitionRunning=false;this.transitionSignal.emit(this.name,"next",JSON.parse(JSON.stringify(this.selectedSword)),this.nextWave,this.enemiesKilled);}else if(data==="resume"){this.paused=false;this.buttons.pauseButton.setEnable(true);this.asset.removeChild(this.pauseModal);}else if(data==="shake"){this.shakeCamera(args.time,args.intensity);}else if(data==="spawnChainsawParticle"){var globalPosition=args.mc.toGlobal(new PIXI.Point(args.x,args.y));var position=this.gameplayContainer.toLocal(globalPosition);this.chainsawParticlesEmitter.updateSpawnPos(position.x,position.y);this.chainsawParticlesEmitter.emit=true;}else if(data==="spawnGroundParticle"){var globalPosition=args.mc.toGlobal(new PIXI.Point(args.x,args.y));var position=this.gameplayContainer.toLocal(globalPosition);this.groundEmitter.updateSpawnPos(position.x,position.y);this.groundEmitter.resetPositionTracking();this.groundEmitter.emit=true;}else if(data==="hitsparkParticle"){this.hitsparkEmitter.updateSpawnPos(args.x,args.y);this.hitsparkEmitter.resetPositionTracking();this.hitsparkEmitter.emit=true;}else if(data==="sound"){if(WONBATS.isArray(args)){args=WONBATS.getRandomFromArray(args);}
game.soundManager.playSfx(args);}else if(data==="vambre_activated"){this.vambreActivated=true;}else if(data==="vambre_deactivated"){this.vambreActivated=false;}};Level.prototype.createSling=function(){if(!this.sling){this.sling=new WONBATS.MovieClip(ring,"ring");this.gameplayContainer.addChild(this.sling);this.sling.update(0);this.mcs.push(this.sling);}
var info=this.engine.getComponentFromEntity(components.Info,this.playerId);for(var key in info.data.swipes){this.sling.getChildByName(key).gotoAndStop(info.data.swipes[key].hasOwnProperty("projectile")?"range":"melee");}};Level.prototype.onPause=function(){if(this.endingTime)return;this.paused=true;this.buttons.pauseButton.setEnable(false);if(this.pauseModal){this.asset.addChild(this.pauseModal);this.pauseModal.gotoAndPlay("in");this.buttons.homeButton.setEnable(true);this.buttons.resumeButton.setEnable(true);}else if(this.paused){this.pauseModal=new WONBATS.MovieClip(ui,"pausemodal");this.asset.addChild(this.pauseModal);this.pauseModal.update(0);this.updateSoundButton();this.updateSlingButton();this.addButton("homeButton",this.pauseModal.getChildByName("btnHome"),this.onHome.bind(this));this.addButton("resumeButton",this.pauseModal.getChildByName("btnResume"),this.onResume.bind(this));this.addButton("soundOnButton",this.pauseModal.getChildByName("btnSound").getChildByName("soundOn"),this.onSound.bind(this));this.addButton("soundOffButton",this.pauseModal.getChildByName("btnSound").getChildByName("soundOff"),this.onSound.bind(this));this.addButton("fullScreenButton",this.pauseModal.getChildByName("btnFullscreen"),this.onFullscreen.bind(this));this.addButton("slingOnButton",this.pauseModal.getChildByName("btnSling").getChildByName("slingOn"),this.onSlingInput.bind(this));this.addButton("slingOffButton",this.pauseModal.getChildByName("btnSling").getChildByName("slingOff"),this.onSlingInput.bind(this));}
if(!WONBATS.isSpecialMusicPlaying()){game.soundManager.fadeVolume("music_background",1,0.05);game.soundManager.fadeVolume("music_foreground",1,0.05);}else{var specialMusic=WONBATS.getSpecialMusic();game.soundManager.fadeVolume(specialMusic,1,0.05);}};Level.prototype.onSlingInput=function(){game.config.SLING=JSON.parse(localStorage.getItem("sling"));(game.config.SLING)?game.config.SLING=false:game.config.SLING=true;localStorage.setItem("sling",JSON.stringify(game.config.SLING));this.updateSlingButton();};Level.prototype.updateSlingButton=function(){var slingOn=this.pauseModal.getChildByName("btnSling").getChildByName("slingOn");var slingOff=this.pauseModal.getChildByName("btnSling").getChildByName("slingOff");game.config.SLING=JSON.parse(localStorage.getItem("sling"));if(game.config.SLING){slingOff.attribs.visible=false;slingOff.interactive=false;slingOn.interactive=true;slingOn.attribs.visible=true;}else{slingOff.interactive=true;slingOff.attribs.visible=true;slingOn.attribs.visible=false;slingOn.interactive=false;}};Level.prototype.onFullscreen=function(e){game.toggleFullScreen();};Level.prototype.onSound=function(e){game.soundManager.switchMute();this.updateSoundButton();};Level.prototype.updateSoundButton=function(){var soundOn=this.pauseModal.getChildByName("btnSound").getChildByName("soundOn");var soundOff=this.pauseModal.getChildByName("btnSound").getChildByName("soundOff");if(game.soundManager.isMuted()){soundOff.attribs.visible=true;soundOff.interactive=true;soundOn.interactive=false;soundOn.attribs.visible=false;}else{soundOff.interactive=false;soundOff.attribs.visible=false;soundOn.attribs.visible=true;soundOn.interactive=true;}};Level.prototype.onResume=function(){this.buttons.homeButton.setEnable(false);this.buttons.resumeButton.setEnable(false);this.pauseModal.gotoAndPlay("out");var delay=700;if(!WONBATS.isSpecialMusicPlaying()){game.soundManager.fadeVolume("music_background",delay,0,true);game.soundManager.fadeVolume("music_foreground",delay,0,true);}else{var specialMusic=WONBATS.getSpecialMusic();game.soundManager.fadeVolume(specialMusic,delay,0,true);}};Level.prototype.onHome=function(){if(this.buttons.homeButton){this.buttons.homeButton.setEnable(false);}
if(this.buttons.resumeButton){this.buttons.resumeButton.setEnable(false);}
WONBATS.stopSpecialMusic();this.transitionSignal.emit(this.name,"exit",JSON.parse(JSON.stringify(this.selectedSword)));};Level.prototype.showPortal=function(x,y){var portal=new WONBATS.MovieClip(portals,"portal");this.gameplayContainer.addChildAt(portal,0);portal.removePortal=this.removePortal.bind(this);portal.update(0);portal.x=x;portal.y=y;this.mcs.push(portal);};Level.prototype.removePortal=function(portal){this.gameplayContainer.removeChild(portal);portal.dispose();portal.removePortal=null;var index=this.mcs.indexOf(portal);this.mcs.splice(index,1);};Level.prototype.createEntity=function(entity,x,y){var id=this.engine.createEntity();var container=new PIXI.Container();this.gameplayContainer.addChild(container);var isBoss=(entity===entities.BOSS_PHIL||entity===entities.BOSS_REX||entity===entities.BOSS_NOHYAS);if(isBoss){this.cameraTargetId=id;this.bossIntroTime=JSON.parse(JSON.stringify(game.config.BOSS_INTRO_TIME));this.ui.gotoAndPlay("out");}
if(entity.asset){var mc=new WONBATS.MovieClip(entity.asset.namespace,entity.asset.name);mc.scale.x=entity.asset.scale;mc.scale.y=entity.asset.scale;if(entity.components.AABBCollider){mc.x=entity.components.AABBCollider[2];mc.y=entity.components.AABBCollider[3];}
container.addChild(mc);if(entity.asset.shadowScale&&entity.asset.shadowScale>0){var shadowAsset=new WONBATS.MovieClip(shadows,"shadow");shadowAsset.x=x;shadowAsset.y=508;var shadow=this.engine.addComponentToEntity(components.Shadow,id);shadow.initialize(shadowAsset,entity.asset.shadowScale);this.gameplayContainer.addChildAt(shadowAsset,0);shadowAsset.update(0);shadowAsset.children[0].gotoAndStop(this.backgroundData.shadow);shadowAsset.children[0].update(0);}
if(entity.asset.label){if(entity.asset.play){mc.gotoAndPlay(entity.asset.label);}else{mc.gotoAndStop(entity.asset.label);}}}
if(game.config.DEBUG&&entity.components.AABBCollider){var w=entity.components.AABBCollider[0];var h=entity.components.AABBCollider[1];var graphics=new PIXI.Graphics();graphics.lineStyle(2,0xFFFFFF,0.5);graphics.beginFill(0x333333,0.25);graphics.drawRect(-w/2,-h/2,w,h);graphics.endFill();graphics.name="debughitbox";container.addChild(graphics);}
if(game.config.DEBUG&&entity.components.State){var stbg=new PIXI.Graphics();stbg.lineStyle(2,0x000044,0.75);stbg.beginFill(0x0000FF,0.5);stbg.drawRect(-30,-10,60,20);stbg.endFill();stbg.name="state";container.addChild(stbg);var sttf=new PIXI.Text("",{fontFamily:'Arial',fontSize:12,fill:0xffffff,align:'center'});sttf.anchor.x=sttf.anchor.y=0.5;sttf.name="stateName";container.addChild(sttf);}
for(var c in entity.components){var component=this.engine.addComponentToEntity(components[c],id);component.initialize.apply(component,entity.components[c]);}
var transform=this.engine.addComponentToEntity(components.Transform,id);transform.initialize(x||0,y||0);var render=this.engine.addComponentToEntity(components.Render,id);render.initialize(container);if(entity.info){var info=this.engine.addComponentToEntity(components.Info,id);info.initialize(entity.info);}
if(entity.components.Enemy){this.enemiesCreated++;var playerTransform=this.engine.getComponentFromEntity(components.Transform,this.playerId);if(playerTransform){this.engine.components["Bouncer"][id].multiplier=Math.sign(playerTransform.position[0]-transform.position[0]);this.engine.components["Flyer"][id].multiplier=Math.sign(playerTransform.position[0]-transform.position[0]);this.engine.components["Runner"][id].multiplier=Math.sign(playerTransform.position[0]-transform.position[0]);}}
return id;};Level.prototype.removeEntity=function(entityId){var render=this.engine.getComponentFromEntity(components.Render,entityId);render.asset.parent.removeChild(render.asset);if(render.asset.children[0]&&render.asset.children[0].dispose){render.asset.children[0].dispose();}
var shadow=this.engine.getComponentFromEntity(components.Shadow,entityId);if(shadow&&shadow.asset){shadow.asset.parent.removeChild(shadow.asset);shadow.asset.dispose();}
this.engine.removeEntity(entityId);if(this.playerId===entityId){this.runLevel=false;this.onHome();}};Level.prototype.onEntityKilled=function(entityId){if(this.engine.getComponentFromEntity(components.Enemy,entityId)){var transform=this.engine.getComponentFromEntity(components.Transform,entityId);var render=this.engine.getComponentFromEntity(components.Render,entityId);var noDrop=this.engine.getComponentFromEntity(components.NoDrop,entityId);this.enemiesKilled++;if(!noDrop){this.unlockKills++;}
var dropPrize=this.updateKills();if(!dropPrize&&!noDrop){if(Math.random()<game.config.ITEM_DROP_CHANCE){dropPrize=entities.HEART_PRIZE;}}
if(dropPrize){console.log("Item Asset"+dropPrize.asset.name);var prizeId=this.createEntity(dropPrize,transform.position[0],transform.position[1]);var prizeItem=this.engine.getComponentFromEntity(components.Item,prizeId);prizeItem.added=false;var prizeRigidBody=this.engine.getComponentFromEntity(components.RigidBody,prizeId);var prizeTransform=this.engine.getComponentFromEntity(components.Transform,prizeId);if(transform.position[0]<300){prizeRigidBody.velocity[0]=Math.random()*300;}else if(transform.position[0]>800){prizeRigidBody.velocity[0]=Math.random()*-300;}else{prizeRigidBody.velocity[0]=-300+Math.random()*600;}
var halfHeight=render.asset.height/2;prizeTransform.position[1]-=halfHeight+(Math.random()*halfHeight);prizeRigidBody.velocity[1]=-1000+(Math.random()*300);}}};Level.prototype.updateKills=function(){var killsContainer=this.ui.getChildByName("kills");killsContainer.gotoAndPlay("add");var numContainer=killsContainer.getChildByName("num");var nextSwordIndex=JSON.parse(localStorage.getItem("progress"))[0];var killsLeft=1;var requiredKills=swords.allUnlockedKills;var kills=this.unlockKills.toString();if(nextSwordIndex<swords.list.length){requiredKills=JSON.parse(JSON.stringify(swords.list[nextSwordIndex].kills));}
killsLeft=requiredKills-kills;var enemiesKilledClamped=Math.clamp(this.enemiesKilled,0,999);var enemiesKilled=String(enemiesKilledClamped);for(var i=0;i<4;i++){var num=numContainer.getChildByName("number"+(i+1));if(i<enemiesKilled.length){var value=Number(enemiesKilled[(enemiesKilled.length-1)-i]);num.gotoAndStop(value);}else{num.gotoAndStop(10);}}
var dropSword=null;if(killsLeft===0){this.unlockKills=0;var progress=JSON.parse(localStorage.getItem("progress"));if(progress[0]<swords.list.length){dropSword=entities.SWORD_PRIZE;dropSword.components.Item[1]=swords.list[nextSwordIndex].sword;progress[0]+=1;localStorage.setItem("progress",JSON.stringify(progress));}else{dropSword=entities.SWORD_PRIZE;var randomSword=WONBATS.getRandomFromArray(swords.list,[this.selectedSword]).sword;dropSword.components.Item[1]=randomSword;}
dropSword.components.Item[4]=dropSword.components.Item[1].components.Sword[0];this.updateKills();}
return dropSword;};Level.prototype.runWave=function(wave,index){index=index||0;var life=this.engine.getComponentFromEntity(components.Life,this.playerId);if(!life)return;if(life.points<=0)return;if(wave.hasOwnProperty("backgroundId")&&this.currentBackgroundId!==wave.backgroundId){this.nextWave=wave;this.waveMusic(wave);if(!this.transitionRunning){this.createExitTransition();}}else{if(index<wave.config.length){var nextEnemy=wave.config[index];this.nextSpawn.delay=nextEnemy.delay||0;this.nextSpawn.enemy=nextEnemy.type[Math.floor(Math.random()*nextEnemy.type.length)];this.nextSpawn.position[0]=nextEnemy.x;this.nextSpawn.position[1]=nextEnemy.y;this.nextSpawn.wave=wave;this.nextSpawn.index=index;this.waveMusic(nextEnemy);}else{this.nextSpawn.enemy=null;}}};Level.prototype.waveMusic=function(data){if(data.music){for(var i=0;i<data.music.length;i++){var music=data.music[i];var id=music.id||null;var delay=music.delay||0;var volume=music.volume||0;var restore=music.restore||false;var stopAtZero=music.stopAtZero||false;console.log("id: "+id);console.log("delay: "+delay);console.log("volume: "+volume);console.log("restore: "+restore);console.log("stopAtZero: "+stopAtZero);var sound=game.soundManager.getSound(id);console.log("sound exists?: "+sound);if(!sound||(!game.soundManager.isPlaying(id)&&volume>0)){game.soundManager.play(id);}
game.soundManager.fadeVolume(id,delay,volume,restore,stopAtZero);}}};Level.prototype.onEntityHurt=function(lifeComp,previousLives){var hurtedId=lifeComp.entity;if(hurtedId===this.playerId){if(previousLives<lifeComp.points){this.hearts.gotoAndPlay("_"+(lifeComp.points-1)+"gain");}else if(previousLives>lifeComp.points){this.hearts.gotoAndPlay("_"+lifeComp.points);this.showVambre(["cringe","scream"]);}}else{if(previousLives>lifeComp.points){this.showVambre(["laughs","cheers","happy"]);}}};Level.prototype.showVambre=function(labels){var randomValue=Math.random();if(!this.vambreActivated&&(randomValue<game.config.VAMBRE_APPEARANCE_CHANCE)){var label=WONBATS.getRandomFromArray(labels);this.vambre.gotoAndStop(label);}};Level.prototype.onEntitiesOverlap=function(time){this.hitStunTime=time;};Level.prototype.onItemPickup=function(entityId){var item=this.engine.getComponentFromEntity(components.Item,entityId);console.log("Item picked!",entityId,item.type);if(item.type===components.Item.HEART){var life=this.engine.getComponentFromEntity(components.Life,this.playerId);var previousLives=life.points;life.points=Math.clamp(life.points,life.points+1,game.config.PLAYER_LIVES);this.onEntityHurt(life,previousLives);}else if(item.type===components.Item.SWORD){this.changeSword(item.config);}
this.removeEntity(entityId);};Level.prototype.changeSword=function(entityConfig){var collider=this.engine.getComponentFromEntity(components.AABBCollider,this.playerId);var playerIsOnTheFloor=collider.isOnTheFloor();for(var k in entityConfig.components){console.log("Change",k);if(k==="Player"||k==="RigidBody"||k==="Life"){}else{var component=this.engine.components[components[k].name][this.playerId];component.initialize.apply(component,entityConfig.components[k]);}}
var state=this.engine.getComponentFromEntity(components.State,this.playerId);if(playerIsOnTheFloor){state.next="idle";}else{state.next="airIdle";}
var render=this.engine.getComponentFromEntity(components.Render,this.playerId);render.newAnimation=true;var info=this.engine.getComponentFromEntity(components.Info,this.playerId);info.initialize(entityConfig.info);this.createSling();for(var i=0;i<swords.list.length;i++){if(swords.list[i].sword===entityConfig){this.selectedSword=i;break;}}}
Level.prototype.update=function(dt){if(this.tutorialPopup){this.tutorialPopup.update(dt);}
if(this.endingTime){if(this.endingTime>0){this.endingTime-=dt;dt*=game.config.ENDING_DELTA_TIME;}else{this.transitionSignal.emit(this.name,"win",JSON.parse(JSON.stringify(this.selectedSword)));}}
if(this.bossIntroTime){if(this.bossIntroTime>0){this.bossIntroTime-=dt;dt*=game.config.BOSS_INTRO_DELTA_TIME;}else{this.cameraTargetId=this.playerId;this.bossIntroTime=null;this.ui.gotoAndPlay("in");}}
if(this.transitionRunning&&this.enterTransition){this.enterTransition.update(dt);this.moveCamera(dt,550,315);return;}
if(this.transitionRunning&&this.exitTransition){this.exitTransition.update(dt);}
if(!this.paused){if(this.envParticlesEmitter){this.envParticlesEmitter.update(dt);}
this.hitsparkEmitter.update(dt);this.groundEmitter.update(dt);this.hitStunTime-=dt;if(this.hitStunTime<=0){this.engine.update(dt);}
for(var i=0;i<this.mcs.length;i++){this.mcs[i].update(dt);}}
if(!this.paused){if(this.runLevel){var rendercomp=this.engine.getComponentFromEntity(components.Render,this.cameraTargetId);if(!this.exitTransition){if(this.cameraTargetId===this.playerId){this.applySling(rendercomp);this.spawnEnemy(dt);}}
if(rendercomp&&rendercomp.asset){this.cameraX=rendercomp.asset.x;this.cameraY=rendercomp.asset.y;}
this.chainsawParticlesEmitter.update(dt);}}
this.moveCamera(dt,this.cameraX,this.cameraY);if(!this.exitTransition&&this.pauseModal&&this.paused){this.pauseModal.update(dt);}};Level.prototype.spawnEnemy=function(dt){this.nextSpawn.delay-=dt;if(this.nextSpawn.delay<=0&&this.nextSpawn.enemy){this.showPortal(this.nextSpawn.position[0],this.nextSpawn.position[1]);this.createEntity(this.nextSpawn.enemy,this.nextSpawn.position[0],this.nextSpawn.position[1]);this.runWave(this.nextSpawn.wave,this.nextSpawn.index+1);}
if(this.enemiesCreated-this.enemiesKilled===0){if(this.nextSpawn.enemy){this.nextSpawn.delay=0;}else{if(this.nextSpawn.wave.ending&&!this.gameEnded){this.createEnding();}else if(this.nextSpawn.wave.next){this.runWave(waves[this.nextSpawn.wave.next],0);}}}};Level.prototype.createEnding=function(){this.runLevel=false;this.slingInput.destroy();this.endingTime=JSON.parse(JSON.stringify(game.config.ENDING_TIME));this.ui.gotoAndPlay("out");localStorage.setItem("ended",JSON.stringify(true));game.soundManager.fadeVolume("music_boss",1000,0,false,true);};Level.prototype.applySling=function(rendercomp){var collider=this.engine.getComponentFromEntity(components.AABBCollider,this.playerId);if(this.sling&&this.slingInput.down&&rendercomp&&collider){this.sling.x=rendercomp.asset.x;this.sling.y=rendercomp.asset.y;this.sling.getChildByLayerName("arrow").rotation=this.slingInput.getArrowRotation();var info=this.engine.getComponentFromEntity(components.Info,this.playerId);var quad=this.slingInput.currentQuad;if(info&&quad){var isRange=info.data.swipes[quad].hasOwnProperty("projectile");var cancelOnTheFloor=info.data.swipes[quad].cancelOnTheFloor;this.sling.getChildByLayerName("arrow").gotoAndStop(isRange?"range":"melee");if(this.sling.getChildByLayerName("arrow").rotation>Math.PI/2||this.sling.getChildByLayerName("arrow").rotation<-Math.PI/2){this.sling.getChildByLayerName("arrow").scale.y=-1;}else{this.sling.getChildByLayerName("arrow").scale.y=1;}
this.sling.getChildByLayerName("arrow").alpha=cancelOnTheFloor&&collider.isOnTheFloor()?0.33:1;}
this.sling.scale.x=this.sling.scale.y=this.slingInput.getScale();this.sling.visible=true;}else{this.sling.visible=false;}};Level.prototype.moveCamera=function(dt,x,y){var shakeX=0;var shakeY=0;this.cameraShakeTime-=dt;if(this.cameraShakeTime>0){shakeX=-this.cameraShake[0]/2+Math.random()*this.cameraShake[0];shakeY=-this.cameraShake[1]/2+Math.random()*this.cameraShake[1];}
var displX=0;var displY=0;var rigidbody=this.engine.getComponentFromEntity(components.RigidBody,this.playerId);if(rigidbody){displX=rigidbody.velocity[0]*game.config.CAMERA_DISPL[0];displY=rigidbody.velocity[1]*game.config.CAMERA_DISPL[1];}
var cameraNextX=Math.min(Math.max(425,x+displX),675);var cameraNextY=Math.min(Math.max(-100,y+displY),315);this.cameraCenter[0]+=(cameraNextX-this.cameraCenter[0])*dt*5;this.cameraCenter[1]+=(cameraNextY-this.cameraCenter[1])*dt*5;this.cameraCenter[0]+=shakeX;this.cameraCenter[1]+=shakeY;this.cameraContainer.x=-this.cameraCenter[0]*this.cameraContainer.scale.x+game.config.GAME_WIDTH/2;this.cameraContainer.y=-this.cameraCenter[1]*this.cameraContainer.scale.y+game.config.GAME_HEIGHT/2;for(var i=0;i<this.bg.layers.length;i++){var layer=this.bg.layers[i];layer.x=-this.cameraCenter[0]*(this.backgroundData.parallax[i])+(1100/2)*(this.backgroundData.parallax[i]);layer.y=-this.cameraCenter[1]*(this.backgroundData.parallax[i]/10)+(550/2)*(this.backgroundData.parallax[i]/10);}};Level.prototype.shakeCamera=function(time,intensity){this.cameraShake[0]=this.cameraShake[1]=intensity;this.cameraShakeTime=time;}
Level.prototype.exit=function(name){globalsignal.clear();this.ui=null;this.pauseModal=null;this.aisys.dispose();this.aisys=null;this.engine.dispose();this.engine=null;this.chainsawParticlesEmitter.destroy();this.chainsawParticlesEmitter=null;if(this.envParticlesEmitter){this.envParticlesEmitter.destroy();this.envParticlesEmitter=null;}
this.hitsparkEmitter.destroy();this.hitsparkEmitter=null;this.groundEmitter.destroy();this.groundEmitter=null;WONBATS.Screen.prototype.exit.call(this,name);};game.screens.Level=Level;}());