pc.script.attribute("messageTime","number",3),pc.script.create("MissionManager",function(a){var b=function(a){this.entity=a,this.missions=[],this._currentMission=null,this.showCongScene=!1};return b.prototype={initialize:function(){this.levelController=a.root.findByName("Master").script.LevelController,this.missionFailedPanel=this.entity.findByName("MissionFailedPanel"),this.missionFailedContentFont=this.missionFailedPanel.findByName("Content").script.font_renderer,this.missionCompletePanelEntity=this.entity.findByName("MissionCompletePanel"),this.missionRestartButtonScript=this.missionFailedPanel.findByName("RestartButton").script.Button,this.missionRestartButtonScript.on("onPointerUp",this._restartCurrentMission,this),this.indicator=this.entity.findByName("MissionIndicator"),this.indicatorInverval=.4,this.isIndicatorOn=!1,this.missionDetail=this.entity.findByName("MissionDetail"),this.xButton=this.missionDetail.findByName("XButton").script.Button,this.missionName1=this.missionDetail.findByName("Name1").script.font_renderer,this.missionName2=this.missionDetail.findByName("Name2").script.font_renderer,this.xButton.on("onPointerUp",this._onXButton,this),this.popup=a.root.findByName("PopupMessage").script.PopupMessage,this.upgradeSystemScript=a.root.findByName("UpgradeSystem").script.UpgradeSystem,this.missionWindowEntity=this.entity.findByName("MissionWindow"),this.timerWindowEntity=this.entity.findByName("TimerWindow"),this.missionDestcriptionScript=this.entity.findByName("MissionDescription").script.font_renderer,this.missionTimerFontScript=this.entity.findByName("MissionTimer").script.font_renderer,this.currentMessage=null,this.logoCatchEntity=this.entity.findByName("Logo_Catch"),this.logoRingEntity=this.entity.findByName("Logo_Ring"),this.logoCombatEntity=this.entity.findByName("Logo_Combat"),this.logoRedlightEntity=this.entity.findByName("Logo_Redlight"),this.isShowingMessage=!1,this.messageTimer=this.messageTime,this.playerScript=a.root.findByName("Player").script.PlayerController},postInitialize:function(){this._initializeAllMission()},update:function(a){"pause"!==this.levelController.current&&(this.missionStarted&&this._checkMissionFail(a)&&this._fail(),this.isShowingMessage&&(this.messageTimer-=a,this.messageTimer<0&&(this.missionDetail.enabled?(this._startMission(),this.currentMessage=null):this.missionFailedPanel.enabled?(this._exitMission(),this.currentMessage=null):this.missionCompletePanelEntity.enabled&&(this.missionCompletePanelEntity.enabled=!1,this.currentMessage=null),this.isShowingMessage=!1)))},onEnable:function(){this.levelController.on("pause",this._onGamePause,this)},onDisable:function(){this.levelController.off("pause",this._onGamePause,this)},registerMission:function(a){this.missions.push(a)},unregisterMission:function(a){var b=this.missions.indexOf(a);return b>-1?(this.missions.splice(b,1),!0):!1},showMission:function(a){if(!this._currentMission){null!=this.currentMessage&&(this.currentMessage.enabled=!1),this._currentMission=a,this.missionDetail.enabled=!0;var b=this._currentMission.displayName.split(",");switch(this.missionName1.text=b[0],null!=b[1]?this.missionName2.text=b[1]:this.missionName2.text="",a.type){case MissionTypes.A_TO_B:this.missionName1.x=textDic.Mission.AToB.offsetX,this.missionName2.x=textDic.Mission.AToB.offsetX,this.missionName1.y=textDic.Mission.AToB.offsetY_1,this.missionName2.y=textDic.Mission.AToB.offsetY_2,this.missionName1.scaleX=textDic.Mission.AToB.size,this.missionName1.scaleY=textDic.Mission.AToB.size,this.missionName2.x.scaleX=textDic.Mission.AToB.size,this.missionName2.x.scaleY=textDic.Mission.AToB.size;break;case MissionTypes.RING:this.missionName1.x=textDic.Mission.Rings.offsetX,this.missionName2.x=textDic.Mission.Rings.offsetX,this.missionName1.y=textDic.Mission.Rings.offsetY_1,this.missionName2.y=textDic.Mission.Rings.offsetY_2,this.missionName1.scaleX=textDic.Mission.Rings.size,this.missionName1.scaleY=textDic.Mission.Rings.size,this.missionName2.x.scaleX=textDic.Mission.Rings.size,this.missionName2.x.scaleY=textDic.Mission.Rings.size;break;case MissionTypes.COMBAT:a.entity.getName().indexOf("Bowling")>-1?(this.missionName1.x=textDic.Mission.Bowling.offsetX,this.missionName2.x=textDic.Mission.Bowling.offsetX,this.missionName1.y=textDic.Mission.Bowling.offsetY_1,this.missionName2.y=textDic.Mission.Bowling.offsetY_2,this.missionName1.scaleX=textDic.Mission.Bowling.size,this.missionName1.scaleY=textDic.Mission.Bowling.size,this.missionName2.x.scaleX=textDic.Mission.Bowling.size,this.missionName2.x.scaleY=textDic.Mission.Bowling.size):(this.missionName1.x=textDic.Mission.Combat.offsetX,this.missionName2.x=textDic.Mission.Combat.offsetX,this.missionName1.y=textDic.Mission.Combat.offsetY_1,this.missionName2.y=textDic.Mission.Combat.offsetY_2,this.missionName1.scaleX=textDic.Mission.Combat.size,this.missionName1.scaleY=textDic.Mission.Combat.size,this.missionName2.x.scaleX=textDic.Mission.Combat.size,this.missionName2.x.scaleY=textDic.Mission.Combat.size);break;case MissionTypes.CATCH:this.missionName1.x=textDic.Mission.Snitch.offsetX,this.missionName2.x=textDic.Mission.Snitch.offsetX,this.missionName1.y=textDic.Mission.Snitch.offsetY_1,this.missionName2.y=textDic.Mission.Snitch.offsetY_2,this.missionName1.scaleX=textDic.Mission.Snitch.size,this.missionName1.scaleY=textDic.Mission.Snitch.size,this.missionName2.x.scaleX=textDic.Mission.Snitch.size,this.missionName2.x.scaleY=textDic.Mission.Snitch.size;break;case MissionTypes.BOSS:this.missionName1.x=textDic.Mission.Boss.offsetX,this.missionName2.x=textDic.Mission.Boss.offsetX,this.missionName1.y=textDic.Mission.Boss.offsetY_1,this.missionName2.y=textDic.Mission.Boss.offsetY_2,this.missionName1.scaleX=textDic.Mission.Boss.size,this.missionName1.scaleY=textDic.Mission.Boss.size,this.missionName2.x.scaleX=textDic.Mission.Boss.size,this.missionName2.x.scaleY=textDic.Mission.Boss.size}switch(this.missionName1.updateText(),this.missionName2.updateText(),this.isShowingMessage=!0,this.messageTimer=this.messageTime,this.currentMessage=this.missionDetail,this.logoRedlightEntity.enabled=!1,this.logoCatchEntity.enabled=!1,this.logoCombatEntity.enabled=!1,this.logoRingEntity.enabled=!1,a.type){case MissionTypes.A_TO_B:this.logoRedlightEntity.enabled=!0;break;case MissionTypes.CATCH:this.logoCatchEntity.enabled=!0;break;case MissionTypes.COMBAT:case MissionTypes.BOSS:this.logoCombatEntity.enabled=!0;break;case MissionTypes.RING:this.logoRingEntity.enabled=!0}this.fire("playAudio","Music","stinger"),this.fire("playAudio","SFX","bg")}},missionComplete:function(a){if(Storage.addMutagen(1),Storage.addUpgradeMutagen(1),Storage.setMission(this.levelController.levelId,a.entity.getName(),FINISHED_MISSION),""!==a.unlockNextMission)for(var b=a.unlockNextMission.replace(/\s+/g,""),c=b.split(","),d=0;d<c.length;d++){var e=this.entity.findByName(c[d]);e?(Storage.setMission(this.levelController.levelId,c[d],AVAILABLE_MISSION),e.enabled=!0):console.warn("Could not find mission "+c[d]+". Last mission is "+a.displayName)}this.upgradeSystemScript.canUpgrade()&&this.levelController.showNotification(),this.missionStarted=!1,this._complete(a.displayName)},_initializeAllMission:function(){Storage.getLevelComplete()&&Storage.setMission(this.levelController.levelId,"S_Snitch_Boss",AVAILABLE_MISSION);for(var a=this.entity.findByName("Game Missions").getChildren(),b=[],c=0;c<a.length;c++){var d=a[c],e=d.getName(),f=Storage.getMission(this.levelController.levelId,e);switch(f){case FINISHED_MISSION:b.push(d);break;case LOCKED_MISSION:d.enabled=!1;break;case AVAILABLE_MISSION:d.enabled=!0;break;default:d.enabled?Storage.setMission(this.levelController.levelId,e,AVAILABLE_MISSION):Storage.setMission(this.levelController.levelId,e,LOCKED_MISSION)}}for(var c=0;c<b.length;c++)b[c].destroy()},_checkMissionFail:function(a){return this.timer-=a,this.timer<0?!0:(this.timer<10&&!this.isPlayingCountdownSFX&&(this.isPlayingCountdownSFX=!0,this.fire("playAudio","SFX","countdown")),this._updateTimer(),!1)},_updateTimer:function(){var a=this.timer/60;a=Math.floor(a);var b=this.timer%60;b=Math.floor(b),10>a&&(a="0"+a.toString()),10>b&&(b="0"+b.toString()),this.timer<=10&&0!==this.missionTimerFontScript.tint.g&&this.missionTimerFontScript.tint.set(1,0,0,1),this.missionTimerFontScript.text=a+":"+b},_fail:function(){pc.Utils.debug("MissionManager","_fail",this._currentMission.displayName+" failed"),this._currentMission&&(this.fire("playAudio","VO","missionFail",!0),this.fire("playAudio","SFX","missionFail"),this.fire("playAudio","SFX","stop","countdown"),this._currentMission.failMission(),this.missionStarted=!1,this.timer=0,this.missionFailedPanel.enabled=!0,this.currentMessage=this.missionFailedPanel,this.isShowingMessage=!0,this.messageTimer=this.messageTime,this._currentMission.start.enabled=!0)},_exitMission:function(a){this.fire("playAudio","Music","flying"),this.levelController.inMission=!1,this.updrafts&&(this.updrafts.enabled=!1),this._currentMission=null,this.missionFailedPanel.enabled=!1,this.missionWindowEntity.enabled=!1,this.timerWindowEntity.enabled=!1;for(var b=0;b<this.missions.length;b++)this.missions[b].enableMission();a&&(this._checkAllMissionsComplete()&&Storage.setLevelComplete(!0),this.playerScript.celebrationEvent())},_complete:function(a){this._currentMission&&(this._currentMission.boss?this.fire("playAudio","VO","bossDefeated",!0):this.fire("playAudio","VO","missionComplete",!0),this.fire("playAudio","SFX","missionComplete"),this.fire("playAudio","SFX","stop","countdown"),this.missionCompletePanelEntity.enabled=!0,this.currentMessage=this.missionCompletePanelEntity,this.isShowingMessage=!0,this.messageTimer=this.messageTime-1,this.unregisterMission(this._currentMission),this._currentMission&&this._currentMission.destroyMission(),this._exitMission(!0))},_checkAllMissionsComplete:function(){for(var a=this.entity.findByName("Game Missions").getChildren(),b=0;b<a.length;b++){var c=a[b];if(c&&c.enabled)return!1}return!0},_restartCurrentMission:function(){if(this._currentMission){this.isShowingMessage=!1,this.missionFailedPanel.enabled=!1,this.currentMessage=null;var a=this._currentMission.start.getPosition();this.playerScript.teleport(a.x,a.y+15,a.z),this.playerScript._setFlyAlongside(0,"scrapeBuilding"),this._startMission()}},_startMission:function(){if(this._currentMission){switch(this._currentMission.type){case MissionTypes.COMBAT:this.fire("playAudio","Music","battle"),this.fire("playAudio","VO","missionStart",!0);break;case MissionTypes.BOSS:this.fire("playAudio","Music","battle"),this.fire("playAudio","VO","bossMissionStart",!0);break;case MissionTypes.RING:case MissionTypes.A_TO_B:case MissionTypes.CATCH:this.fire("playAudio","Music","nonBattle"),this.fire("playAudio","VO","missionStart",!0);break;default:console.warn("_currentMission is null")}this.fire("playAudio","SFX","stop","bg"),this.isPlayingCountdownSFX=!1,this.levelController.inMission=!0,pc.Utils.debug("MissionManager","_startMission","Accept Mission "+this._currentMission.displayName),this.missionWindowEntity.enabled=!0,this.timerWindowEntity.enabled=!0,this.missionTimerFontScript.tint.set(1,1,1,1),this.missionDestcriptionScript.text=this.missionName1.text+" "+this.missionName2.text,this.missionDetail.enabled=!1,this._currentMission.startMission(),this._currentMission.start.enabled=!1,this.timer=this._currentMission.time,this.missionStarted=!0,this.updrafts=this._currentMission.entity.findByName("Updrafts"),this.updrafts&&(this.updrafts.enabled=!0);for(var a=0;a<this.missions.length;a++)this.missions[a]!==this._currentMission&&this.missions[a].disableMission()}},_onXButton:function(){this.isShowingMessage&&this.missionDetail.enabled&&(this.messageTimer=-1)},_onGamePause:function(a){this.currentMessage&&(this.currentMessage.enabled=!a)}},b});