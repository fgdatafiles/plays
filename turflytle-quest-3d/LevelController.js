var WIDTH=0,HEIGHT=0,DEVICE=0,PhysicsBits={};PhysicsBits.PLAYER=2,PhysicsBits.SNITCH=4,PhysicsBits.CAR=8,PhysicsBits.BUILDING=16;var MissionTypes={};MissionTypes.A_TO_B="A_TO_B",MissionTypes.RING="RING",MissionTypes.COMBAT="COMBAT",MissionTypes.CATCH="CATCH",MissionTypes.BOSS="BOSS";var PAUSE=!1;pc.script.attribute("disableFogOniPad2","boolean",!0),pc.script.attribute("batching","boolean",!0),pc.script.attribute("opening","boolean",!1),pc.script.attribute("clearStorage","boolean",!0),pc.script.attribute("cheat","boolean",!1),pc.script.attribute("levelId","enumeration",1,{enumerations:[{name:"GREENWICH",value:1},{name:"CHINATOWN",value:2},{name:"DOWNTOWNW",value:3}]}),pc.script.create("LevelController",function(a){var b=function(b){this.entity=b;var c=a.graphicsDevice;WIDTH=parseInt(c.canvas.clientWidth),HEIGHT=parseInt(c.canvas.clientHeight)};return b.prototype={initialize:function(){if(this.clearStorage&&Storage.clear(),this.cheat&&(Storage.addMutagen(100),Storage.addUpgradeMutagen(100)),window.nick_sdk_client){nick_sdk_client.GameEventEmitter.sendGameEvent(nick_sdk_client.GameEventEmitter.ON_LEVEL_START,"Greenwich");var b=this;nick_sdk_client.GameEventListener.onAudioToggle=function(b){b?a._audioManager.volume=1:a._audioManager.volume=0},nick_sdk_client.GameEventListener.onPlaybackToggle=function(a){a?b._onResumeGame():b._onPauseGame()}}var c=a.root.findByName("Camera"),d=/iPad|iPhone|iPod/.test(navigator.platform);if(d){var e=window.screen.width*window.devicePixelRatio,f=window.screen.height*window.devicePixelRatio;(1024==e&&768==f||768==e&&1024==f)&&(this.opening=!1,c.camera.farClip=300,this.disableFogOniPad2&&(a.scene.fog=pc.FOG_NONE))}this.batching&&(a.graphicsDevice.enableAutoInstancing=!0),PAUSE=!1,this.ground=a.root.findByName("Ground"),this.currentZone=0,this.currentBound=this.boundZone0,this.upgradeNotificationEntity=a.root.findByName("UpgradeNotification"),this.pauseButton=a.root.findByName("PauseButton"),this.pauseButton.script.Button.on("onPointerUp",this._onPauseGame,this),this.levelUpButton=a.root.findByName("LevelUpButton"),this.levelUpButton.script.Button.on("onPointerUp",this._onLevelUp,this),this.levelUpButtonScript=this.levelUpButton.script.Button,this.pulseTimer=0,this.scaleUp=!0,this.isPulsing=!1,this.exclamationPointEntity=this.pauseButton.findByName("ExclamationPoint"),this.pauseScene=a.root.findByName("PauseScene"),this.pauseSceneScript=this.pauseScene.script.PauseScene,this.pauseScene.script.PauseScene.on("resume",this._onResumeGame,this),this.pauseScene.script.PauseScene.on("showLoadingScreen",this._onShwoingLoadingScreen,this),this.endScene=this.entity.findByName("EndScene"),this.playerScript=a.root.findByName("Player").script.PlayerController,this.blocks=a.root.findByName("Buildings"),this.popupMessage=a.root.findByName("PopupMessage").script.PopupMessage,this.physcisEngine=a.root.findByName("Master").script.PhysicsEngineScript,this.player=a.root.findByName("Player"),this.flyingAroundTimer=0,this.inMission=!1,this.lastFloor=0,this.hasShowedNotification=Storage.hasShowedUpgradeNotification(),this.opening&&!Storage.getLevelComplete()?(this.openingCameraEntity=a.root.findByName("OpeningCamera"),this.openingCameraScript=this.openingCameraEntity.script.OpeningCamera,this.openingCameraScript.on("openingFinished",this._onOpeningFinish,this)):c.enabled=!0,a.touch||a.keyboard.on(pc.EVENT_KEYDOWN,this._onKeyDown,this),this.startupEvent()},postInitialize:function(){this.fire("playAudio","Music","flying"),setTimeout(this.openingEvent.bind(this),1e3)},update:function(a){if(TWEEN.update(),"pause"!==this.current){if(this.isPulsing){this.pulseTimer+=a,this.pulseTimer>.5&&(this.pulseTimer=0,this.scaleUp=!this.scaleUp);var b=this.scaleUp?this.pulseTimer/.5:1-this.pulseTimer/.5;this._pulseMutagenButton(this.scaleUp,b)}if("play"===this.current&&!this.inMission){this.flyingAroundTimer+=a;var c=Math.floor(this.flyingAroundTimer);if(0===c||this.lastFloor===c)return;this.lastFloor=c,c%480===0?(this.fire("playAudio","VO","fly8Mins"),this.flyingAroundTimer=0):c%180===0?this.fire("playAudio","VO","fly3Mins"):c%60===0&&this.fire("playAudio","VO","fly60Secs")}}},destroy:function(){pc.Utils.debug("LevelController","onDisable","Remove input listeners"),this.pauseSceneScript.off("onPointerUp",this._onPauseGame,this),this.pauseSceneScript.off("resume",this._onResumeGame,this),this.pauseSceneScript.off("showLoadingScreen",this._onShwoingLoadingScreen,this),this.openingCameraScript&&this.openingCameraScript.off("openingFinished",this._onOpeningFinish,this),a.touch||a.keyboard.off(pc.EVENT_KEYDOWN,this._onKeyDown,this)},_onKeyDown:function(a){a.key===pc.KEY_ESCAPE&&("play"===this.current?this._onPauseGame():"pause"===this.current&&this.pauseSceneScript.container.enabled&&this._onResumeGame())},_onPauseGame:function(){this.can("pauseEvent")&&this.pauseEvent()},_onResumeGame:function(){this.can("resumeEvent")&&this.resumeEvent()},_onLevelUp:function(){this.can("pauseEvent")&&(this.noPauseScreen=!0,this.pauseEvent())},_onShwoingLoadingScreen:function(){pc.Utils.debug("LevelController","disableLevel",""),this.playerScript.entity.enabled=!1,this.pauseButton.enabled=!1,this.blocks.enabled=!1},_onUnlockNewLevel:function(a){},_onOpeningFinish:function(){this.playEvent()},_pulseMutagenButton:function(a,b){var c=pc.math.lerp(1,1.3,b);this.levelUpButtonScript.setScale(c)},showNotification:function(){this.hasShowedNotification||(this.upgradeNotificationEntity.enabled=!0,this.hasShowedNotification=!0,Storage.setShowedUpgradeNotification(!0)),this.exclamationPointEntity.enabled=!0,this.isPulsing=!0,this.pulseTimer=0},onpause:function(a,b,c){this.fire("playAudio","SFX","pause","countdown"),this.exclamationPointEntity.enabled&&(this.exclamationPointEntity.enabled=!1,this.pauseSceneScript.showUpgradeExclamation=!0),this.upgradeNotificationEntity.enabled&&(this.upgradeNotificationEntity.enabled=!1,this.pauseSceneScript.showUpgradeTutorial=!0),this.isPulsing=!1,this._pulseMutagenButton(!0,0),this.pauseButton.enabled=!1,this.levelUpButton.enabled=!1,this.physcisEngine.enableEngine=!1,this.player.script.InputController.disableInput(),PAUSE=!0,this.fire("pause",!0),window.nick_sdk_client&&nick_sdk_client.GameEventEmitter.sendGameEvent(nick_sdk_client.GameEventEmitter.ON_PAUSE),this.noPauseScreen?(this.pauseSceneScript.noPauseScreen=!0,this.pauseSceneScript._onPointerUp("UpgradeButton"),this.noPauseScreen=!1):this.pauseSceneScript.container.enabled=!0},onplay:function(a,b,c){"pause"===b&&this.fire("playAudio","SFX","resume","countdown"),this.pauseSceneScript.container.enabled=!1,this.pauseButton.enabled=!0,this.levelUpButton.enabled=!0,this.physcisEngine.enableEngine=!0,this.player.script.InputController.enableInput(),this.player.script.PlayerController.can("jumpEvent")&&this.player.script.PlayerController.jumpEvent(),PAUSE=!1,this.fire("pause",!1),window.nick_sdk_client&&nick_sdk_client.GameEventEmitter.sendGameEvent(nick_sdk_client.GameEventEmitter.ON_RESUME)},onupgrade:function(a,b,c){this.pauseButton.enabled=!1,this.physcisEngine.enableEngine=!1,this.player.script.InputController.disableInput(),PAUSE=!0},onopening:function(a,b,c){!this.opening||Storage.getLevelComplete()?this.playEvent():(this.openingCameraEntity.enabled=!0,this.openingCameraScript.startOpening())},onmission:function(){this.flyingAroundTimer=0,this.missionWindowEntity.enabled=!0,this.timerWindowEntity.enabled=!0}},StateMachine.create({target:b.prototype,events:[{name:"startupEvent",from:["none"],to:"start"},{name:"openingEvent",from:["start"],to:"opening"},{name:"playEvent",from:["opening"],to:"play"},{name:"pauseEvent",from:["play"],to:"pause"},{name:"resumeEvent",from:["pause","upgrade"],to:"play"},{name:"upgradeEvent",from:["play"],to:"upgrade"}]}),b});