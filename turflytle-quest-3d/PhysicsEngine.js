nick={},nick.Physics={},function(a){a.Pool=function(a,b){this._allocator=a,this._freeObjects=[],this._capacity=b},a.Pool.prototype={take:function(){if(this._freeObjects.length>0)return this._freeObjects.pop();var a=this._allocator();return a?a:void 0},put:function(a){a&&this._freeObjects.length<this._capacity&&this._freeObjects.push(a)}},a.PhysicsEngine=function(){this.gravity=1,this.world=new a.World,this.deleteBodies=[]},a.Contact=function(){this.distance=0,this.normal=new pc.Vec3,this.offset=0,this.contactPoint=new pc.Vec3,this.penetration=0};var b=new a.Pool(function(){return new a.Contact}),c=function(a,b){var c=a+b,d=Math.abs(a-b),e=c.toString()+","+d.toString();return e},d=new MapShim,e=[];a.PhysicsEngine.prototype={initialize:function(b,c){this.world=new a.World,this.world.initialize(b,c),this.solver=new a.CollisionSolver},update:function(a){if(this._resetContactsPool(),0!==this.deleteBodies.length){for(var b=0;b<this.deleteBodies.length;b++)this.world.removeBody(this.deleteBodies[b]),this.deleteBodies[b].script.entity.destroy();this.deleteBodies=[]}if(0!==this.deleteBodies.length){for(var b=0;b<this.deleteBodies.length;b++){var c=this.deleteBodies[b];this.world.removeBody(c),c.clean&&c.script.entity&&c.script.entity.destroy()}this.deleteBodies=[]}this.world.update(a),this.world.collisionDetection(a,this.solver.callback),this.solver.resolveCollisions(a)},insertBody:function(a){this.world.insertBody(a)},removeBody:function(a,b){b=b||!0,a.clean=b,this.deleteBodies.push(a)},destroy:function(){this.world.destroy()},_resetContactsPool:function(){for(var a=d.keys(),c=0;c<a.length;c++){var e=a[c],f=d.get(e);b.put(f)}d.clear()}},a.Body=function(a,b){this.leaf=null,this.type=b,this.velocity=new pc.Vec3,this.position=new pc.Vec3,this.collision=null,this.friction=0,this.mass=0,this.lastPos=new pc.Vec3,this.lastVel=new pc.Vec3,this.name="",this.allCollisions=new MapShim,this.script=a,this.gravityScale=1,this.isTrigger=!1,this.activated=!0,this.minBox=new pc.Vec3,this.maxBox=new pc.Vec3,this.id=0,this.groupIndex=1,this.maskBit=65535,this.categoryBit=65535,this.needUpdate=!1,this.clean=!0,this.continuous=!1},a.Body.STATIC=0,a.Body.DYNAMIC=1,a.Body.KINEMATIC=2,a.Body.prototype={applyGravity:function(b){this.type===a.Body.DYNAMIC&&(this.velocity.y-=10*b*this.gravityScale*this.mass)},update:function(a){var b=this.position,c=this.velocity;this.lastPos.set(b.x,b.y,b.z),this.lastVel.set(c.x,c.y,c.z),b.x=b.x+c.x*a,b.y=b.y+c.y*a,b.z=b.z+c.z*a},revertPosition:function(){this.position.copy(this.lastPos)},getBounds:function(b){b=b||new a.Math.Rect;var c=this.collision,d=c.type,e=this.position;if("sphere"===d)b.xmin=e.x-c.radius,b.xmax=e.x+c.radius,b.ymin=e.z-c.radius,b.ymax=e.z+c.radius;else if("box"===d){var f=this._getMinBox(),g=this._getMaxBox();b.xmin=f.x,b.xmax=g.x,b.ymax=g.z,b.ymin=f.z}return b},detectCollision:function(a,b){var c=this.collision.type,d=a.collision.type;if("sphere"===c){if("sphere"===d)return this._sphereSphereIntersect(this,a,b);if("box"===d)return this._sphereBoxIntersect(this,a,b)}else if("box"===c){if("sphere"===d)return this._sphereBoxIntersect(a,this,b);if("box"===d)return this._boxBoxIntersect(this,a,b)}return console.warn("Only support box and sphere"),!1},onCollisionEnter:function(a){var b=d.get(c(this.id,a.id));this.script.fire("onCollisionEnter",a,b),a.script.fire("onCollisionEnter",this,b)},onCollisionStay:function(a){this.script.fire("onCollisionStay",a),a.script.fire("onCollisionStay",this)},onCollisionExit:function(a){this.script.fire("onCollisionExit",a),a.script.fire("onCollisionExit",this)},updatePosition:function(a){return this.position.copy(a),this.needUpdate=!0,this},_sphereSphereIntersect:function(a,b,c){if(a.continuous||b.continuous){var d=this._sphereSphereContinuous(a,b);return d}var e=b.position,f=b.collision.radius,g=a.position,h=a.collision.radius,i=new pc.Vec3;return i.sub2(e,g),i=i.length(),f+h>=i},_sphereSphereContinuous:function(a,b,c){var d,e=.001,f=new pc.Vec3;f.sub2(a.position,b.position);var g=new pc.Vec3;g.sub2(a.velocity,b.velocity);var h=a.collision.radius-b.collision.radius,i=f.dot(f)-h*h;if(pc.Utils.fp_less_than(i,0,e))return d=0,!0;var j=g.dot(g),k=g.dot(f);if(pc.Utils.fp_less_than(0,k))return!1;var l=k*k-j*i;return pc.Utils.fp_less_than(l,0)?!1:(d=(-k-Math.sqrt(l))/j,!0)},_sphereBoxIntersect:function(a,b,c){var d=(b._getMinBox(),b._getMaxBox(),a.position),e=a.collision.radius,f=new pc.Vec3;f.sub2(d,b.position);var g=new pc.Vec3;g=g.sub2(d,b.position);var h=Math.abs(g.x)-e,i=Math.abs(g.y)-e,j=Math.abs(g.z)-e,k=.001;if(pc.Utils.fp_greater_than(h,b.collision.halfExtents.x,k)||pc.Utils.fp_greater_than(i,b.collision.halfExtents.y,k)||pc.Utils.fp_greater_than(j,b.collision.halfExtents.z,k))return!1;this._generateContact(a,b,c);var l=new pc.Vec3;if(l.sub2(d,c.contactPoint),pc.Utils.fp_greater_than(l.length(),e,k))return!1;if(c.normal.normalize(),isNaN(c.normal.x)){a.position.clone();b.isTrigger||a.revertPosition(),this._generateContact(a,b,c)}var l=new pc.Vec3;l.sub2(d,c.contactPoint);var m=l.length();return c.penetration=e-m,!0},_generateContact:function(a,b,c){c.normal.set(0,0,0),c.offset=a.collision.radius,c.contactPoint.set(0,0,0);var d=a.position,e=b._getMinBox(),f=b._getMaxBox(),g=d.x;g=Math.max(g,e.x),g=Math.min(g,f.x),c.contactPoint.x=g,c.normal.x=d.x-g,g=d.y,g=Math.max(g,e.y),g=Math.min(g,f.y),c.contactPoint.y=g,c.normal.y=d.y-g,g=d.z,g=Math.max(g,e.z),g=Math.min(g,f.z),c.contactPoint.z=g,c.normal.z=d.z-g},_boxBoxIntersect:function(b,c,d){var e=b._getMinBox(),f=b._getMaxBox(),g=c._getMinBox(),h=c._getMaxBox(),i=(b.velocity.clone(),c.velocity.clone(),f.x>g.x&&e.x<h.x&&f.y>g.y&&e.y<h.y&&f.z>g.z&&e.z<h.z);return i&&b.type===a.Body.Static,f.x>g.x&&e.x<h.x&&f.y>g.y&&e.y<h.y&&f.z>g.z&&e.z<h.z},_getMinBox:function(){return this.minBox.sub2(this.position,this.collision.halfExtents),this.minBox},_getMaxBox:function(){return this.maxBox.add2(this.position,this.collision.halfExtents),this.maxBox}},a.Contact.prototype={toString:function(){return"Contact : distance="+this.distance+" , normal=("+this.normal.x.toFixed(2)+","+this.normal.y.toFixed(2)+","+this.normal.z+")"}},a.Math={},a.Math.Rect=function(a,b,c,d){this.xmin=a,this.ymin=b,this.xmax=c,this.ymax=d},a.Math.Rect.prototype={overlaps:function(a){return!(this.xmin>a.xmax||this.xmax<a.xmin||this.ymin>a.ymax||this.ymax<a.ymin)},overlapsNegativeSpace:function(a){return this.xmin>a.xmin||this.xmax<a.xmax||this.ymin>a.ymin||this.ymax<a.ymax}};var f=new a.Math.Rect;new pc.Vec3;a.Math.BoundingAAVolume=function(a,b,c,d,e,f){this.xmin=a,this.ymin=b,this.zmin=c,this.xmax=d,this.ymax=e,this.zmax=f},a.Math.BoundingAAVolume.prototype={overlaps:function(a){return!(this.xmax<a.xmin||this.xmin>a.xmax||this.ymax<a.ymin||this.ymin>a.ymax||this.zmax<a.zmin||this.zmin>a.zmax)}},a.CollisionSolver=function(){var a=this;this.callback=function(){a.collisionDetected.apply(this,arguments)}},a.CollisionSolver.prototype={collisionDetected:function(b,e,f,g){if(e.type===a.Body.DYNAMIC){var h=e;e=b,b=h}if(!e.isTrigger){var i=b.velocity;g.normal.x*i.x<0&&(i.x=0),g.normal.y*i.y<0&&(i.y=0),g.normal.z*i.z<0&&(i.z=0);var j=g.contactPoint.clone().add(g.normal.clone().scale(g.offset));b.position.copy(j)}d.set(c(b.id,e.id),g);var k=b.allCollisions;k.has(e)?k.set(e,1):k.set(e,0)},resolveCollisions:function(a){for(var b=0;b<e.length;b++){e[b]}e=[]}};var g={};a.World=function(){this.numcells=10,this.nodes=[],this.leafs=[],this.bounds=null,this.negativeSpaceNode=null,this.updateFlag=!1,this.globalId=1,this.movingBodies=[]},a.World.prototype={initialize:function(b,c){this.numcells=c,this.bounds=b;for(var d=b.xmin,e=b.ymin,f=(b.xmax-b.xmin)/this.numcells,g=(b.ymax-b.ymin)/this.numcells,h=0;h<this.numcells;h++)for(var i=0;i<this.numcells;i++){var j=new a.Math.Rect(d+f*h,e+g*i,d+f*(h+1),e+g*(i+1)),k=new a.World.Node(i,h,j,this);this.nodes.push(k)}this.negativeSpaceNode=new a.World.Node(-1,-1,null,this),this.nodes.push(this.negativeSpaceNode)},update:function(a){var b,c;if(this.updateFlag=!this.updateFlag,0!=this.movingBodies.length)for(var d=0;d<this.movingBodies.length;d++)for(var b=0;b<this.movingBodies[d].leaf.parents.length;b++)this.movingBodies[d].leaf.parents[b].update(a);else for(b=0;b<this.nodes.length;b++)c=this.nodes[b],c.update(a)},collisionDetection:function(a,b){if(0!=this.movingBodies.length)for(var c=0;c<this.movingBodies.length;c++)for(var d=0;d<this.movingBodies[c].leaf.parents.length;d++)this.movingBodies[c].leaf.parents[d].collisionDetection(a,b);else for(var d=0;d<this.nodes.length;d++){var e=this.nodes[d];e.collisionDetection(a,b)}g={}},insertBody:function(a){var b=(a.position,this.createLeaf(a));a.id=this.globalId++,this.updateLeaf(b,null),1!==a.type&&2!==a.type||(a.leaf=b,this.movingBodies.push(a))},removeBody:function(a){if(a._leafidx){var b=this.movingBodies.indexOf(a);-1!==b&&this.movingBodies.splice(b,1);for(var c=this.leafs[a._leafidx];c.parents.length>0;)c.parents[0].removeLeaf(c);delete a._leafidx}},createLeaf:function(b){var c=new a.World.Leaf(b);return c.idx=this.leafs.length,this.leafs.push(c),b._leafidx=c.idx,c},updateLeaf:function(a,b){var c=a.body.getBounds(f),d=!1;this._iterateOverCells(c,function(c){var e=a.isLeafOf(c);c===b&&(d=!0),e||c.addLeaf(a)}),!d&&b&&b.removeLeaf(a)},destroy:function(){this.nodes=[],this.leafs=[]},_convertXToIdx:function(a){var b=a-this.bounds.xmin;return b=b/(this.bounds.xmax-this.bounds.xmin)*this.numcells},_convertYToIdx:function(a){var b=a-this.bounds.ymin;return b=b/(this.bounds.ymax-this.bounds.ymin)*this.numcells},_nodeAt:function(a,b){return 0>a||a>=this.numcells||0>b||b>=this.numcells?null:this.nodes[b*this.numcells+a]},_iterateOverCells:function(a,b){for(var c=this.bounds.overlapsNegativeSpace(a),d=Math.max(0,Math.floor(this._convertXToIdx(a.xmin))),e=Math.max(0,Math.floor(this._convertYToIdx(a.ymin))),f=Math.min(this.numcells-1,Math.floor(this._convertXToIdx(a.xmax))),g=Math.min(this.numcells-1,Math.floor(this._convertYToIdx(a.ymax))),h=d;f>=h;h++)for(var i=e;g>=i;i++){var j=this._nodeAt(i,h);b(j)}c&&b(this.negativeSpaceNode)}},a.World.Node=function(a,b,c,d){this.row=a,this.col=b,this.bounds=c,this.leafs=[],this.world=d};var h=(new a.Contact,0),i=0;a.World.Node.prototype={update:function(b){for(var c=0;c<this.leafs.length;c++){var d=this.leafs[c];if(d.updateFlag!=this.world.updateFlag){d.updateFlag=this.world.updateFlag;var e=d.body;if(e.type===a.Body.STATIC&&!e.needUpdate||!e.activated)continue;e.needUpdate=!1,e.applyGravity(b),e.update(b),this.world.updateLeaf(d,this)}}},collisionDetection:function(c,d){h=0,i=0;for(var e=0;e<this.leafs.length;e++){var f=this.leafs[e];if(f.body.activated)for(var g=f.body.type,j=e+1;j<this.leafs.length;j++){var k=this.leafs[j];if(k.body.activated&&!this._alreadyChecked(f.body,k.body)&&k.body.collision&&!(f.body.groupIndex===k.body.groupIndex&&f.body.groupIndex<0)){var l=b.take();f.body.maskBit&k.body.categoryBit&&f.body.categoryBit&k.body.maskBit&&(g===a.Body.DYNAMIC||k.body.type===a.Body.DYNAMIC)&&f.body.detectCollision(k.body,l)?(h+=1,d(f.body,k.body,c,l)):b.put(l)}}}},addLeaf:function(a){this.leafs.push(a),a.parents.push(this)},removeLeaf:function(a){var b;for(b=0;b<this.leafs.length;b++)if(this.leafs[b]===a){this.leafs.splice(b,1);break}if(a.parents[a.cache]===this)a.parents.splice(a.cache,1);else for(b=0;b<a.parents.length;b++)if(a.parents[b]===this){a.parents.splice(b,1);break}},_alreadyChecked:function(a,b){var c=a.id+":"+b.id,d=b.id+":"+a.id,e=g[c]||g[d];return e||(g[c]=g[d]=!0),i+=1,e}},a.World.Leaf=function(a){this.parents=[],this.body=a,this.cache=0,this.updateFlag=!1},a.World.Leaf.prototype={isLeafOf:function(a){for(var b=0;b<this.parents.length;b++)if(this.parents[b]===a)return this.cache=b,!0;return!1}}}(nick.Physics);